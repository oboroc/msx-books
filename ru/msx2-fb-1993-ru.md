
# АРХИТЕКТУРА И УСТРОЙСТВА МИКРОКОМПЬЮТЕРОВ СТАНДАРТА MSX-2

## К.И.Фахрутдинов, И.И.Бочаров

МИКРОКОМПЬЮТЕР Yamaha MSX-2

В трех книгах

Книга 1

Редактор И.А. Пяткова

Художественный редактор О.П. Крайнов

Технический редактор И.В. Шпинь

Корректор Л.П. Конарева

Владивосток: Издательство Дальневосточного университета, 1993.- 146 с.


## АННОТАЦИЯ

В учебном пособии рассмотрены общие структурные
свойства и особенности архитектуры микрокомпьютера
стандарта MSX-2, описаны микропроцессор Z80,
видеопроцессор, программируемый звукогенератор,
организация различных типов памяти и видеопамяти, форматы
памяти на магнитных дисках и лентах, энергонезависимая
память и другие устройства системы.

В приложениях приводится информация, необходимая при
работе на компьютере, и в особенности - для
программирующих на языке ассемблера Z80 или INTEL8080 в
системе MSX-2.

Книга будет полезна всем, кто работает, преподает или
учится на компьютерах YAMAHA MSX-1, MSX-2 и их аналогах.


## ВВЕДЕНИЕ

Прошло уже более пяти лет с  тех пор, как различная
вычислительная техника стала широко внедряться в средние учебные
заведения. Приморский край занял одно из ведущих мест в стране по
компьютеризации школы. Накоплен большой опыт и различные материалы
по обучению информатике и другим предметам и по разработке
программного обеспечения для школьных компьютеров.

Классы компьютеров YAMAHA MSX-1 и MSX-2 достаточно
распространены в стране и крае, однако хорошей и полной
технической документации по этой системе очень мало. Это
сдерживает разработку программного обеспечения.

В предлагаемом Вашему вниманию учебном пособии собраны и
систематизированы многие полезные сведения об архитектуре MSX-2.
Большинство источников информации о системе труднодоступны для
пользователей, часть источников, к сожалению - неизвестного
авторам происхождения.

В приложениях приводится информация, необходимая для
программирующих на языке ассемблера Z80 или INTEL8080 - описание
рабочих областей BDOS и BIOS, портов ввода/вывода, подпрограмм
BIOS, BDOS и интерпретатора языка MSX-BASIC, сетевых функций и
регистров видеопроцессора.

Во второй нашей книге описан язык ассемблера Z80. На большом
количестве примеров показано, как можно, программируя на языке
ассемблера, управлять работой всех устройств компьютера,
рассмотренных в той книге, что сейчас перед Вами.

Материалы книг использовались при обучении школьников по
специальности "Программирование", переподготовке учителей
информатики, в спецкурсах по архитектуре микрокомпьютеров на
математическом факультете Дальневосточного университета.

Авторы благодарны Д.В.Симончику, который внимательно изучил
рукопись и сделал ряд ценных замечаний и поправок.


### 1. Общие сведения об архитектуре MSX-2

Система MSX является стандартом восьмиразрядного (школьного)
компьютера. Она появилась осенью 1983 г., а к декабрю 1985 г. было
продано более миллиона компьютеров MSX.

Система MSX-2 была объявлена в мае 1985 г. Она имеет полную
совместимость снизу вверх с MSX (MSX-1).

В СССР были поставлены классы учебной вычислительной техники
КУВТ (MSX) и КУВТ-2 (MSX-2), объединенные в локальные
вычислительные сети, которые комплектовались, в частности,
компьютерами учителя "YAMAHA yis805/128" и компьютерами учеников
"YAMAHA yis503/III" для КУВТ-2 и компьютерами "YAMAHA  yis503/II"
для КУВТ.

   Основные устройства системы MSX:

- Микропроцессор (CPU) Z-80A;
- Видеопроцессор (VDP) V9938 MSX VIDEO (совместимый с TMS-9918A
в MSX-1);
- Микросхемы периферийного программируемого параллельного
интерфейса (PPI) Intel 8255 и последовательного интерфейса RS 232C;
- Программируемый генератор звуков (PSG) AY-2-8910;
- Память:

|                                         | MSX | MSX-2|
|-----------------------------------------|----:|-----:|
| MSX BASIC, BIOS (ROM)                   | 32K |  48K |
| Оперативная (RAM)                       | 64K | 128K |
| Видео (VRAM)                            | 16K | 128K |
| Видео для регистров ввода/вывода (ERAM) |  -  |  64K |
| Сетевая (NROM)                          | 16K |  32К |
| Сетевая (NRAM)                          |  -  |   2K |

- Порты ввода/вывода;
- Шины данных, адреса, управления;
- Клавиатура;
- Печатающее устройство (принтер) "GEMINI-10XR/15XR" или
"NL-10", либо любой другой MSX-принтер;
- Дисководы для флоппи-дисков MF-2DD (MF-1DD);
- Мышь;
- Джойстик;
- Плоттер;
- Магнитофон.

Кроме этого, стандартные устройства MSX включают в себя
драйверы лазерных дисков, VTR, контроллеры синтезаторов,
видеосистемы, контроллеры роботов, температуры, различные адаптеры
для модемов и телефонных линий.

Функциональную схему системы можно представить следующим
образом:

      Память Процессор  Порты Устройства            Устройства
                ┌─────────────────┬──────┐
                │                 │      │
                │         ┌─┐ ┌───┴────┐ │        ┌────────────┐
                │      ┌──┤ ├─┤ Маппер │ │        │ Клавиатура │
                │      │  └─┘ └────────┘ │        │ Магнитофон │
                │      │  ┌─┐  Периферийный       │ Индикаторы │
                │      ├──┤ ├─ интерфейс (PPI) ───┤ Динамик    │
     ┌─────┐    │      │  └─┘                     │ Мышь       │
     │ RAM ├─┐  │      │  ┌─┐                     │ Джойстик   │
     └─────┘ ├──┘      ├──┤ ├─  ...  ...          │ Часы       │
     ┌─────┐ │ ┌─────┐ │  └─┘                     └────────────┘
     │ ROM ├─┤ │     │ │  ┌─┐ ┌─────────┐
     └─────┘ │ │ CPU │ ├──┤ ├─┤ Принтер │         ┌────────────┐
             ├─┤ Z80 ├─┤  └─┘ └─────────┘         │  Таймер    │
    ┌──────┐ │ │     │ │  ┌─┐                     ├────────────┤
    │ NRAM ├─┤ │     │ ├──┤ ├─ RS232C ────────────┤ Компьютеры │
    └──────┘ │ └─────┘ │  └─┘                     └────────────┘
    ┌──────┐ ├──┐      │  ┌─┐ ┌──────────────┐    ┌──────┐
    │ NROM ├─┘  │      ├──┤ ├─┤Видеопроцессор├──┬─┤ VRAM │
    └──────┘    │      │  └─┘ └──────────────┘  │ └──────┘
                │      │  ┌─┐                   │ ┌──────┐
                │      ├──┤ ├─  ...  ...        ├─┤ ERAM │
                │      │  └─┘                   │ └──────┘
                │      │                        │ ┌───────┐
                │      │                        └─┤Дисплей│
                │      │                          └───────┘
                │      │  ┌─┐ ┌───────────────┐      ┌─────────┐
                │      └──┤ ├─┤ Звукогенератор├──────┤ Динамик │
                │         └─┘ └───────────────┘      └─────────┘
                │    ┌──────────┐                     ┌──────────┐
                └────┤ Драйверы ├─────────────────────┤ Дисковод │
                     └──────────┘                     └──────────┘

Основное устройство системы - микропроцессор Z-80. Он выполняет
все арифметические, логические и управляющие операции. Подробнее
его характеристики будут рассмотрены ниже. При работе процессор
обменивается данными с памятью или с устройствами ввода/вывода.

Видеопроцессор управляет выводом на экран текстовой и
графической информации.

Системные шины представляют собой набор соединительных
проводников-линий, объединяющих одноименные выводы всех
периферийных модулей. По каждой линии может быть передано значение
одного разряда двоичного кода. По роду передаваемой информации все
линии разделены на три группы, образующие шину данных, шину
адресов и шину управления.

Характерной особенностью шины данных является ее
двунаправленность (т.е. возможность передачи данных в разные
моменты времени в различных направлениях).

Периферийными устройствами ЭВМ являются различные запоминающие
устройства и регистры для подключения внешних устройств (например,
клавиатуры,   видеопроцессора   и   т.д.),   называемые    портами
ввода/вывода.  Поскольку  микропроцессор   Z-80   предназначен   в
основном  для  обработки   8-разрядных   двоичных   чисел,   порты
ввода/вывода тоже 8-разрядные.

Микропроцессор Z-80 позволяет подключить к шинам адресов до 256
портов ввода/вывода.

Запоминающее устройство ЭВМ состоит из набора 8-разрядных ячеек
памяти. Обмен данных между процессорными и периферийными  модулями
ЭВМ происходит по шине данных, также состоящей из 8 линий.

Каждая ячейка памяти и  каждый  порт  ввода/вывода  имеют  свои
индивидуальные  номера  -  адреса.  Число  линий   адресной   шины
определяется разрядностью адресной  шины  микропроцессора  Z-80  и
равно 16. Это позволяет обращаться к 2 в 16 степени (64К)  ячейкам
памяти. Число К=1024  байт  является  одной  из  единиц  измерения
объема памяти.


### 2. Микропроцессор Z-80

Ядром   компьютеров   стандартов   MSX   и    MSX-2    является
микропроцессор Z80 (Z80А), который был  разработан  фирмой  Zilog.
Эта фирма была создана специалистами, принимавшими ранее участие в
разработках   микропроцессоров   фирмы   Intel.   В   Японии   эта
микропроцессорная серия выпускается фирмой Sharp.

Микропроцессор  Z80  представляет  собой  большую  интегральную
схему (БИС)  с  8500  транзисторами  на  кристаллической  пластине
площадью   4.6× 4.9  мм¤.   Его   архитектура    основывается   на
архитектурных принципах  микропроцесора  INTEL  8080  и  позволяет
выполнять  все  78  команд  этого  микропроцессора,  а  также   80
дополнительных команд (696 кодов операций в отличие от  244  кодов
INTEL8080). Основные особенности архитектуры Z80 приводятся в [5].

Микропроцессор  Z80  имеет  восьмиразрядную   шину   данных   и
шестнадцатиразрядную шину адреса. Тактовая частота примерно 3.5795
MHz. Микропроцессор имеет 17 внутренних регистров. Предусмотрены 3
способа реакции на прерывания.  Имеется  второй  набор  из  восьми
8-разрядных  регистров,  которые  соответствуют  восьми  регистрам
микропроцессора INTEL 8080.

Основные технические характеристики микропроцессора Z80:

| Характеристики Z80                          |       |
|:--------------------------------------------|------:|
| Число выводов корпуса                       | 40,48 |
| Напряжение питания, V                       |    +5 |
| Максимальная потребляемая мощность, Wt      |   1.1 |
| Основная тактовая частота, МHz              |   3.5 |
| Непосредственно адресуемое пространство, Kb |    64 |
| Время выполнения безадресной команды, mcs   |   1.6 |
| Число основных команд                       |   158 |
| Число регистров общего назначения           |    16 |
| Число уровней прерывания                    |     2 |

Хотя Z80  является  восьмиразрядным  процессором,  его  система
команд   содержит   несколько   операций   и    для    работы    с
шестнадцатиразрядными данными.


#### 2.1. Основные блоки

Основной   блок  микропроцессора  Z80  -  арифметико-логическое
устройство (АЛУ, CPU) с регистром-аккумулятором A.

В микропроцессоре Z80 повторены  все  регистры  микропроцессора
INTEL 8080 и дополнительно к его 8-разрядным регистрам A,B,C,D,E,H
и L имеются также A',B',C',D',E',H' и L' и еще несколько регистров
специального назначения. Эти дополнительные регистры включают  два
16-разрядных  индексных  регистра  (IX,IY),  8-разрядный   регистр
вектора прерываний (I) и 7-разрядный  регистр  регенерации  памяти
(R). Кроме того, имеется один 16-разрядный PC (счетчик  команд)  и
один 16-разрядный SP (указатель стека).

Микропроцессор  Z80 имеет два идентичных  8-разрядных  флаговых
регистра F и F', в которых предусмотрены четыре проверяемых и  два
непроверяемых  флага.  Четыре  проверяемых  флага  -  это  признак
переноса, признак нуля, признак  отрицательного  числа  и  признак
четности/переполнения.

Два непроверяемых бита - это признак  полупереноса  (аналогичен
дополнительному признаку переноса в микропроцессоре INTEL 8085)  и
признак   вычитания.   Последний   используется   для    коррекции
результатов  операций  с  двоично-десятичными   числами,   помогая
определить  вид  предыдущей  операции,  поскольку   для   операций
сложения и вычитания коррекция различна.

Имеется дешифратор команд с регистром команд для хранения  кода
операции, устройство управления и сигнализации,  схема  десятичной
коррекции.


#### 2.2. Состав, обозначение и назначение регистров

Как  уже  говорилось,  в  микропроцессоре  Z80   повторены  все
регистры  микропроцессора  INTEL  8080  и  дополнительно   к   его
8-разрядным регистрам  A,B,C,D,E,H  и  L  имеются  также  регистры
A',B',C',D',E',H' и L'  и  еще  несколько  регистров  специального
назначения.

`А` - аккумулятор, используется для хранения операнда,
с которым работает арифметико-логическое устройство
микропроцессора. Результат работы АЛУ по окончанию
обработки данных обычно вновь помещают в регистр A;

`F` - регистр признаков (флагов);

`B`,`C`,`D`,`E`,`H`,`L` - регистры общего назначения;

`АF`,`BC`,`DE`,`HL` - регистровые пары, образуются регистрами
общего назначения;

`AF'`,`BC'`,`DE'`,`HL'` - дополнительные регистровые пары;

`IX`,`IY` - индексные регистры;

`SP` - регистр-указатель стека;

`PC` - регистр-счетчик команд;

`I` - регистр вектора прерываний, используется в режиме
прерываний IM 2;

`R` - семибитный счетчик адреса динамического ОЗУ для
регенерации.

Регистр I предназначен для хранения старшего байта адреса
программы обработки прерываний в режиме обработки прерываний IM 2.
Младший же байт адреса программы обработки прерываний передается
по шине данных от устройства, вызвавшего прерывание.

Регистр R предназначен для хранения  адреса  динамического  ОЗУ
для регенерации. Регенерация  памяти  -  восстановление  памяти  с
периодичностью, заданной в технических условиях на микросхемы ОЗУ.
Регенерация необходима в  случае  использования  в  вычислительных
устройствах  динамической  памяти,  в  структуру  которых   входят
напыленные   по    МОП-технологии    (Металл-Окисел-Полупроводник)
конденсаторы. Потеря зарядов  конденсаторов  происходит  из-за  их
утечки, а также в результате обращения к памяти при считывании  из
нее информации.

В   микропроцессоре   Z80   используется   способ   циклической
регенерации   памяти.   Во   время   цикла   выполнения    команды
микропроцессором   существуют   определенные   интервалы,    когда
системная  адресная  шина  свободна.   Эти   временные   интервалы
используются микропроцессором Z80 для  доступа  к  адресным  шинам
динамической памяти  ОЗУ.  В  качестве  адресов  в  данном  случае
используются  7  младших  разрядов  адресного   поля   процессора,
сопровождаемые специальным сигналом, сообщающим, что данный  адрес
является адресом регенерации памяти. Регистр  R  хранит  очередной
адрес регенерируемой строки памяти.


#### 2.3. Регистр признаков

При выполнении микропроцессором  некоторых  команд  в  регистре
признаков F в зависимости от  результата  операции  вырабатываются
признаки (флаги) состояния. Кроме этого, часть команд не  изменяют
некоторые признаки, установленные предыдущими командами, а часть -
дают неопределенные значения признаков. В каждом конкретном случае
обращайтесь к описанию команд.

Биты 3 и 5 регистра F получают значения 0 или 1  в  зависимости
от  выполняемых  операций   и  при  программировании   обычно   не
используются.

    ┌──────┬────┬────┬────┬────┬────┬────┬────┬────┐
    │ Бит  │  7 │  6 │  5 │  4 │  3 │  2 │  1 │  0 │
    ├──────┼────┼────┼────┼────┼────┼────┼────┼────┤
    │ Флаг │  S │  Z │  * │  H │  * │  V │  N │  C │
    └──────┴────┴────┴────┴────┴────┤  P ├────┴────┘
                                    └────┘

Один и тот же бит (P/V) используется различными операциями либо
для   установки/сброса   флага   переполнения   (V),   либо    для
установки/сброса флага четности (P).

Биты признаков результата (флаги) имеют следующие обозначения и
смысл:

`S` - (Sign) знак результата (1 - минус, 0 - плюс).  При  выполнении
арифметических команд каждый двоичный  операнд  представляется
как 7-разрядное число со знаком, записанным в старшем разряде.
Единица в восьмом разряде соответствует отрицательному числу в
дополнительном коде;

`Z` - (Zero) устанавливается в 1, если результат равен 0. В командах
сравнения и поиска устанавливается,  когда  результат   поиска
положительный, в командах работы с  битами  загружается допол-
нительным значением проверяемого бита;

`H` - (Half-Carry) равен 1, если  был  перенос  из  3  разряда  в  4
(перенос полуслова),  иначе  сбрасывается  в  0;  обычно  этот
признак используется при сложении  чисел  в двоично-десятичной
форме;

`V` - (Overflow)  устанавливается    равным   1,    если   результат
арифметической операции не вмещается  в  регистр  (т.е.  число
больше 127 или меньше -128);

`P` - (Parity) становится равным 1, если количество  битов-единиц  в
байте-результате  логической  операции   или   сдвигов   четно
(например, 01010011), иначе - 0;

`N` - (Negative)  устанавливается  в  1  после  выполнения  операций
вычитания и  сравнения  и  сбрасывается  в  0  после  операций
сложения, логических операций и сдвигов;

`C` - (Carry)  флаг   устанавливается,  если   в  результате  команд
вычитания или сравнения происходит заем бита, очищается  после
логических  команд,  и  получает   значение   выдвинутого   за
разрядную сетку бита в командах циклического сдвига.


#### 2.4. Система и форматы команд

Каждый  микропроцессор  характеризуется  определенной  системой
команд.  Система  команд  -  это  полный   перечень   элементарных
действий,  которые  способен  производить  процессор.  Управляемый
этими командами процессор выполняет очень простые действия, такие,
как элементарные арифметические и  логические  операции,  операции
пересылки данных, сравнения двух величин и  др.  Однако,  составив
программу    из    последовательности    таких    команд,    можно
запрограммировать выполнение достаточно сложного алгоритма.

Команды и данные представляются  в  памяти  компьютера  в  виде
двоичных чисел. Часто, анализируя участок памяти, нельзя  отличить
данные от команд. Лишь  очень  немногие  из  возможных  комбинаций
битов в байте или байтов не могут быть восприняты как команда.

Команда, как правило, состоит из двух частей: кода  операции  и
адреса или данных. Как уже было сказано, команда минимальной длины
занимает один байт. Часть байта отводится на код операции,  другая
часть   адресует   операнды.   Ими   могут   быть   один   разряд,
восьмиразрядный регистр или  регистровая  пара.  Адреса  регистров
могут быть явно заданы в команде или  неявно  определены  по  коду
операции.

Можно рассмотреть структуру  однобайтовой  команды  на  примере
команды  ADD.  Двоичный  код  команды  имеет  вид  10000XXX,   где
XXX-адрес 8-разрядного регистра в двоичном коде. Команда  ADD  A,C
имеет двоичный код 10000001, т.к. "адрес"  регистра  C  -  001,  а
команда ADD A,(HL) имеет код 1000110, поскольку косвенный  операнд
(HL) задается кодом 110.

Команды, имеющие длину 2 байта - это команды с  непосредственно
заданными  операндами.  В  их  коде  вторым  байтом  всегда  будут
восьмиразрядные данные, которые участвуют  в  операции.  Например,
команда ADD A,34h представляется в памяти в шестнадцатеричном виде
как C6 34.

Трехбайтные команды - это либо команды безусловной или условной
передачи управления, такие как JP или CALL,  в  которых  второй  и
третий байты интерпретируются как 16-разрядный адрес, либо команда
LD,  которая  загружает  непосредственные  16-разрядные  данные  в
регистровую пару или указатель стека.

Самые  большие  по  длине  (4   байта)   -   это   команды   из
дополнительного набора.  Они  в  основном  работают  с  индексными
регистрами IX и IY, а также несколько расширяют возможности работы
с основными регистрами процессора.

Естественно, что запомнить 696 кодов операций, представленных в
виде двоичных 8-разрядных  чисел,  т.е.  в  виде  набора  нулей  и
единиц,  практически  невозможно.  Поэтому  каждому  коду  команды
ставится  в  соответствие   мнемоническое   название   (мнемоника)
команды,  которая  является  сокращением   от   английских   слов,
описывающих ее действие. Мнемонический код команд позволяет  легче
запомнить их функции и значительно упрощает написание программ.

Операнды в свою очередь удобнее записывать не в двоичной,  а  в
шестнадцатиречной системе счисления. Операнд может быть задан явно
в виде конкретного числа или неявно, т.е. ему может быть присвоено
символическое имя, а конкретное  значение,  соответствующее  этому
имени, определяется в дальнейшем при переводе текста  программы  в
машинные коды.

Когда  операнд  задается   непосредственно,   то   после   него
проставляется буква B, D или H, если число  записано  в  двоичной,
десятичной или шестнадцатеричной системе счисления  соответственно
(причем если явно система счисления не задана, то  считается,  что
число задано в десятичной системе).

Если мы при составлении программы задаем операнды неявно, то  в
начале или в конце текста программы определяем, чему эти  операнды
равны на самом деле. Для этого используется  директива  ассемблера
EQU.


#### 2.5. Способы адресации

Для   правильного   программирования   важно   знать   принципы
адресации, которые заложены в  архитектуру  микропроцессоре,  т.е.
знать, как происходит формирование кода на шине адреса.

При обращении к памяти для чтения  кода  очередной  команды  из
микропроцессора на шину данных поступает содержимое  16-разрядного
регистра PC, называемого  счетчиком  команд.  В  этом  регистре  к
моменту    окончания    выполнения    текущей    команды    всегда
подготавливается адрес очередной команды программы.

Во  время  выполнения  программы  микропроцессор  обращается  к
заданным ячейкам памяти для чтения и записи промежуточных  данных.
В системе команд имеются команды, с помощью которых  можно  задать
адрес   обращения   к   памяти    непосредственно    (команды    с
непосредственной адресацией). Как уже отмечалось,  они  имеют  3-х
(либо  4-х)  байтовый  формат,  т.е.  каждая  команда  занимает  3
последовательно расположенные в памяти ячейки.  В  последних  двух
ячейках хранится 16-разрядный адрес обращения к памяти.

При выполнении такой команды микропроцессор переписывает  адрес
во внутренние буферные регистры и затем при  обращении  к  памяти,
для записи или чтения данных передает из этих  регистров  на  шину
адресов 16-разрядный адрес.

Команды с непосредственной адресацией выполняются  относительно
медленно, т.к. микропроцессору при их выполнении приходится дважды
обращаться к памяти для побайтового чтения кода адреса.

В системе команд есть  также  команды,  использующие  косвенную
адресацию.  При  их   выполнении   адресация   осуществляется   по
содержимому одной из регистровых пар  BC,  DE,  HL  или  индексных
регистров IX, IY, куда предварительно помещается  адрес  требуемой
ячейки памяти и откуда он поступает на шину адресов.

Кроме описанных 2-х способов адресации,  возможна  адресация  к
ячейкам  памяти  по   содержимому   16-разрядного   регистра   SP,
называемого указателем стека. Под стеком  в  микропроцессоре  Z-80
понимается  любая  область  ОЗУ,  служащая  для  хранения  адресов
констант  и  промежуточных  данных,  адесация  к  ячейкам  которой
осуществляется с помощью указателя стека SP. Поместить  и  извлечь
данные  из  стека  можно  только  через  его  вершину,   поскольку
используется принцип LIFO - "последним пришел - первым вышел".

С помощью команд, использующих стековую адресацию, в стек можно
переслать  16-разрядное  число  из  любой  регистровой  пары   или
регистра-счетчика команд PC.

Запись числа в стек происходит побайтно:  сначала  записывается
старший байт в ячейку с адресом на 1 меньшим указателя стека (т.е.
в ячейку с адресом SP-1), затем - младший байт в ячейку с  адресом
SP-2. Таким образом,  по  окончании  записи  содержимое  указателя
стека становится равным SP-2 (т.е. при  занесении  в  стек  данных
указатель стека автоматически каждый раз  "смещается  вниз"  на  2
ячейки).

В системе  команд  есть  и  такие  команды,  которые  позволяют
осуществлять обратную операцию.  В  этом  случае  указатель  стека
увеличивается на 2.

Стек явно и неявно широко используется при программировании.  В
стек, например, помещается адрес возврата при вызове  подпрограмм,
в стеке удобно временно хранить данные из регистров,  т.к.  запись
содержимого пары  регистров  в  стек  и  извлечение  их  из  стека
осуществляется  однобайтовыми  (  или  при  работе  с   индексными
регистрами двухбайтовыми) командами.

В заключение приведем краткий список способов адресации [5]:

1. __Непосредственная адресация__:
в этом режиме ячейка, следующая за кодом операции,  содержит
операнд (8 бит).

2. __Расширенная непосредственная адресация__:
ячейки, следующие за кодом операции,  содержат  16-разрядный
операнд.

3. __Модифицированная адресация нулевой страницы__:
имеется команда, называемая рестартом, которая  используется
для инициирования перехода  на  подпрограмму  по  одному  из
возможных  адресов  нулевой  страницы.  В  ячейках  с  этими
адресами могут размещаться часто используемые  подпрограммы,
доступ к которым может осуществляться с помощью однобайтовых
команд.

4. __Относительная адресация__:
в этом режиме задается однобайтовое смещение в диапазоне  от
+127 до -128 относительно текущего адреса плюс 2,  что  дает
возможность    обращения    к    расположенной    поблизости
подпрограмме с помощью команды длиной 2  байта  и  позволяет
создавать перемещаемые программы.

5. __Расширенная адресация__:
полный   16-разрядный    адрес    назначения    определяется
двухбайтовым  операндом.  Этим  способом  можно   обеспечить
обращение  к  подпрограмме  или  переход  по  любому  адресу
памяти.

6. __Индексная адресация__:
смещение прибавляется к числу  в  одном  из  двух  индексных
регистров, образуя действительный адрес памяти. Этот  способ
полезен для работы с таблицами.

7. __Регистровая адресация__:
код  операции  включает  в  себя   обозначение   конкретного
регистра.

8. __Неявная адресация__:
регистр    адреса,    например    аккумулятор,    однозначно
определяется данной командой.

9. __Регистровая косвенная адресация__:
16-разрядная пара регистров,  например  HL,  содержит  адрес
операнда.

10. __Побитовая адресация__:
три разряда  кода  операции  определяют  конкретные  разряды
ячейки памяти, над которым производится данная операция.

__Внимание!__ Для хранения  в  памяти  16-разрядному  числу  всегда
отводится 2 смежные ячейки. Запись чисел в эти  ячейки  происходит
побайтно, причем в ячейку с меньшим адресом  записывается  младший
байт, а в ячейку с большим адресом - старший байт  числа  (принцип
системы  INTEL).  Это  правило  выполняется  при  любых   способах
адресации.


#### 2.6. Прерывания

Микропроцессорные  устройства   и   микроЭВМ   наиболее   часто
работают в так называемом "режиме реального времени".  Этот  режим
характерен  тем,  что  события   во   внешнем   по   отношению   к
микропроцессору  мире  происходят  в   различные   непредсказуемые
заранее моменты времени.

Микропроцессор должен своевременно реагировать на  эти  события
независимо от того,  занят  ли  он  в  данный  момент  какими-либо
другими  действиями  или  нет.  Для  этого   имеется   возможность
прерывания работы текущей программы  по  специальным  сигналам  от
внешних устройств или датчиков - запрос прерывания (IRQ).

При поступлении запроса прерывания микропроцессор  переходит  к
выполнению подпрограммы обработки  прерываний,  т.е.  к  действию,
являющемуся реакцией на внешнее событие.

При   появлении   запроса   прерывания   микропроцессор   после
выполнения очередной команды текущей программы  считывает  не  код
операции следующей команды из памяти, как обычно,  а  код  команды
вызова  подпрограммы,  формируемый  на  шинах  данных  специальным
блоком - контроллером прерываний.

Выполнение команды процессором состоит из нескольких циклов:

- Чтение и декодирование кода операции, восстановление DRAM;
- Операции чтения/записи из памяти, из портов ввода/вывода;
- Внутренняя   операция    микропроцессора,    обработка   запроса
прерывания  IRQ.  Если  запрос  прерывания  был   послан   внешним
устройством, берется код его операции и адресный вектор.

Обычно  в  качестве  команд   вызова   подпрограмм   используют
однобайтовые команды RST 0  -  RST  7.  В  зависимости  от  номера
команды ее выполнение ведет к передаче управления на одну из ячеек
памяти  в   начальной   области   памяти   (см.   систему   команд
микропроцессора). Программы обработки прерываний обычно начинаются
с сохранения всех регистров в стеке:

```
       PUSH hl
       PUSH de
       PUSH bc
       PUSH af
       EXX
       EX   af,af'
       PUSH hl
       PUSH de
       PUSH bc
       PUSH af
       PUSH iy
       PUSH ix
       ...
```

В конце подпрограммы обычно выполняются следующие команды:

```
       ...
       POP ix     ; Стандартное завершение обработки прерывания
       POP iy
       POP af
       POP bc
       POP de
       POP hl
       EX  af,af'
       EXX
       POP af
       POP bc
       POP de
       POP hl
       EI
       RET
```

С помощью команд чтения из стека  восстанавливается  содержимое
регистров микропроцессора, а затем выполняется команда  разрешения
прерываний EI.  Последнее  необходимо,  т.к.  после  возникновения
прерывания  в  микропроцессоре  всегда  автоматически  запрещается
прием запросов прерываний. Последняя команда производит возврат  в
основную программу.

Возврат происходит в то место этой программы и с тем состоянием
внутренних  регистров,  которые  были  до  момента   возникновения
прерывания. Вместо команд EI и RET можно использовать одну команду
RETI (возврат из маскируемого прерывания)  или  RETN  (возврат  из
немаскируемого  прерывания),  выбор  которых   зависит   от   типа
прерывания.

Процессор Z-80 предусматривает несколько режимов прерывания: 

1. __Немаскируемое прерывание (NMI)__:
в этом случае выполняется рестарт  с  ячейки  0066h.  Запрос
немаскируемого прерывания принимается  процессором  в  любой
момент  времени.  Однако  в  системе  MSX  сигнал   NMI   не
используется и данное прерывание никогда не происходит, хотя
для его обработки имеется ловушка.

2. __Маскируемое прерывание (INT)__:
терминал прерывания  INT  получает  60  сигналов  таймера  в
секунду. Существует в трех видах, каждый из которых доступен
для программиста:

  a) __вид 0__: прерывания этого типа возникают автоматически  при
появлении  сигнала  RESET;  реакция  на  него   идентична
реакции  на  прерывание   в   процессоре   INTEL   8080A.
Прерывающее устройство может выдать любую команду на шину
данных  (обычно   команду   рестарта   или   трехбайтовую
перехода), и процессор выполнит ее;

  b) __вид 1__: этот вид прерывания инициирует  рестарт  с  ячейки
0038h, подобно реакции  на немаскируемое прерывание, хотя
и отличается адресом перехода; сигнал INT  от VDP появля-
ется на входе процессора каждые 1/60 секунды NTSC.

  c) __вид 2__: при этом виде  прерываний  прерывающее  устройство
посылает в процессор 8-разрядное слово, которое указывает
адрес   стандартной   программы   обработки   прерываний,
хранящейся в памяти  программ.  Старшие  восемь  разрядов
этого адреса помещаются программистом в  регистр  I.  Это
наиболее  эффективный  способ   организации   прерываний,
поскольку  один  8-разрядный  аргумент  может  определять
адрес подпрограммы, расположенной в любом месте памяти.


### 3. Порты ввода/вывода

Как уже говорилось, порты  -  это  устройства  сопряжения,  при
помощи которых микропроцессор Z80 может обмениваться информацией с
другими микропроцессорами или устройствами.

Порт   хранит   восьмиразрядное   значение   (байт)   и   может
использоваться для чтения информации, ее  записи,  или  и  того, и
другого.

Порты с номерами 0-14 используются для работы с  сетью  RS232C,
90h-92h - для работы с принтером, 98h-9Bh  -  с  видеопроцессором,
A8h-ABh - для работы с параллельным интерфейсом PPI и т.д.

Список портов приведен в Приложении 2  вместе с  дополнительной
информацией по работе с ними.


### 4. Организация памяти

При программировании в системе MSX используется несколько типов
памяти:

- __RAM__ - Random Access Memory, ОЗУ, память доступная для  чтения
и  записи  (место,  где  хранятся  программы,   данные,
системные переменные и стек);

- __ROM__ - Read Only  Memory,  ПЗУ,  доступна  только  для  чтения
(здесь   хранится   программа    начальной    загрузки,
интерпретатор  языка  BASIC,  подпрограммы  в  машинных
кодах - BIOS). Информация в ПЗУ сохраняется  независимо
от того, включен источник питания или выключен.

- __VRAM__ - Video  RAM,  видеопамять  (для  хранения  текстовых  и
графических изображений, спрайтов). При желании  в  ней
можно разместить обычные данные, если не хватает RAM).

Организация памяти типов RAM и ROM будет описана  ниже  в  этом
параграфе, а организация видеопамяти - в 6.


#### 4.1. Карта памяти

Компьютер  YIS503  имеет  16-разрядную  шину  адреса.   Поэтому
возможна адресация до 2^16 ячеек памяти, т.е. диапазон адресов  от
0  до  65535  (FFFFh).  Каждая  ячейка  памяти  хранит  один  байт
информации.

В системе MSX весь объем памяти разделен на 4 блока  (страницы)
по 16K. Страницы имеют следующие интервалы адресов:

| страница | адреса памяти |
|:--------:|--------------:|
|    0     | 0000h - 3FFFh |
|    1     | 4000h - 7FFFh |
|    2     | 8000h - BFFFh |
|    3     | C000h - FFFFh |

Каждой странице (и значит,  интервалу  адресов)  реально  может
соответствовать не один, а несколько блоков памяти.  Но  в  каждый
момент времени каждой странице соответствует один и только один из
блоков (слоев) этой страницы.

В данной системе страница памяти может подключаться к одному из
четырех блоков.

Карта и содержимое слоев (слотов) памяти приведены на Рис.4.1.

Здесь использованы следующие обозначения:

- __BIOS__    - ПЗУ с BIOS (стандартные подпрограммы ввода/вывода);
- __EBIOS__   - расширенный BIOS (для MSX-2);
- __BASIC__   - ПЗУ с интерпретатором языка MSX-BASIC;
- __BDOS__    - ПЗУ встроенного дисковода консольной Ямахи MSX-2;
- __PAINTER__ - ПЗУ с  графическим  редактором  (только  для  консольной
Ямахи MSX-2);
- __RAM__     - оперативная память;

```
                      Компьютер YIS503III

             0     1     2           3
           ┌─┴─┐ ┌─┴─┐ ┌─┴─┐ ┌───────┴───────┐ - Первичный слот
           │   │ │   │ │   │   0   1   2   3
           │   │ │   │ │   │ ┌─┴─┬─┴─┬─┴─┬─┴─┐ - Вторичный слот
────────   ┌───┐ ┌───┐ ┌───┐ ┌───┬───┬───┬───┐            ┌───┐
0000h      │   │ │   │ │   │ │ E │   │ R │   │          ┌─┤ 7 │
           │ B │ │   │ │   │ │ B │   │ A │   │          │ └───┘
 Стр. 0    │ I │ │   │ │   │ │ I │   │ M │   │          │ ┌───┐
           │ O │ │   │ │   │ │ O │   │   │   │          ├─┤ 6 │
3FFFh      │ S │ │   │ │   │ │ S │   │ ∙────────┐       │ └───┘
────────   ├───┤ ├───┤ ├───┤ ├───┼───┼───┼───┤  │       │ ┌───┐
4000h      │ B │ │   │ │   │ │   │   │ R │NET│  │Memory ├─┤ 5 │
           │ A │ │   │ │   │ │ C │   │ A │ROM│  │Mapper │ └───┘
 Стр. 1    │ S │ │   │ │   │ │ P │   │ M │   │  │┌───┐  │ ┌───┐
           │ I │ │   │ │   │ │ / │   │   │RAM│  └┼ ─ ┼──┼─┤ 4 │
7FFFh      │ C │ │   │ │   │ │ M │   │ ∙─────────┼ ─ ┼──┤ └───┘
────────   ├───┤ ├───┤ ├───┤ ├───┼───┼───┼───┤   │   │  │ ┌───┐
8000h      │   │ │   │ │   │ │   │   │ R │NET│ ┌─┼ ─ ┼──┼─┤ 3 │
           │   │ │   │ │   │ │   │   │ A │ROM│ │┌┼ ─ ┼──┤ └───┘
 Стр. 2    │   │ │   │ │   │ │   │   │ M │   │ ││└───┘  │ ┌───┐
           │   │ │   │ │   │ │   │   │   │RAM│ ││       ├─┤ 2 │
BFFFh      │   │ │   │ │   │ │   │   │ ∙───────┘│       │ └───┘
────────   ├───┤ ├───┤ ├───┤ ├───┼───┼───┼───┤  │       │ ┌───┐
C000h      │   │ │   │ │   │ │   │   │ R │   │  │       ├─┤ 1 │
           │   │ │   │ │   │ │   │   │ A │   │  │       │ └───┘
 Стр. 3    │   │ │   │ │   │ │   │   │ M │   │  │       │ ┌───┐
           │   │ │   │ │   │ │   │   │   │   │  │       └─┤ 0 │
FFFFh      │   │ │   │ │   │ │   │   │ ∙────────┘         └───┘
────────   └───┘ └───┘ └───┘ └───┴───┴───┴───┘
```

```
                    Компьютер YIS805/128R2

             0     1     2           3
           ┌─┴─┐ ┌─┴─┐ ┌─┴─┐ ┌───────┴───────┐ - Первичный слот
           │   │ │   │ │   │   0   1   2   3
           │   │ │   │ │   │ ┌─┴─┬─┴─┬─┴─┬─┴─┐ - Вторичный слот
────────   ┌───┐ ┌───┐ ┌───┐ ┌───┬───┬───┬───┐            ┌───┐
0000h      │   │ │   │ │   │ │   │ E │ R │   │          ┌─┤ 7 │
           │ B │ │   │ │   │ │   │ B │ A │   │          │ └───┘
 Стр. 0    │ I │ │   │ │   │ │ P │ I │ M │   │          │ ┌───┐
           │ O │ │   │ │   │ │   │ O │   │   │          ├─┤ 6 │
3FFFh      │ S │ │   │ │   │ │   │ S │ ∙────────┐       │ └───┘
────────   ├───┤ ├───┤ ├───┤ ├ A ┼───┼───┼───┤  │       │ ┌───┐
4000h      │ B │ │   │ │   │ │   │   │ R │NET│  │Memory ├─┤ 5 │
           │ A │ │   │ │   │ │   │ B │ A │ROM│  │Mapper │ └───┘
 Стр. 1    │ S │ │   │ │   │ │ I │ D │ M │   │  │┌───┐  │ ┌───┐
           │ I │ │   │ │   │ │   │ O │   │RAM│  └┼ ─ ┼──┼─┤ 4 │
7FFFh      │ C │ │   │ │   │ │   │ S │ ∙─────────┼ ─ ┼──┤ └───┘
────────   ├───┤ ├───┤ ├───┤ ├ N ┼───┼───┼───┤   │   │  │ ┌───┐
8000h      │   │ │   │ │   │ │   │   │ R │NET│ ┌─┼ ─ ┼──┼─┤ 3 │
           │   │ │   │ │   │ │   │   │ A │ROM│ │┌┼ ─ ┼──┤ └───┘
 Стр. 2    │   │ │   │ │   │ │ T │   │ M │   │ ││└───┘  │ ┌───┐
           │   │ │   │ │   │ │   │   │   │RAM│ ││       ├─┤ 2 │
BFFFh      │   │ │   │ │   │ │   │   │ ∙───────┘│       │ └───┘
────────   ├───┤ ├───┤ ├───┤ ├ E ┼───┼───┼───┤  │       │ ┌───┐
C000h      │   │ │   │ │   │ │   │   │ R │   │  │       ├─┤ 1 │
           │   │ │   │ │   │ │   │   │ A │   │  │       │ └───┘
 Стр. 3    │   │ │   │ │   │ │ R │   │ M │   │  │       │ ┌───┐
           │   │ │   │ │   │ │   │   │   │   │  │       └─┤ 0 │
FFFFh      │   │ │   │ │   │ │   │   │ ∙────────┘         └───┘
────────   └───┘ └───┘ └───┘ └───┴───┴───┴───┘
```
Рис.4.1. Карта памяти MSX-2

- __NET RAM__ - сетевая оперативная память (адресуется к одному  участку
памяти);
- __NET ROM__ - сетевая постоянная память;
- __CP/M__    - операционная система CP/M, ROM.

По адресу FFFFh  расположен  специальный  регистр  переключения
вторичных слотов.

Первый и второй слои (слоты) обычно используются для  работы  с
картами ПЗУ игр, музыкальных и графических редакторов, дисководов.

Какой  из  слоев  включен  на  данной  странице,   определяется
содержимым порта A8h и регистром вторичных слоев (FFFFh).

Формат порта A8h:

    Биты        7 6   5 4   3 2   1 0
              ┌─────┬─────┬─────┬─────┐
    Слои      │ * * │ * * │ * * │ * * │
              └─────┴─────┴─────┴─────┘
    Страницы     3     2     1     0

На каждую страницу  в  порте  A8h  отводится  2  бита,  которые
кодируют число от 0 до 3  -  номер  слоя,  включенного  на  данной
странице.

Например, при включении компьютера в порту A8h обычно  записано
значение:

    (A8h) = 1111 0000

Это означает, что страницы 0 и 1 берутся из слота 0, а страницы
2 и 3 - из слота 3.

Слой номер 3 состоит из 4 подслоев (вторичных слоев). Какой  из
вторичных  слоев  в  данный  момент   используется,   определяется
содержимым специального  регистра,  который  находится  по  адресу
FFFFh (для всех вторичных слоев первичного слоя номер 3 он общий).
Формат записи в этом специальном регистре такой же, как и в  порте
A8h. Отличием является то, что запись в него идет в прямом виде, а
читается значение - в инвертированном.

Например, на ученическом компьютере после включения может  быть
установлено:

             (FFFFh) = 5Fh = 0101 1111
             инверсия: A0h = 1010 0000

     а на учительском -
             (FFFFh) = 59h = 0101 1001
             инверсия: A6h = 1010 0110

Подслой номер 2 первичного слоя номер  3  является  виртуальной
оперативной  памятью.  В  MSX-1  виртуальная  оперативная   память
совпадает с физической.  В  MSX-2  физическая  оперативная  память
имеет объем 128K и состоит из 8 страниц по 16K,  поэтому  страницы
виртуальной  памяти   отображаются   на   физическую   с   помощью
специального устройства под названием  маппер  (  Memory  Mapper),
если он есть.

Управление этим устройством  осуществляется  с  помощью  портов
FCh, FDh, FEh, FFh. Порт  FCh  управляет  распределением  страницы
номер 0, FDh - номер 1, FEh - номер 2,  FFh  -  номер  3.  В  этих
портах  лежат  номера  страниц  физической  памяти,   на   которые
отображаются соответствующие страницы виртуальной памяти.

Однако нужно иметь в виду, что модель с 64К  памяти  использует
только два младших бита, а модель со  128К  -  три  младших  бита.
Остальные биты устанавливаются в 1. Таким  образом  на  машине  со
128К памяти содержимое портов FCh..FFh выглядит как 11111***.

Первоначальное содержимое портов FCh..FFh:

| Порт | Логический номер страницы | Содержимое порта | Номер физической страницы |
|-----:|--------------------------:|-----------------:|--------------------------:|
|   FC |                         0 |               FB |                      ...3 |
|   FD |                         1 |               FA |                      ...2 |
|   FE |                         2 |               F9 |                      ...1 |
|   FF |                         3 |               F8 |                      ...0 |

Таким  образом,  осуществляется   трехкратная   диспетчеризация
памяти: страница адресного пространства отображаетса  на  один  из
первичных слоев, первичный слой, если его номер - 3,  отображается
на один из вторичных слоев, вторичный слой, если его  номер  -  2,
отображается на страницу физической оперативной памяти.

Два   наиболее   используемых   режима   работы   с   различной
организацией памяти - это режим интерпретатора языка  MSX-BASIC  и
режим MSX-DOS.


##### Режим MSX-BASIC

Нулевую  и  первую  страницы  занимают  подпрограммы   BIOS   и
интерпретатор языка  BASIC,  вторая  и  третья  предназначены  для
хранения текста BASIC-программы  до  адреса  F37Fh  (для  дисковой
версии до DE76h), с адреса F380h (DE77h) по адрес FFFFh  размещена
рабочая (системная) область.

Для каждого файла резервируется 267 байт.

В системе MSX-1 в ячейках ПЗУ NN 45,46,47 записан ноль.

```
             ПЗУ (слот 0)                  ПЗУ (слот 3-0/1)

  ───── ┌──────────────────────┐  ──── ┌──────────────────────┐
 0000   │   Входы в BIOS       │  0000 │                      │
 015B   │                      │       │                      │
  ───── ├──────────────────────┤       │                      │
 015C   │  Дополнит.входы      │       │   Входы SUBROM BIOS  │
 0179   │      в BIOS          │       │                      │
  ───── ├──────────────────────┤       │                      │
 017A   │     Резерв           │       │                      │
 01B7   │                      │       │                      │
  ───── ├──────────────────────┤       │                      │
 01B8   │   Интерпретатор      │       ├──────────────────────┤
        │  языка MSX-BASIC     │  01F0 │ Управление слотами   │
        │                      │       ├──────────────────────┤
        │                      │  0338 │ Интерпретатор языка  │
        │                      │       │   MSX-BASIC и BIOS   │
        │                      │  3FFF │                      │
 7FFC   │                      │       └──────────────────────┘
  ───── ├──────────────────────┤
 7FFD   │  Вход в BDOS         │            ОЗУ (слот 3-2)
 7FFF   │                      │
  ───── └──────────────────────┘  ┌──────────────────────────┐
 8000                    (BOTTOM) │ Программа на языке BASIC │
                                  │          (PIT)           │
                         (VARTAB) │ ┬     Переменные         │
                                  │ │        (VT)            │
                         (ARYTAB) │ ▼       Массивы          │
                                  │                          │
                                  │    Свободная область     │
                                  │ ▲                        │
                                  │ │         Стек           │
                         (STKTOP) │ ┴                        │
                                  │          Строки          │
                         (MEMTOP) │                          │
                                  │ Блоки управления файлами │
(HIMEM) - - - - - - - -  (HIMEM)  │- - - - - - - - - - - - - │
                                  │     Рабочая область      │
FFFF                              │            MSX           │
      - - - - - - - - - - - - - - └──────────────────────────┘
```
Рис.4.2. Карта памяти в режиме MSX-BASIC

```
                         Слот 3-2

 ─────────────  ┌──────────────────────────┐
0000h           │                          │
                │        MSX-DOS BIOS      │
00FFh           │                          │
 ─────────────  ├──────────────────────────┤
0100h           │  Область для транзитных  │
                │  ┬     программ       ┬  │
                │  │                    │  │
                │  │    COMMAND.COM     │  │
                │  ▼        Стек        ▼  │
(0006)          ├──────────────────────────┤
                │       MSX-DOS.SYS        │
 ─────────────  ├──────────────────────────┤
HIMEM           │    Рабочая область MSX   │
FFFFh           │                          │
 ─────────────  └──────────────────────────┘
```
Рис.4.3. Карта памяти в режиме MSX-DOS


##### Режим MSX-DOS

Файлы типа COM  загружаются  с  адреса  100h.  Система  MSX-DOS
размещается в старших адресах ОЗУ, над системной областью.

В ячейке 5 хранится команда перехода к MSX-DOS -  JMP  BDOS,  в
ячейках 6,7 - адрес начала MSX-DOS, в  нулевой  ячейке  -  команда
перехода на рестарт DOS - JMP WBOOT.

Команды языка ассемблера Z-80 могут занимать в памяти от 1 до 4
байт. Например: dec a - один байт; sub 23 - два байта;
call 8900h - 3 байта; ld (6700h),sp - 4 байта.


#### 4.2. Подпрограммы ПЗУ

В  постоянную  память  компьютеров   MSX   и   MSX-2   записано
разнообразное программное  обеспечение.  Например,  при  включении
компьютера автоматически запускается редактор-интерпретатор  языка
MSX-BASIC, хранящийся в ПЗУ. На компьютере учителя можно запустить
графический редактор PAINTER, в ПЗУ  компьютера  ученика  хранится
операционная система CP/M.

Программист   может   воспользоваться   несколькими    наборами
подпрограмм ПЗУ. В их число входят:

- подпрограммы MSX-BASIC BIOS;
- функции BDOS;
- сетевые функции MSX-DOS BIOS;
- подпрограммы интерпретатора языка MSX-BASIC.


##### Подпрограммы MSX-BASIC BIOS 

При помощи подпрограмм MSX-BASIC BIOS можно  управлять  слотами
памяти, обращаться к  видеопроцессору,  звукогенератору,  консоли,
кассетному магнитофону, дисководу, печатающему устройству.

Эти подпрограммы хранятся в нулевой странице нулевого слота.

Компьютеры  MSX-2,  кроме  этого, имеют  дополнительный   набор
подпрограмм - (SUBROM EBIOS), дающий возможности работы с графикой
MSX-2 и некоторые другие возможности.  EBIOS  хранится  в  нулевой
странице слота 3-0 компьютера ученика (YIS503III)  или  в  нулевой
странице слота 3-1 компьютера учителя (YIS805/128R2).

Список подпрограмм BIOS и SUBROM EBIOS приведен в Приложении 3.


##### Функции BDOS

Эти функции обеспечивают  работу  операционной  системы  (DOS).
Операционная система управляет работой компьютера, поэтому в  этот
набор функций входят функции  рестарта,  ввода/вывода  символов  с
различных устройств, работы с  файлами,  установки/чтения  даты  и
времени и некоторые другие.

Функции BDOS обычно расположены на первой странице  слота  3-1.
Список функций MSX BDOS приведен в Приложении 4.


##### Сетевые функции MSX-DOS BIOS

Сетевые  функции   позволяют   осуществлять   обмен   различной
информацией между компьютером учителя и компьютерами  учеников.  К
этим функциям относятся инициализация и отключение локальной сети,
получение  номера  компьютера  в  классе,  пересылки  программ   и
видеопамяти,  чтение/запись  в  память  указанного  компьютера   и
другие.

Сетевые функции находятся в слоте 3-3 и могут быть вызваны  как
из MSX-DOS, так и в режиме MSX-BASIC. Список  функций  приведен  в
Приложении 6.


##### Подпрограммы интерпретатора языка MSX-BASIC

Интерпретатор языка MSX-BASIC использует в своей  работе  набор
различных подпрограмм,  из  которых  наиболее  полезными  являются
арифметические  подпрограммы  -  сложения,  вычитания,  умножения,
деления, возведения  в  степень  и  функции  для  различных  типов
данных.

Эти подпрограммы, как и  MSX-BASIC  BIOS  находятся  в  нулевой
странице нулевого слота, а их список приведен в Приложении 5.


#### 4.3. Хранение программ на языке MSX-BASIC

В режиме работы на языке MSX-BASIC  в  слоте  3-2  (оперативная
память) на страницах 2 и  3  обычно  размещается  текст  программы
пользователя (PIT - Program Instruction Table) на языке MSX-BASIC.
Как правило, она начинается по адресу &h8000.

Рассмотрим на примере порядок и организацию хранения  программы
при ее размещении в PIT. Допустим, была набрана такая программа:

```
10 A=5
20 B=A+47
30 PRINT B
40 END
```

Тогда она будет размещена редактором языка MSX-BASIC  с  адреса
&h8000 следующим образом:

```
          ┌──────────────────────────────────┐    ┌──────────
│8000 ┌───┴───┐     │8004          │8007     ▼┌───┴───┐│800B
├────┬────┬────┬────┼────┬────┬────┼────┬────┬────┬────┼────┬
│ 00 │ 09 │ 80 │ 0A │ 00 │ 41 │ EF │ 16 │ 00 │ 14 │ 80 │ 14 │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴
                 └─────┘                                 └───
                    10      A    =    5    *                20
```

```
────────────────────────────────────────┐    ┌───────────────
│800C               │8010               ▼┌───┴───┐     │8017
┼────┬────┬────┬────┼────┬────┬────┬────┬────┬────┬────┼────┬
│ 00 │ 42 │ EF │ 41 │ F1 │ 0F │ 2F │ 00 │ 1C │ 80 │ 1E │ 00 │
┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴
───┘                                                └─────┘
        B    =    A    +      47      *                30
```

```
────────────────────┐    ┌────────────────────────┐
│8018               ▼┌───┴───┐     │801F          ▼
┼────┬────┬────┬────┬────┬────┬────┼────┬────┬────┬────┬────┐
│ 91 │ 20 │ 42 │ 00 │ 22 │ 80 │ 28 │ 00 │ 81 │ 00 │ 00 │ 00 │
┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘
                                └─────┘
 PRINT └─┘   B    *                40     END   *     конец
                                                    программы
```

В первом байте PIT хранится  ноль.  Затем  для  каждой  команды
последовательно записываются  ссылка  на  следующую  команду  (два
байта  в  обратном  порядке),   номер   строки   программы   (тоже
инвертирован), затем внутреннее  представление  строки  программы,
которое заканчивается нулевым кодом.

Конец программы определяется по  нулевой  ссылке  на  следующую
программную строку. Ключевые слова, знаки операций и  цифры  языка
MSX-BASIC кодируются одним (81h..FCh) или двумя (255  +  81h..B0h)
байтами.


#### 4.4. Хранение данных

При выполнении программ на языке MSX-BASIC переменные  хранятся
в специальной таблице (VARTAB), которая размещается в памяти сразу
за текстом программы.

Для хранения имени переменной  выделяется  2  байта  (  поэтому
переменные AB, ABC и AB1 считаются одной и той же переменной), тип
переменной хранится в одном байте, значение переменной хранится  в
нескольких байтах (в зависимости от типа).

Целая (AB% = &h1234):

```
┌───┬───┬───┬────┬────┐
│ 2 │'A'│'B'│ 34 │ 12 │
└───┴───┴───┴────┴────┘
```

Вещественная одинарной точности (AB!=1.23456):

```
┌───┬───┬───┬────┬────┬────┬────┐
│ 4 │'A'│'B'│ 41 │ 12 │ 34 │ 56 │
└───┴───┴───┴────┴────┴────┴────┘
```

Вещественная двойной точности (AB#=1.2345678901324):

```
┌───┬───┬───┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 8 │'A'│'B'│ 41 │ 12 │ 34 │ 56 │ 78 │ 90 │ 13 │ 24 │
└───┴───┴───┴────┴────┴────┴────┴────┴────┴────┴────┘
```

Строка (AB$="rrrrr"):

```
┌───┬───┬───┬───┬────┬────┐
│ 3 │'A'│'B'│ 5 │ 00 │ 89 │
└───┴───┴───┴───┴────┴────┘
              ^      ^
            длина   адрес строки в памяти
```

Переменные с  одинаковыми  именами  могут  быть  разных  типов.
Интерпретатор различает их, поскольку тип  переменной  хранится  в
таблице отдельно.

Функция  языка  MSX-BASIC  VARPTR  дает   адрес,   с   которого
начинается  значение  переменной.   Тип   и   имя   имеют   адреса
соответственно на 3 и 2 байта меньше.


##### Хранение целых значений

Значения переменных целого типа  хранятся  в  двоичной  системе
счисления в дополнительном коде. Каждое значение хранится  в  двух
байтах, причем младший байт значения размещается перед старшим.

Например, `A=3`
Шестнадцатеричное значение - 0003h.
В таблице будет записано:

```
┌────┬────┬────┬────┬────┐
│ 02 │ 41 │ 00 │ 03 │ 00 │
└────┴────┴────┴────┴────┘
```

`XY=300`
Шестнадцатеричное значение - 12Ch.
В таблице будет записано:

```
┌────┬────┬────┬────┬────┐
│ 02 │ 58 │ 59 │ 2C │ 01 │
└────┴────┴────┴────┴────┘
```

`P1=-6`
Шестнадцатеричное значение - 0006h,
дополнительный код - FFFAh.
В таблице будет записано:

```
┌────┬────┬────┬────┬────┐
│ 02 │ 50 │ 31 │ FA │ FF │
└────┴────┴────┴────┴────┘
```

##### Хранение вещественных значений

Представление  вещественного  значения  состоит  из  порядка  и
двоично-десятичной мантиссы.

Порядок задает знак мантиссы и степень десяти, на которую нужно
умножить мантиссу. Знак мантиссы кодируется первым битом  порядка,
а степень десяти - следующим образом:

| Шестн. код | Десятичное значение |
|-----------:|--------------------:|
|         00 |                 -64 |
|         01 |                 -63 |
|        ... |                 ... |
|         3F |                  -1 |
|         40 |                   0 |
|         41 |                   1 |
|        ... |                 ... |
|         7F |                  63 |

Таким образом код порядка 42 означает увеличение мантиссы в 100
раз.

Мантисса вещественного значения  обычной  точности  хранится  в
трех  байтах,  двойной  -  в  семи  байтах.   Для   ее   кодировки
используется двоично-десятичный код ( BCD).  Поэтому  вещественные
значения обычной точности могут иметь до шести десятичных цифр,  а
двойной - до четырнадцати.

Например,  вещественная  переменная  обычной  точности   A   со
значением 34.47 будет храниться в таблице переменных в виде:

```
┌────┬────┬────┬────┬────┬────┬────┐
│ 04 │ 41 │ 00 │ 42 │ 34 │ 47 │ 00 │
└────┴────┴────┴────┴────┴────┴────┘
```


##### Хранение массивов

При программировании на языке MSX-BASIC массивы хранятся  сразу
за таблицей переменных в формате, приведенном на Рис.4.1.

```
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬────
│ VT  │ VN  │ LEN │ ND  │ NIn │ ... │ NI2 │ NI1 │ D1  │ D2  │ ...
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴────
```
Рис.4.1. Формат хранения массива

- __VT__ - тип переменной
- __VN__ - имя переменной (2 байта)
- __LEN__ - общая длина массива (2 байта)
- __ND__ - количество измерений
- __NIn__ - максимальная размерность последнего измерения + 1 (2 байта)
- __NI1__ - максимальная размерность первого измерения + 1 (2 байта)
- __D1,D2,...__ - элементы массива.


Например, если выполнить следующие операторы  языка  MSX-BASIC

```
DEFINTA-Z:DIM AB(2,4):AB(0,0)=32:AB(1,0)=10,
```

то внутреннее представление массива AB будет иметь вид:

```
┌──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬─
│02│41│42│23│00│02│05│00│03│00│20│00│0A│00│
└──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴─
          └───┘    └───┘ └───┘ └───┘ └───┘
Тип A  B кол-во ND  NI2   NI1    32    10
```

#### 4.5. Рабочая область и ловушки

Для  работы  интерпретатора   и   экранного   редактора   языка
MSX-BASIC, которые как Вы  помните,  размещены  в  ПЗУ,  требуется
некоторый объем оперативной памяти. В ней могут храниться  текущий
тип экрана и адреса таблиц видеопамяти, текущая строка и позиция в
строке программы, различные флаги  и  признаки,  указатели  буфера
клавиатуры, рабочие области для  выполнения  различных  операторов
языка MSX-BASIC и т.д.

Рабочей областью пользуется  и  MSX-DOS,  поэтому  ее  называют
иногда еще системной областью.

Достаточно полное описание рабочей области системы MSX-2 дано в
Приложении 1.


#### 4.6. Сетевая память

В версии 3.0 локальной сети КУВТ-2 каждому компьютеру,  включая
учительский, предоставляется 2 Кбайта сетевой  оперативной  памяти
(RAM) с адресами 7800h Ў 7FFFh, слот 3-3.

Краткая карта памяти сетевого ОЗУ КУВТ-2 приведена на Рис.4.2.

```
┌──────┬──────────────────────────────────────────────┬───────┐
│ Адрес│              Назначение                      │ Объем │
├──────┼──────────────────────────────────────────────┼───────┤
│ 7800 │ Область для передаваемых сообщений (message) │  256  │
│ 78FF │                                              │       │
├──────┼──────────────────────────────────────────────┼───────┤
│ 7900 │ Передающий почтовый ящик (mailbox)           │  256  │
│ 79FF │                                              │       │
├──────┼──────────────────────────────────────────────┼───────┤
│ 7A00 │ Область для получаемых сообщений (message)   │  256  │
│ 7AFF │                                              │       │
├──────┼──────────────────────────────────────────────┼───────┤
│ 7B00 │ Получающий почтовый ящик (mailbox)           │  256  │
│ 7BFF │                                              │       │
├──────┼──────────────────────────────────────────────┼───────┤
│ 7C00 │ Область управления файлами (FCB)             │  1024 │
│      │                                              │       │
│      │ Системная рабочая область                    │       │
│      │                                              │       │
│      │ Область DMA                                  │       │
│      │                                              │       │
│ 7FFF │ Рабочая область для сетевого приема          │       │
└──────┴──────────────────────────────────────────────┴───────┘
```
Рис.4.2. Карта памяти сетевого ОЗУ КУВТ-2

Кроме этого, в слоте 3-3 размещены сетевые подпрограммы  -  ROM
Net BIOS, которые были описаны выше в пункте Подпрограммы ПЗУ.


### 5. Видеопроцессор

Видеопроцессор управляет отображением информации на экране.  Он
работает под управлением микропроцессора Z-80A, однако имеет  свой
набор команд и свои видеорегистры.

В компьютерах YIS503IIR и  YIS503IIIR  используется  микросхема
VDP (Video Display Processor) V9938 (MSX-VIDEO). Микросхема  V9938
полностью совместима снизу вверх с  микросхемой  VDP TMS9918A  для
MSX-1 и может выполнять все  программное  обеспечение,  написанное
для TMS9918A.

Основные возможности MSX-VIDEO следующие:

- 512 цветов с девятибитной палитрой;
- максимальное разрешение 512 × 424 т. (при использовании
совмещения экранов);
- 256 цветов, отображаемых одновременно;
- текстовый режим 80 символов;
- аппаратно реализованные команды рисования линии, поиска,
пересылки блока;
- до восьми спрайтов на одной горизонтальной линии;
- задание цветов линий спрайтов;
- встроенная возможность оцифровки видеосигнала.

Видеопроцессор  использует  в  своей   работе   49   внутренних
регистров:

- управляющие регистры ( регистры VDP);
- регистры состояния (статуса) VDP;
- регистры палитры.

Описание регистров дано в Приложении 7.

Для   записи   информации   в    видеопамять    или    регистры
видеопроцессора   или   чтения   из   них   микропроцессором   Z80
используются порты ввода/вывода VDP - два для чтения и четыре  для
записи. Узнать номер первого порта для чтения можно в  ячейке  ПЗУ
00/0006, а для записи - в ячейке 00/0007. Обычно они  совпадают  и
равны 98h. Можно также использовать  соответствующие  подпрограммы
BIOS. Это надежнее, но медленнее.


#### 5.1. Управляющие регистры

Эти регистры имеют номера 0..23 (регистры установки)  и  32..46
(регистры команд).  Используются  только  для  записи  информации.
Описание регистров дано в Приложении 7. Назначение регистров:

- регистры режима: 0,1,8,9
- регистры базовых адресов таблиц: 2..6,10,11
- регистры цвета: 7,12,13,20,21,22
- регистры отображения (управления экраном): 18,19,23
- регистры доступа: 14..17
- командные регистры: 32..46.

Регистры  режима  управляют  прерываниями  от  светового  пера,
горизонтального сканирования, мышки, активностью экрана, размерами
спрайтов и т.д.

В регистрах  базовых  адресов  таблиц  хранятся  адреса  таблиц
ссылок на шаблоны, таблицы цветов, шаблонов, атрибутов спрайтов  и
т.д.

В регистрах цветов хранятся цвета текста, фона  и  бордюра  для
нормального режима или мигания.

Регистры  управления  экраном   задают   смещение   экрана   по
горизонтали и вертикали, номер начальной  строки  показа  и  номер
строки прерывания.

Регистры доступа хранят номер  страницы  видеопамяти  и  номера
регистров.

В регистрах команд записываются координаты,  количество точек и
команды VDP.


#### 5.2. Регистры состояния (статуса)

Используются  только  для   чтения   информации   о   состоянии
видеопроцессора. Имеют  номера  0..9  (15).  Дается  информация  о
прерываниях и спрайтах, о  номере  VDP,  о  позиции  при  коллизии
светового пера и  мыши,  о  координатах  обнаружения  границы  при
поиске. Регистр 8 VDP соответствует регистру  статуса  0,  регистр
(-1) - первому регистру, (-2) - второму и т.д.


#### 5.3. Регистры палитры

В  регистры  палитры  записываются   палитры   цветов.   Номера
регистров 0..15. Каждый регистр палитры девятибитный - по три бита
на каждый RGB-цвет (красный, зеленый,  синий).  Т.о.  для  каждого
составляющего  палитру  цвета  допускается  до   восьми   градаций
яркости.


#### 5.4. Команды VDP

Видеопроцессор имеет команды скоростной и логической  пересылки
между VRAM, VDP и CPU, команды рисования линии, поиска,  установки
точки, цвета, остановки.


### 6. Видеопамять

Видеопамять используется видеопроцессором  для  воспроизведения
закодированного в ней изображения на  экране.  Кроме  этого,  если
позволяет имеющийся  объем  памяти,  в  ней  можно  подготавливать
изображения для последующей быстрой выдачи на экран. Можно хранить
в некоторых участках видеопамяти и  обычную  информацию,  если  не
хватает оперативной памяти.

MSX-VIDEO может быть подключен к 128К VRAM  и  64К  расширенной
RAM.  Видеопроцессор  имеет  17-ти   битный   адрес.   Видеопамять
контролируется  видеопроцессором,  Z80  не  имеет  к  ней  прямого
доступа.

Память расширения ERAM не может непосредственно отображаться на
экране как VRAM. Однако с ней можно работать так же, как  с  VRAM,
используя команды видеопроцессора.  Эта  большая  рабочая  область
могла бы быть очень полезной при обработке экранных данных. Однако
стандарт  MSX-2  не  имеет  команд,   касающихся   ERAM.   Поэтому
программы, использующие этот тип  памяти, скорей  всего  не  будут
мобильными.

Система MSX-2  имеет  десять  различных  режимов  использования
(логических  типов)  экранов.  Краткое   описание   этих   режимов
приводится в Табл.6.1.

| Имя режима  | MSX-BASIC           | Описание                                                    |
|:------------|:--------------------|:------------------------------------------------------------|
| TEXT 1      | SCREEN 0 / width 40 | 40 символов на строке, один цвет для всех символов          |
| TEXT 1      | SCREEN 0 / width 80 | 80 символов на строке, возможно мигание цвета               |
| MULTI-COLOR | SCREEN 3            | псевдографика, символ делится на четыре блока               |
| GRAPHIC 1   | SCREEN 1            | 32 символа на строке, возможны раскрашенные группы символов |
| GRAPHIC 2   | SCREEN 2            | 256×192, цвет определен для 8 точек                         |
| GRAPHIC 3   | SCREEN 4            | GRAPHIC 2, но цветные спрайты                               |
| GRAPHIC 4   | SCREEN 5            | 256×212, 16 цветов для каждой точки                         |
| GRAPHIC 5   | SCREEN 6            | 512×212, 4  цвета  для каждой точки                         |
| GRAPHIC 6   | SCREEN 7            | 512×212, 16 цветов для каждой точки                         |
| GRAPHIC 7   | SCREEN 8            | 256×212, 256 цветов для каждой точки                        |
Табл.6.1. Режимы экрана

Для  обозначения  различных  таблиц  видеопамяти   используются
следующие аббревиатуры:

| Аббревиатура | Описание                                        |
|:-------------|:------------------------------------------------|
| PNT          | таблица имен шаблонов (названий образов)        |
| CT           | таблица цветов                                  |
| PGT          | таблица генератора шаблонов (образов)           |
| SAT          | таблица атрибутов спрайтов                      |
| SGT          | таблица шаблонов спрайтов (генератора спрайтов) |
| PT           | таблица палитры цветов                          |
| SCT          | таблица цветов спрайтов                         |

При включении каждого режима экрана его таблицы  просто  задают
некоторую логическую структуру видеопамяти.

Например, в  текстовых  режимах  SCREEN  0  и  1  таблица  имен
шаблонов PNT вначале  автоматически  заполняется  кодами  пробелов
(экран чист), а таблица образов PGT  заполняется  кодировкой  всех
256 символов (по 8 байт на символ). Эта таблица считывается из ROM
PGT, которая хранится в области BIOS.

Хотя символ задается восемью байтами, два младших бита  каждого
байта не отображаются  на  экране,  т.е.  символы  отображаются  в
матрице 6×8 пикселей. Цвета фона и бордюра могут быть  выбраны  из
512 цветов.

В режиме SCREEN 1 символы выводятся в виде полной матрицы  8×8.
Таблицу цветов можно  использовать  для  задания  цвета  отдельных
групп символов. При этом каждый  из  32  байтов  CT  задает  цвета
группы из восьми символов таблицы ASCII.

В  режиме  SCREEN  0,  width  80  таблица   цветов   CT   может
использоваться  для  задания  областей  мигания  на  экране   (см.
описание регистров VDP). Один бит CТ задает мигание одного символа
на экране. На экране могут отображаться 24 строки или 26.5 строк.

В режиме SCREEN 2 экран делится на  три  равных  горизонтальных
поля. Каждое поле разбивается на 256 квадратов по  8×8  точек  (32
квадрата в ряд).

Каждый квадрат 8×8 точек кодируется  восемью  последовательными
байтами   таблицы   шаблонов    изображения    PGT    и    восемью
последовательными байтами  таблицы  цветов  CT.  Каждый  байт  PGT
задает горизонтальную линию из 8 точек. Если бит равен 1  -  точка
рисуется цветом изображения, если 0 - то цветом фона.

Один байт таблицы цветов задает цвет изображения  и  цвет  фона
для восьми точек таблицы экрана. Первые четыре бита  байта  задают
цвет изображения, следующие четыре бита - цвет фона.

Таблица  имен  PNT  в  режиме  SCREEN  2  вначале   заполняется
значениями  0...255,  0...255,  0...255  -  для  каждого  из  трех
горизонтальных полей. Значение, которое записано в PNT, определяет
номер  шаблона   PGT,   который   будет   выведен   на   экран   в
соответствующем месте.  Например,  если  PNT  полностью  заполнить
нулями, то на экран будут выведены только квадраты, закодированные
первыми восемью байтами PGT.

Таблица шаблонов спрайтов SGT формируется примерно так  же, как
PGT. Спрайт 8×8 кодируется восемью байтами: каждая линия спрайта -
одним байтом; спрайт 16×16 разбивается на четыре квадрата 8×8.

В таблице атрибутов спрайтов SAT для каждого спрайта  отводится
4 байта, в  которых  записываются  координаты  вывода  спрайта  на
экран, номер шаблона спрайта в SGT, цвет спрайта.

Режим SCREEN 3 используется  довольно  редко,  поскольку  экран
разбивается на 64×48 блоков, каждый  из  которых  состоит  из  4×4
точек. Блок может иметь один цвет. Таблица PNT такая же, что  и  в
SCREEN 2.

Режим  SCREEN  4  имеет  структуру   видеопамяти,   аналогичную
структуре SCREEN 2, но дополнительно имеет таблицу цветов спрайтов
SCT.  Эта  таблица  позволяет   задать   цвет   каждой   отдельной
горизонтальной линии спрайта ("полосатые" цветные спрайты).

Режим SCREEN 5 задает разбиение экрана  на  212  строк  по  256
пикселей. Цвет может задаваться для каждого пикселя,  в  диапазоне
0..15, т.е. каждый байт PNT задает  цвет  двух  пикселей.  В  этом
режиме при памяти 128К возможна работа с четырьмя страницами VRAM.

Режим SCREEN 6 имеет более высокую  разрешающую  способность  -
212×512 пикселей при том же  размере  PNT.  Поэтому  цвет  каждого
пикселя задается всего двумя битами и соответственно  может  иметь
код 0..3 (не более четырех цветов одновременно на экране).

   В режиме SCREEN 7 разрешающая способность такая  же,  как  и  в
режиме SCREEN 6, однако для кода цвета пикселя  отводится  4 бита,
как в  SCREEN  5.  Поэтому  размер  PNT  вырастает  в  2  раза,  а
количество страниц VRAM соответственно уменьшается до двух.

Разрешающая способность в режиме SCREEN 8 уменьшена  -  212×256
пикселей, зато цвет каждого пикселя может изменяться  в  диапазоне
0..255 и кодируется одним байтом.  Код  каждого  цвета  однозначно
соответствует одной из палитр по формуле: `C=32×G+4×R+B`,
где G,R,B - значения в диапазоне  0..7,  0.7,  0..3,  определяющие
интенсивность зеленого, красного и синего цветов соответственно.

Стандартные карты таблиц видеопамяти для разных  типов  экранов
выглядят следующим образом:

```
      Screen 0,width 40   Screen 0,width 80    Screen 1

 0000 ┌──────────┐   0000 ┌──────────┐   0000 ┌──────────┐
      │ PNT 960  │        │ PNT 1920 │        │ PGT 2048 │
 03C0 ├──────────┤        │          │        │          │
      │ не исп.  │        │          │        │          │
 0400 │──────────┤        │          │        │          │
      │ PT  32   │        │          │        │          │
 0420 ├──────────┤        │          │        │          │
      │ не исп.  │   0780 ├──────────┤        │          │
      │          │        │ не исп.  │        │          │
 0800 ├──────────┤   0800 ├──────────┤   0800 ├──────────┤
      │ PGT 2048 │        │ CT 270   │        │ не исп.  │
      │          │   090E ├──────────┤        │          │
      │          │        │ не исп.  │        │          │
      │          │   0F00 ├──────────┤        │          │
      │          │        │ PT 32    │        │          │
      │          │   0F20 ├──────────┤        │          │
      │          │        │ не исп.  │        │          │
 1000 ├──────────┤   1000 ├──────────┤        │          │
      │ не исп.  │        │ PGT 2048 │        │          │
      │          │        │          │        │          │
      │          │   1800 ├──────────┤   1800 ├──────────┤
      │          │        │  не исп. │        │ PNT 768  │
      │          │        │          │   1B00 ├──────────┤
      │          │        │          │        │ SAT 128  │
      │          │        │          │   1B80 ├──────────┤
      │          │        │          │        │ не исп.  │
      │          │        │          │   2000 ├──────────┤
      │          │        │          │        │ CT 32    │
      │          │        │          │   2020 ├──────────┤
      │          │        │          │        │ PT 32    │
      │          │        │          │   2040 ├──────────┤
      │          │        │          │        │ не исп.  │
      │          │        │          │   3800 ├──────────┤
      │          │        │          │        │ SGT      │
      │          │        │          │   3BFF ├──────────┤
      │          │        │          │        │ не исп.  │
      │          │        │          │        │          │
20000 └──────────┘  20000 └──────────┘  20000 └──────────┘
```

```
        Screen 2            Screen 3             Screen 4

 0000 ┌──────────┐   0000 ┌──────────┐   0000 ┌──────────┐
      │ PGT 6144 │        │ PGT 2048 │        │ PGT 6144 │
      │          │   0800 ├──────────┤        │          │
      │          │        │ PNT 768  │        │          │
      │          │   0B00 ├──────────┤        │          │
      │          │        │ не исп.  │        │          │
 1800 ├──────────┤        │          │   1800 ├──────────┤
      │ PNT 768  │        │          │        │ PNT 768  │
 1B00 ├──────────┤   1B00 ├──────────┤   1B00 ├──────────┤
      │ SAT 128  │        │ SAT 128  │        │ не исп.  │
 1B80 ├──────────┤   1B80 ├──────────┤        │          │
      │ PT  32   │        │ не исп.  │        │          │
 1BA0 ├──────────┤        │          │        │          │
      │ не исп.  │        │          │        │          │
      │          │        │          │   1C00 ├──────────┤
      │          │        │          │        │ SCT 512  │
      │          │        │          │   1E00 ├──────────┤
      │          │        │          │        │ SAT 128  │
      │          │        │          │   1E80 ├──────────┤
      │          │        │          │        │ PT 32    │
      │          │        │          │   1EA0 ├──────────┤
      │          │        │          │        │ не исп.  │
 2000 ├──────────┤        │          │   2000 ├──────────┤
      │ CT 6144  │   2020 ├──────────┤        │ CT 6144  │
      │          │        │ PT 32    │        │          │
      │          │   2040 ├──────────┤        │          │
      │          │        │ не исп   │        │          │
 3800 ├──────────┤   3800 ├──────────┤   3800 ├──────────┤
      │ SGT 2048 │        │ SGT 2048 │        │ SGT 2048 │
 4000 ├──────────┤   4000 ├──────────┤   4000 ├──────────┤
      │ не исп.  │        │ не исп.  │        │ не исп.  │
20000 └──────────┘  20000 └──────────┘  20000 └──────────┘
```

```
        Screen 5,6          Screen 7,8

 0000 ┌──────────┐   0000 ┌──────────┐
      │ PNT 27136│        │ PNT 54272│
 6A00 ├──────────┤        │          │
      │ не исп.  │        │          │
 7400 ├──────────┤        │          │
      │ SCT 512  │        │          │
 7600 ├──────────┤        │          │
      │ SAT 128  │        │          │
 7680 ├──────────┤        │          │
      │ PT  32   │        │          │
 76A0 ├──────────┤        │          │
      │ не исп.  │        │          │
 7800 ├──────────┤        │          │
      │ SGT 2048 │        │          │
 8000 ├──────────┤        │          │
      │ СТРАН. 2 │        │          │
      │          │   D400 ├──────────┤
      │          │        │ не исп.  │
      │          │   F000 ├──────────┤
      │          │        │ SGT 2048 │
      │          │   F800 ├──────────┤
      │          │        │ SCT 512  │
      │          │   FA00 ├──────────┤
      │          │        │ SAT 128  │
      │          │   FA80 ├──────────┤
      │          │        │ PT 32    │
      │          │   FAA0 ├──────────┤
      │          │        │ не исп.  │
10000 ├──────────┤  10000 ├──────────┤
      │ СТРАН. 3 │        │ СТРАН. 2 │
18000 ├──────────┤        │          │
      │ СТРАН. 4 │        │          │
20000 └──────────┘        └──────────┘
```


### 7. Форматы дисковой памяти

Информация об организации хранения данных на диске и о том, как
этим пользоваться, необходима  для  правильного  доступа  к  диску
через  системные  вызовы  MSX-DOS.


#### 7.1. Единицы информации на диске

Диск имеет по 80 или 40 дорожек (треков) на  одной  стороне,  и
каждая из дорожек делится на 8 или 9  секторов  в  зависимости  от
формата диска. На компьютере "Ямаха" диск может быть односторонним
MF1-DD или двусторонним MF2-DD, имеет 80 дорожек, и  одна  дорожка
содержит 9 секторов по 512 байт каждый.

##### Сектора

MSX-DOS может работать с большим количеством типов носителей, в
том числе с 3.5-дюймовыми 2DD и с жесткими дисками. Для одинаковой
работы с  разными  носителями  системные  вызовы  рассматривают  в
качестве  основных   единиц   информации   "логические   сектора".
Логические сектора определяются номерами, идущими подряд,  начиная
с 0. Например:

```
                  сторона 1                       сторона 2

дорожка   0      1      2           79          1           80
сектор  ┌───┐  ┌───┐  ┌───┐       ┌───┐       ┌───┐       ┌───┐
  1     │ 0 │  │ 12│  │ 24│  ...  │58E│       │ 9 │  ...  │597│
        ├───┤  ├───┤  ├───┤       ├───┤       ├───┤       ├───┤
  2     │ 1 │  │ 13│  │ 25│  ...  │58F│       │ A │  ...  │598│
        ├───┤  ├───┤  ├───┤       ├───┤       ├───┤       ├───┤
  3     │ 2 │  │ 14│  │ 26│  ...  │590│       │ B │  ...  │599│
        ├───┤  ├───┤  ├───┤       ├───┤       ├───┤       ├───┤
         ...    ...    ...   ...   ...         ...   ...   ...
        ├───┤  ├───┤  ├───┤       ├───┤       ├───┤       ├───┤
  9     │ 8 │  │ 1A│  │ 2C│  ...  │596│       │ 11│  ...  │59F│
        └───┘  └───┘  └───┘       └───┘       └───┘       └───┘
```
Рис.7.1. Нумерация логических сектров на диске

В MSX-DOS все содержимое диска делится на 4 области  (см.  рис.
7.2).   Информация,  записываемая  на  диск,  хранится  в   части,
называемой  "областью  данных".   Информация,   используемая   для
управления работой с данными, хранится в трех  системных  областях
(BOOT, DIR, FAT). Загрузочный сектор располагается с сектора #0, а
остальные (FAT, каталог и область данных) варьируются  для  разных
носителей. Эти параметры указаны в DPB.

| Область диска             | Описание                                                |
|:--------------------------|:--------------------------------------------------------|
| Загрузочный (BOOT) сектор | Информация о носителе и программа запуска MSX-DOS       |
| FAT                       | Управляющая информация по структуре информации на диске |
| Каталог(DIR)              | Управляющая информация о файлах на диске                |
| Область данных            | Область для размещения файлов                           |
Рис.7.2. Содержимое диска

Первый сектор диска (с номером 0) содержит информацию о формате
диска и программу начальной загрузки. Далее идут одна или две (для
повышения надежности работы) таблицы размещения файлов (FAT - File
Allocation Table), каталог и сектора данных.

Например, на Ямахе номера секторов обычно распределяются так:

```
              загрузочный  FAT#1   FAT#2   каталог    данные
                сектор
   Диск:       ┌───────┬────────┬────────┬────────┬───────────┐
двусторонний   │   0   │ 1    3 │ 4    6 │ 7   0Dh│ 0Eh  59Eh │
               ├───────┼────────┼────────┼────────┼───────────┤
односторонний  │   0   │ 1    2 │ 3    4 │ 5   0Bh│ 0Ch  2CEh │
               └───────┴────────┴────────┴────────┴───────────┘
```


##### Кластеры

Если используются системные вызовы, можно,  как  описано  ниже,
рассматривать как основную единицу информации сектора. На самом же
деле информация на диске обрабатывается кластерами,  состоящим  из
нескольких секторов. Как будет описано ниже, кластеры обозначаются
последовательными номерами, начиная со второго, и  область  данных
начинается с  кластера  под  номером  #2.  Чтобы  узнать,  сколько
секторов  содержится  в  одном  кластере,  можно   воспользоваться
системной функцией 1Вh (запрос информации о диске).

Системная информация (каталог, FAT, FCB) о размещении данных на
диске указывается в кластерах. При использовании системных вызовов
для  доступа  к  информации  требуется  знать  соответствие  между
кластерами и секторами.

Поскольку  кластер  #2   и   первый   сектор   области   данных
располагаются в одном месте, расчет соответствия  можно  выполнить
следующим образом:

1. Обозначить номер данного кластера С.
2. Выяснить номер первого сектора области данных (прочитав DPB -
drive parameter block, блок параметров диска) и обозначить его S0.
3. Выяснить количество секторов в  одном  кластере  (с  помощью
функции 1Bh) и обозначить его n.
4. С   помощью  формулы      `S = S0 + (C-2) * n `     определить
соответствующий номер сектора.  Например,  для двустороннего диска
`S = 0Ah+(C-2)*2 = 6+2*C`.


#### 7.2. Загрузочный сектор и блок параметров драйвера

Загрузочный сектор является нулевым сектором диска  и  содержит
информацию о формате диска (байты  0-1Dh)  и  программу  начальной
загрузки MSX-DOS ( с байта 1Eh). 

В MSX-DOS блок параметров драйвера (DPB) для каждого  дисковода
размещается  в  рабочей  области  памяти.  В   него   записывается
информация,  относящаяся  к  каждому  дисководу.   MSX-DOS   может
работать с различными  типами  дисков,  и  потому  различия  между
носителями должны отражаться этой информацией.

Информация читается в DPB при запуске MSX-DOS  из  загрузочного
сектора диска. Между содержимым загрузочного сектора и DPB имеется
разница в расположении информации (см. рис. 7.3  и 7.5 ).

Для доступа к DPB используйте функцию 1Bh. Этот системный вызов
возвращает адрес DPB в памяти (BASE) и другую информацию  о каждом
дисководе, которая записана в загрузочном секторе.

```
    ┌────────────┐┐
00H │            ││
    │            │├──── 0E9h,XX,XX или 0EBh,XX,XX
    │            ││
    ├────────────┤│
03H │            ││
    │            ││
    │            ││
    │            │├──── Строка символов или OEM-имя
    │            ││              (YD-640)
    │            ││
    ├────────────┤│
0BH │            ││
    ├─          ─┤├──── размер сектора в байтах (200h)
0CH │            ││
    ├────────────┤┘
0DH │            │ ──── количество секторов в кластере(2)
    ├────────────┤┐
0EH │            ││
    ├─          ─┤│──── кол-во неиспользованых (резервных)
0FH │            ││     секторов (предшествующих FAT)  (1)
    ├────────────┤┘
10H │            │ ──── кол-во FAT'ов  (2)
    ├────────────┤┐
11H │            ││
    ├─          ─┤│──── максимальное кол-во файлов (70h)
12H │            ││
    ├────────────┤┤
13H │            ││
    ├─          ─┤│──── кол-во секторов на диск (5A0h)
14H │            ││
    ├────────────┤┘
15H │            │ ──── идентификатор (формат) носителя
    ├────────────┤┐                      (F9h)
16H │            ││
    ├─          ─┤│──── объем FAT'а в секторах (3)
17H │            ││
    ├────────────┤┤
18H │            ││
    ├─          ─┤│──── кол-во секторов на трек (9)
19H │            ││
    ├────────────┤┤
1AH │            ││
    ├─          ─┤│──── кол-во сторон диска (1 или 2)
1BH │            ││
    ├────────────┤┤
1CH │            ││
    ├─          ─┤│──── кол-во скрытых (невидимых) секторов
1DH │            ││
    ├────────────┤┤
1Eh │    ....    │├───  код программы начальной загрузки
    │            ││
```
Рис.7.3. Информация, хранимая в загрузочном (BOOT) секторе

| Media               | 0F8h | 0F9h | 0FAh | 0FBh | 0FCh | 0FDh | 0FEh | 0FFh |
|:--------------------|-----:|-----:|-----:|-----:|-----:|-----:|-----:|-----:|
| Имен на диске       |  112 |  112 |  112 |  112 |   64 |  112 |   64 |  112 |
| Секторов в FAT      |    2 |    3 |    1 |    2 |    2 |    2 |    1 |    1 |
| Секторов на трек    |    9 |    9 |    8 |    8 |    9 |    9 |    8 |    8 |
| Сторон на диске     |    1 |    2 |    1 |    2 |    1 |    2 |    1 |    2 |
| Треков на сторону   |   80 |   80 |   80 |   80 |   40 |   40 |   40 |   40 |
| Кол-во FATов        |    2 |    2 |    2 |    2 |    2 |    2 |    2 |    2 |
| Секторов в кластере |    2 |    2 |    2 |    2 |    1 |    2 |    1 |    2 |
Рис.7.4. Определение информации о диске по идентификатору носителя (media ID)

```
BASE
 └──►┌────────────┐
     │            │ ──── номер накопителя (индикатор дисковода
     ├────────────┤         не горит, если здесь записан ноль)
   +1│            │ ──── идентификатор (media ID)
     ├────────────┤┐
   +2│            ││
     ├─          ─┤├──── объем сектора
   +3│            ││
     ├────────────┤┘
   +4│            │ ──── маска директория (каталога)
     ├────────────┤
   +5│            │ ──── сдвиг директория
     ├────────────┤
   +6│            │ ──── маска кластера
     ├────────────┤
   +7│            │ ──── сдвиг кластера
     ├────────────┤┐
   +8│            ││
     ├─          ─┤├──── первый сектор FAT'а
   +9│            ││
     ├────────────┤┘
  +10│            │ ──── кол-во FAT'ов
     ├────────────┤
  +11│            │ ──── максимальное количество файлов
     ├────────────┤┐     (входов в каталог)
  +12│            ││
     ├─          ─┤├──── первый сектор области данных
  +13│            ││
     ├────────────┤┤
  +14│            ││
     ├─          ─┤├──── количество кластеров+1
  +15│            ││
     ├────────────┤┘
  +16│            │ ──── кол-во секторов для одного FAT'а
     ├────────────┤┐
  +17│            ││
     ├─          ─┤├──── первый сектор области каталога
  +18│            ││
     ├────────────┤┤
  +19│            ││
     ├─          ─┤├──── адрес FAT'а в памяти
  +20│            ││
     └────────────┘┘
```
Рис. 7.5. Структура DPB


#### 7.3. Каталог

Каталог диска (директорий, directory) состоит из записей.  Одна
запись каталога  имеет  длину  32  байта  и  содержит  имя  файла,
атрибуты файла,  дату  и  время  его  создания,  номер  начального
кластера (обратите на это внимание) и размер файла в  байтах  (см.
Рис.7.7).

Атрибуты   файла   в   каталоге   используются   для   указания
характеристик файла. Если  во втором  с  конца  бите  этого  байта
указана "1", к файлу будет запрещен доступ через системные  вызовы
(см. Рис.7.8). MS-DOS для компьютера IBM PC использует  в качестве
атрибута файла  еще один бит,  который  определяет  разрешение  на
запись, но этот атрибут MSX-DOS не поддерживает.

Дата и время записываются в два байта каждый, притом каждый  из
них разбит на три поля, как показано на рис. 7.9 и 7.10. Поскольку
для времени выделено только 5 бит, минимальная единица  времени  -
это две секунды. Год (с 1980 по 2079) определяется 7 битами  от  0
до 99.

Вся  эта  информация  записывается  в  область  каталога   (см.
Рис.7.6).  Расположение (начальный сектор) каталога записан в DPB.
Записи  каталога,  соответствующие  файлам,  в  нем  содержащимся,
образованы каждыми 32 байтами области каталога,  как  показано  на
Рис. 7.6.

Когда создается файл, на месте первой пустой записи формируется
соответствующая запись  каталога.  Стирание  файла  осуществляется
путем записи в первый байт соответствующей  записи  каталога  кода
E5h, который обозначает, что файл пуст.

Кроме этого, все элементы FAT  кластеров,  принадлежавших этому
файлу (см. FAT), при его стирании заполняются кодом 000.

```
        ┌────── 32 байта ───────┐

        ┌───────────────────────┐
  BASE─►│ MSXDOS.SYS    ...     │
        ├───────────────────────┤
     +32│ COMMAND.COM   ...     │
        ├───┬───────────────────┤   запись каталога, в которой
     +64│E5H│           ...     │◄─ первый байт равен E5H, в
        ├───┴───────────────────┤   данный момент не используется
     +96│ TEST          ...     │
        ├───────────────────────┤
            ...     ...    ...
            ...     ...    ...
            ...     ...    ...
        ├───┬───────────────────┤   запись каталога, первый байт
   +32*n│00H│                   │◄─ которой равен  00H, еще ни
        ├───┴───────────────────┤   разу не была использована
```
Рис.7.6. Организация области каталога

```
заголовок─►┌────────────┐┐
каталога   │            ││
           ├─          ─┤│
                         ├──── имя файла (8 символов)
                         │
         +7│            ││
           ├────────────┤┤
         +8│            ││
           ├─          ─┤│
         +9│            ││
           ├─          ─┤├──── расширение (3 символа)
        +10│            ││
           ├────────────┤┘
        +11│            │ ──── атрибут файла
           ├────────────┤┐
                         ├──── пространство для совместимости
                         │     с MS-DOS(MSX-DOS не используется
           ├────────────┤┤
        +22│            ││
           ├─          ─┤├──── время создания
        +23│            ││
           ├────────────┤┤
        +24│            ││
           ├─          ─┤├──── дата создания
        +25│            ││
           ├────────────┤┤
        +26│            ││
           ├─          ─┤├──── первый кластер файла
        +27│            ││
           ├────────────┤┤
        +28│            ││
           ├─          ─┤│
        +29│            ││
           ├─          ─┤├──── размер файла в байтах
        +30│            ││
           ├─          ─┤│
        +31│            ││
           └────────────┘┘
```
Рис.7.7. Структура каталога

```
      (11-й байт директория)
┌───┬───┬───┬───┬───┬───┬───┬───┐
│ . │ . │ . │ . │ . │ . │ * │ . │
└───┴───┴───┴───┴───┴───┴─┬─┴───┘
                          │ ┌── 0 : разрешить нормальный доступ
                          └─┤
                            └── 1 : запретить доступ
```
Рис. 7.8. Атрибут скрытости файла

```
  (23-й байт директория)│ (22-й байт директория)
┌──┬──┬──┬──┬──┬──┬──┬──┼──┬──┬──┬──┬──┬──┬──┬──┐
│h4│h3│h2│h1│h0│m5│m4│m3│m2│m1│m0│s4│s3│s2│s1│s0│
└──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴─────┴──┴──┘
└───────┬─────┘ └───────┬───────┘ └──────┬──────┘
  часы (0-23)     минуты (0-59)   секунды/2 (0-29)
```
Рис.7.9. Поле времени

```
 (25 байт директория)│   (24-й байт директория)
┌──┬──┬──┬──┬──┬──┬──┼──┬──┬──┬──┬──┬──┬──┬──┬──┐
│y6│y5│y4│y3│y2│y1│y0│m3│m2│m1│m0│d4│d3│d2│d1│d0│
└──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┘
└──────────┬────────┘ └────┬────┘ └──────┬──────┘
      год (0-99)      месяц (1-12)   день (1-31)
```
Рис.7.10. Поле даты

Если в первом байте записи каталога находится код  00,  то  это
означает, что эта запись еще не  использовалась  и  каталог дальше
чист.

Когда все записи  каталога  заполнены,  создание  новых  файлов
становится невозможным, даже если на диске  еще  много  свободного
места. Максимальное количество записей в каталоге, т.е. количество
файлов, которые можно создать на одном  диске,  также  записано  в
DPB.


#### 7.4. Таблица размещения файлов

В  MSX-DOS  единицей  хранения  информации  на  диске  является
кластер.   Файлы,   имеющие   размер   больше   одного   кластера,
записываются в несколько кластеров. В этом случае далеко не всегда
используются  кластеры,  расположенные  последовательно.  Особенно
после того, как  было  создано  и  уничтожено  большое  количество
файлов, кластеры, которые больше не  используются,  разбросаны  на
диске достаточно беспорядочно.

Если в такой ситуации создается большой файл, он разбивается на
несколько кластеров, которые  разбросаны  по  всем  освободившимся
областям диска. Информация, связывающая эти кластеры,  хранится  в
таблице размещения файлов (File Allocation Table, FAT).

Таблица  FAT  также  используется  для  записи  местонахождения
плохого кластера, чтобы к нему  больше  не  осуществлялся  доступ.
Информация о связи кластеров и о плохих кластерах  необходима  для
работы с  дисками.  Без  этой  информации  она  будет  невозможна.
Поэтому чтобы  предусмотреть  случай  ее  случайного  уничтожения,
хранится несколько идентичных экземпляров FAT.
   Рис. 7.11 показывает пример FAT. Первый  байт  называется  "FAT
ID",   который   содержит   число,   обозначающее   тип   носителя
(аналогичный идентификатору  носителя  в  таб.7.4.).  Следующие  2
байта содержат незначащую фиктивную информацию. С четвертого байта
(начальный  адрес+3)  начинается   действительная   информация   в
нерегулярном формате  по  12  бит  на  кластер.  Каждая  12-битная
область содержит информацию, которая называется записью FAT.
   Заметьте, что запись FAT начинается с  номера  2  (поскольку  и
кластеры  нумеруются  с  номера  2).  Количество  записей  в   FAT
соответствует количеству кластеров, на которые она указывает.

```
  FAT  Незнач.             Информация о размещении файлов
  ID   информ. 
│              │
├────┬────┬────┼────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬
│ FB │ FF │ FF │ 06 │ 00 │ 00 │ 02 │ F0 │ FF │ 07 │ F0 │ FF │ 3A │
└────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴
                └──┬──┘└───┬──┘└──┬──┘└───┬──┘└──┬──┘└───┬──┘└──┬─
 NN таблицы        ▼       ▼      ▼       ▼      ▼       ▼      ▼
 кластеров  ──►    2       3      4       5      6       7      8
```
Рис. 7.11. Пример FAT

Обратите внимание на то,  что  формат  записи  в  FAT  довольно
оригинален. Каждая последовательная группа  из трех байтов  задает
информацию о  двух  записях  FAT  (  и  соответствующих  кластерах
данных). Например, если мы имели последовательно записанные байты:
`... 1A 03 4C ...`
то это означает, что первая запись из них хранит номер записи  FAT
(кластера) 31Ah, а вторая - 4C0h.

Если   кластер   является   последним   кластером   файла,   то
соответствующий элемент FAT будет содержать FFFh. Например,  пусть
в директории указано, что начальный кластер файла имеет  номер  5.
Тогда по Рис. 7.11 можно сказать, что он является  и  единственным
("последним") кластером файла.

Другой пример. Если  начальный  кластер  файла  (в  директории)
имеет номер 4, то  по  Рис.7.11  можно  сделать  вывод,  что  файл
размещен последовательно в кластерах 4,2,6,7.

Элементы FAT, содержащие 000, соответствуют свободным кластерам
на диске. В нашем примере это кластер номер 3.


#### 7.5. Блок управления файлом

С помощью информации,  записанной  в  области  каталога,  можно
рассматривать данные в виде файла. Преимущество  этого  подхода  в
том,  что  расположение  информации  не  определяется   абсолютным
номером сектора или кластера; вместо этого файл можно использовать
посредством указания  его  имени.  Программисту  требуется  только
указать имя файла, и система  сделает  всю  работу  по  доступу  к
требуемому файлу.

Другими словами, программисту  не  требуется  знать,  например,
какие сектора занимает файл.  Здесь, кроме  каталога, важную  роль
играет блок управления файлом ( File Control Block - FCB).

FCB - это область для хранения информации, требуемой для работы
с файлами при использовании системных вызовов. Для работы с  одним
файлом требуется 37 байт памяти (см. рис. 7.12).  Хотя  FCB  может
располагаться в любом месте памяти, в MSX-DOS обычно  используется
адрес 005Ch.

```
0                             10                            20
   1  2  3  4  5  6  7  8  9     1  2  3  4  5  6  7  8  9
├──┼──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┐
│  │  │ имя и расширение файла      │     │     │разм. файла│
├▲─┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴──┴▲─┴──┴▲─┴──┴──┴──┴──┴──┘
 │                                   │     │
 д/в (=0 W>текущ, =1 ─>А:,...)       ┴     └─ Размер записи
                                     N тек.блока



                                      ┌─ Текущая запись
20                           30       │
   1  2  3  4  5  6  7  8  9     1  2 │3  4  5  6
┌──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬─▼┬──┬──┬──┬──┐
│ дата│время│  │  │     │     │     │  │        │  │
└──┴──┴──┴──┴▲─┴▲─┴▲─┴──┴▲─┴──┴▲─┴──┴──┴▲─┴──┴──┴──┘
ID устройства┘  │  │     │     │        │
Расположение в ─┘  │     │     │        └ N записи (прямой доступ)
каталоге           │     │     └ Посл.кластер, к кот. был доступ
                   │     │       относительно начала файла
Начальный кластер ─┘     └ Посл.кластер, к кот. был доступ
файла
```
Рис.7.12. Структура FCB

- __номер дисковода (00Н)__
Указывает  на  дисковод,  на  котором  расположен  файл.  (0  -
текущий, 1 - А:, 2 - В: ...)

- __имя файла (01h - 08h)__
Имя файла может содержать до 8  символов.  Если  в  нем  меньше
символов, остальные заполняются пробелами (20Н).

- __расширение (09h - 0Вh)__
Расширение может содержать до 3 символов.  Если  в  нем  меньше
символов, остальные заполняются пробелами (20Н).

- __текущий блок (0Ch - 0Dh)__
Указывает номер блока (количество блоков  от  начала  файла  до
текущего блока), к  которому  выполнялся  последовательный  доступ
(см. функции 14Н, 15Н).

- __размер записи (0Еh - 0Fh)__
Определяет размер единицы  информации  (записи)  в  байтах  для
одной операции чтения или записи (см. функции 14Н, 15Н, 21Н,  27Н,
28Н).

- __размер файла (10h - 13h)__
Указывает размер файла в байтах.

- __дата (14h - 15h)__
Указывает  дату  последней  записи  файла.  Формат   аналогичен
формату в каталоге.

- __время (16h - 17h)__
Указывает  время  последней  записи  файла.  Формат  аналогичен
формату в каталоге.

- __идентификатор устройства (18h)__

Когда периферийное устройство открыто в качестве файла, в  байт
идентификатора устройства записывается величина в  соответствии  с
таблицей 7.13. Для обычных дисковых файлов в этом поле  содержится
величина, равная 40h + номер  дисковода.  Например,  идентификатор
устройства  для   дисковода   А   равен   40h   (для   последующих
усовершенствований   в  прикладных  программах  не   рекомендуется
использовать байт идентификатора).

| Имя устройства  | Идентификатор устройства |
|:----------------|-------------------------:|
| CON (Консоль)   |                     0FFH |
| PRN (Принтер)   |                     0FBH |
| LST (List=PRN)  |                     0FCH |
| AUX (Auxiliary) |                     0FEH |
| NUL (Null)      |                     0FDH |
Табл.7.13. Идентификаторы устройств

- __расположение в каталоге (19h)__
Указывает номер  записи  в  каталоге,  соответствующий  данному
файлу.

- __начальный кластер (1Ah - 1Bh)__
Указывает начальный кластер файла.

- __последний кластер, к которому был доступ (1Ch-1Dh)__
Указывает на расположение кластера, к  которому  последний  раз
осуществлялся доступ.

- __последний кластер, относительно начала (1Eh-1Fh)__
Указывает на расположение кластера, к  которому  последний  раз
осуществлялся доступ, относительно первого кластера файла.

- __текущая запись (20h)__
Указывает   запись,   к   которой   осуществлялось    обращение
последовательным доступом.

- __запись прямого доступа (20h-24h)__
Определяет  запись,  к  которой  осуществлялся  доступ   прямым
доступом или прямым поблочным доступом. Eсли в поле размера записи
находится величина от 1 до 63, то потребуется все четыре байта  от
20h до 24h, а при использовании размера записи  больше  63   будут
использоваться только три байта от 20h до 23h  (см.  функции  14h,
15h, 21h, 22h, 27h, 28h).


### 8. Генераторы звука и шумов

Система MSX имеет три  типа  функций  вывода  звука,  однако  в
стандартной MSX устанавливаются только два первых:

- вывод звука программируемым звукогенератором (PSG), 3 канала,
8 октав;

- вывод  звука  однобитным  генератором  по  содержимому  порта
ввода/вывода;

- вывод звука при помощи MSX-AUDIO (генератор FM).

Программируемый    звукогенератор  PSG AY-3-8910   обеспечивает
воспроизведение шумов и звуков в трех  каналах  (голосах),  восьми
октавах и звук BEEP. Управление звукогенерацией осуществляется при
помощи регистров PSG.

Назначение регистров PSG приведено в Табл.8.1.

| Регистр | Назначение                                              |
|--------:|:--------------------------------------------------------|
|       0 | Младший байт частоты канала A                           |
|       1 | Четыре старших бита частоты канала A                    |
|       2 | Младший байт частоты канала B                           |
|       3 | Четыре старших бита частоты канала B                    |
|       4 | Младший байт частоты канала C                           |
|       5 | Четыре старших бита частоты канала C                    |
|       6 | Средняя частота шума (0..31)                            |
|       7 | Микширование звуков и шумов в каналах                   |
|       8 | Громкость канала A (0..15) или генератор огибающей (16) |
|       9 | Громкость канала B (0..15) или генератор огибающей (16) |
|      10 | Громкость канала C (0..15) или генератор огибающей (16) |
|      11 | Младший байт периода волны (огибающей)                  |
|      12 | Старший байт периода волны (огибающей)                  |
|      13 | Код формы волны (огибающей)                             |
|      14 | Порт ввода/вывода A                                     |
|      15 | Порт ввода/вывода B                                     |
Табл. 8.1. Назначение регистров PSG

Звукогенератор имеет два регистра (14,15) - порта ввода/вывода,
которые не используются  для  генерации  звуков,  а  подключены  к
джойстику, планшету, мыши.

Частота  звучания  звука  в  некотором  канале  (A,  B  или  C)
определяется  содержимым  соответствующей  пары регистров ( в диа-
пазоне 0..4095 ) по следующей формуле:

```
1789772.5 Гц
──────────── = значение в регистрах для канала A, B или C
 16╟частота
```

По этой же формуле определяется значение для записи  в  регистр
"средней  частоты"  шума.  Она  может   находиться   в   диапазоне
3.6 kHz .. 111.9 kHz. Поскольку на три канала имеется только  один
звукогенератор, одинаковый шум воспроизводится по трем каналам.

За различные сочетания (микширование) звука и  шума  на  каждом
канале отвечает седьмой регистр PSG (Рис.8.1).

```
         Порты I/O         Шум               Звук
Порт/   ┌─────────┐ ┌───────────────┐ ┌───────────────┐
Канал:    A     B     C     B     A     C     B     A
       ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
Рег.7: │  1  │  0  │  X  │  X  │  X  │  X  │  X  │  X  │
       └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
Бит:      7     6     5     4     3     2     1     0
```
Рис.8.1. Содержимое седьмого регистра PSG

Биты 6 и 7 не влияют на звук. Они используются для  определения
направления передачи данных через  порты  ввода/вывода  PSG.  Ноль
означает ввод, единица - вывод.

Знак X означает, что бит может  иметь  значение  1  (запрещение
звука или шума) или 0 (разрешение звука или шума).

Если  в  регистре  установки  громкости  (8,  9,  10)  записано
значение 16, то звук  в  этом  случае  контролируется  генератором
огибающей.  Значения  в  диапазоне  0..15   определяют   громкость
соответствующего канала.

Имеется только  один  генератор  огибающей,  у  которого  можно
выбрать форму и частоту модуляции ( или период волны ) огибающей.

Частота  огибающей   (период   волны)   кодируется   содержимым
регистров 11 и 12 по следующей формуле:

```
1789772.5 Гц
──────────── = значение в регистрах 11 и 12.
 256╟период
```

Минимальное значение частоты равно 0.107 Гц (период 9.4  сек.),
а максимальное оценивается около 6991.3 Гц.

Одну из заранее заданных форм огибающей можно выбрать, задав  4
младших бита регистра 13 (Рис.8.2).

```
         │
  00XX  ─┘     ─────────────────────────────


              │
  01XX  ─     └─────────────────────────────


         │
  1000  ─┘    ╟    ╟    ╟    ╟    ╟    ╟   ╟


         │
  1001  ─┘    ╟─────────────────────────────

                   ╟         ╟         ╟        ╟
         │
  1010  ─┘    ╟         ╟         ╟        ╟



  1011        ┌───────────────────────────────
              │



  1100        │    │    │    │    │    │



  1101        ──────────────────────────────────

        ─

              ╟         ╟         ╟         ╟
  1110
        ─          ╟         ╟         ╟         ╟



  1111  ─     └───────────────────────────────────
```
Рис.8.2. Установка формы волны

Работа звукового генератора управляется  процессором  Z80A  при
помощи портов ввода-вывода (Табл. 8.2).

| Порт | Назначение                            │
|-----:|:--------------------------------------|
|  A0h | Номер регистра PSG для записи числа   | 
|  A1h | Число для записи в отмеченный регистр |
|  A2h | Последнее число, записанное в PSG     |
Табл. 8.2. Порты PSG

При программировании звукогенерации можно либо прямо обращаться
к этим портам, либо  вызывать  подпрограммы  BIOS.  Примеры  таких
программ даны во второй нашей книге.

Для  воспроизведения  музыкальных   звуков   необходимо   уметь
переходить от обозначения нот к частотам звуков.

Таблица 8.3 поможет Вам при моделировании оператора PLAY  языка
MSX-BASIC в машинных кодах (данные приведены для канала  A).  Нота
будет  звучать  до  тех  пор,  пока   не   будет   выключен   звук
соответствующего канала или громкость звучания.

В  дополнение  к  звукогенератору  PSG  MSX  имеет   еще   один
звукогенератор.  Это  достаточно   простое   устройство,   которое
генерирует звук при включении/выключении бита 7 порта ввода/вывода
PPI (адрес AAh).

```
      ┌───────┬────┬─────┬─────┐     ┌───────┬────┬─────┬─────┐
      │Октава │Нота│Рег.0│Рег.1│     │Октава │Нота│Рег.0│Рег.1│
      ├───────┼────┼─────┼─────┤     ├───────┼────┼─────┼─────┤
      │       │ C  │  93 │ 13  │     │       │ C  │ 214 │  0  │
      │  O1   │ C# │ 156 │ 12  │     │  O5   │ C# │ 202 │  0  │
      │       │ D  │ 231 │ 11  │     │       │ D  │ 190 │  0  │
      │(контр-│ D# │  60 │ 11  │     │ (вто- │ D# │ 180 │  0  │
      │октава)│ E  │ 155 │ 10  │     │  рая) │ E  │ 170 │  0  │
      │       │ F  │   2 │ 10  │     │       │ F  │ 160 │  0  │
      │       │ F# │ 115 │  9  │     │       │ F# │ 151 │  0  │
      │       │ G  │ 235 │  8  │     │       │ G  │ 143 │  0  │
      │       │ G# │ 107 │  8  │     │       │ G# │ 135 │  0  │
      │       │ A  │ 242 │  7  │     │       │ A  │ 127 │  0  │
      │       │ A# │ 128 │  7  │     │       │ A# │ 120 │  0  │
      │       │ B  │  20 │  7  │     │       │ B  │ 113 │  0  │
      ├───────┼────┼─────┼─────┤     ├───────┼────┼─────┼─────┤
      │       │ C  │ 175 │  6  │     │       │ C  │ 107 │  0  │
      │  O2   │ C# │  78 │  6  │     │  O6   │ C# │ 101 │  0  │
      │       │ D  │ 244 │  5  │     │       │ D  │  95 │  0  │
      │ (боль-│ D# │ 158 │  5  │     │ (тре- │ D# │  90 │  0  │
      │  шая) │ E  │  78 │  5  │     │  тья) │ E  │  85 │  0  │
      │       │ F  │   1 │  5  │     │       │ F  │  80 │  0  │
      │       │ F# │ 186 │  4  │     │       │ F# │  76 │  0  │
      │       │ G  │ 118 │  4  │     │       │ G  │  71 │  0  │
      │       │ G# │  54 │  4  │     │       │ G# │  67 │  0  │
      │       │ A  │ 249 │  3  │     │       │ A  │  64 │  0  │
      │       │ A# │ 192 │  3  │     │       │ A# │  60 │  0  │
      │       │ B  │ 138 │  3  │     │       │ B  │  57 │  0  │
      ├───────┼────┼─────┼─────┤     ├───────┼────┼─────┼─────┤
      │       │ C  │  87 │  3  │     │       │ C  │  53 │  0  │
      │  O3   │ C# │  39 │  3  │     │  O7   │ C# │  50 │  0  │
      │       │ D  │ 250 │  2  │     │       │ D  │  48 │  0  │
      │(малая)│ D# │ 207 │  2  │     │ (чет- │ D# │  45 │  0  │
      │       │ E  │ 167 │  2  │     │  вер- │ E  │  42 │  0  │
      │       │ F  │ 129 │  2  │     │  тая) │ F  │  40 │  0  │
      │       │ F# │  93 │  2  │     │       │ F# │  38 │  0  │
      │       │ G  │  59 │  2  │     │       │ G  │  36 │  0  │
      │       │ G# │  27 │  2  │     │       │ G# │  34 │  0  │
      │       │ A  │ 253 │  1  │     │       │ A  │  32 │  0  │
      │       │ A# │ 224 │  1  │     │       │ A# │  30 │  0  │
      │       │ B  │ 197 │  1  │     │       │ B  │  28 │  0  │
      ├───────┼────┼─────┼─────┤     ├───────┼────┼─────┼─────┤
      │       │ C  │ 172 │  1  │     │       │ C  │  27 │  0  │
      │  O4   │ C# │ 148 │  1  │     │  O8   │ C# │  25 │  0  │
      │       │ D  │ 125 │  1  │     │       │ D  │  24 │  0  │
      │ (пер- │ D# │ 104 │  1  │     │(пятая)│ D# │  22 │  0  │
      │  вая) │ E  │  83 │  1  │     │       │ E  │  21 │  0  │
      │       │ F  │  64 │  1  │     │       │ F  │  20 │  0  │
      │       │ F# │  46 │  1  │     │       │ F# │  19 │  0  │
      │       │ G  │  29 │  1  │     │       │ G  │  18 │  0  │
      │       │ G# │  13 │  1  │     │       │ G# │  17 │  0  │
      │       │ A  │ 254 │  0  │     │       │ A  │  16 │  0  │
      │       │ A# │ 240 │  0  │     │       │ A# │  15 │  0  │
      │       │ B  │ 227 │  0  │     │       │ B  │  14 │  0  │
      └───────┴────┴─────┴─────┘     ├───────┴────┼─────┼─────┤
                                     │(шестая)  - │  13 │  0  │
                                     └────────────┴─────┴─────┘
```
Табл. 8.3. Кодирование частот нот


### 9. Часы и энергонезависимая память

Для  хранения  и  отсчета  времени  система  MSX-2   использует
интегральную часовую схему CLOCK-IC на  батарейках.  Кроме  этого,
она используется и для хранения в энергонезависимой памяти пароля,
приветствия, типа экрана и другой информации.


##### Функции микросхемы CLOCK-IC

- __Функции часов__: установка,  чтение,  отсчет  даты  и  времени,
шкалы 24/12-ти часового времени, учет количества дней в  месяце  и
году.

- __Функции будильника__:  генерация   сигнала    при   достижении
установленного времени.

- __Функции памяти на батарейках__: 26 устройств 4-х битной  памяти
хранят параметры  настройки  высоты/ширины  CRT-экрана,  начальные
значения параметров SCREEN, WIDTH, COLOR, громкости и  типа  звука
сигнала BEEP, цвет и приветствие титульного  экрана,  код  страны,
пароль, подсказку (prompt) для MSX-BASICа.


##### Структура схемы CLOCK-IC

Схема CLOCK-IC имеет в себе четыре блока. Каждый  блок  состоит
из 13-ти 4-х битных регистров, которые имеют  адреса  с  0  по  12
(Рис.9.1, 9.2, 9.3). Кроме  этого,  имеются  еще  три  4-х  битных
регистра для выбора блока или функций управления. Они имеют номера
с 13 по 15.

Из регистров с 0 по 12 и регистра режима (MODE) 13 можно читать
информацию, можно  также  и  записывать  данные  в  эти  регистры.
Регистры  теста  (TEST)   14   и   переустановки   (RESET)   могут
использоваться только для записи.

```
              Блок 0                           Блок 1

     Содержимое        Код              Содержимое        Код

  ┌────────────┐   ┌─────────┐       ┌────────────┐   ┌─────────┐
0 │ секунды-1  │   │ X X X X │       │            │   │ 0 0 0 0 │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
1 │ секунды-2  │   │ 0 X X X │       │            │   │ 0 0 0 0 │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
2 │ минуты-1   │   │ X X X X │       │ минуты-1   │   │ X X X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
3 │ минуты-2   │   │ 0 X X X │       │ минуты-2   │   │ 0 X X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
4 │ часы-1     │   │ X X X X │       │ часы-1     │   │ X X X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
5 │ часы-2     │   │ 0 0 X X │       │ часы-2     │   │ 0 0 X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
6 │ день недели│   │ 0 X X X │       │ день недели│   │ 0 X X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
7 │ день-1     │   │ X X X X │       │ день-1     │   │ X X X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
8 │ день-2     │   │ 0 0 X X │       │ день-2     │   │ 0 0 X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
9 │ месяц-1    │   │ X X X X │       │            │   │ 0 0 0 0 │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
10│ месяц-2    │   │ 0 0 0 X │       │ 12/24 часа │   │ 0 0 0 X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
11│ год-1      │   │ X X X X │       │ Висок. год │   │ 0 0 X X │
  ├────────────┤   ├─────────┤       ├────────────┤   ├─────────┤
12│ год-2      │   │ X X X X │       │            │   │ 0 0 0 0 │
  └────────────┘   └─────────┘       └────────────┘   └─────────┘
    <------->       <------->          <------->       <------->
     4 бита           4 бита            4 бита          4 бита
```
Рис.9.1. Блоки 0 и 1 (часы и будильник)

```
                           Блок 2

Биты:   3              2              1             0
  ┌────────────────────────────────────────────────────────┐
0 │                            ID                          │
  │────────────────────────────────────────────────────────┤
1 │                  коррекция X (-8..+7)                  │
  │────────────────────────────────────────────────────────┤
2 │                  коррекция Y (-8..+7)                  │
  │─────────────┬──────────────┬─────────────┬─────────────┤
3 │             │              │ тип интерф. │  тип экрана │
  │─────────────┴──────────────┴─────────────┴─────────────┤
4 │                ширина экрана (младшие биты)            │
  │────────────────────────────────────────────────────────┤
5 │                ширина экрана (старшие биты)            │
  │────────────────────────────────────────────────────────┤
6 │                   цвет изображения                     │
  │────────────────────────────────────────────────────────┤
7 │                       цвет фона                        │
  │────────────────────────────────────────────────────────┤
8 │                     цвет бордюра                       │
  │─────────────┬──────────────┬─────────────┬─────────────┤
9 │ скорость    │ тип принтера │ звук клавиш │ включ./выкл.│
  │ кассет.магн.│              │             │ функ. клавиш│
  │─────────────┴──────────────┼─────────────┴─────────────┤
10│         тип BEEP           │      громкость  BEEP      │
  │────────────────────────────┼───────────────────────────┤
11│                            │         цвет титула       │
  │────────────────────────────┴───────────────────────────┤
12│                       код страны                       │
  └────────────────────────────────────────────────────────┘
```
Рис.9.2. Блок 2 (настройка)

```
                          Блок 3

        ID=0               ID=1               ID=2

   ┌────────────┐     ┌────────────┐      ┌────────────┐
0  │     0      │     │     1      │      │     2      │
   ├────────────┤     ├────────────┤      ├────────────┤
1  │ 1-й символ │     │ Исп. ID=1  │      │ 1-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
2  │  титула    │     │ Исп. ID=2  │      │ подсказки  │
   ├────────────┤     ├────────────┤      ├────────────┤
3  │ 2-й символ │     │ Исп. ID=3  │      │ 2-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
4  │  титула    │     │ Пароль     │      │ подсказки  │
   ├────────────┤     ├────────────┤      ├────────────┤
5  │ 3-й символ │     │ Пароль     │      │ 3-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
6  │  титула    │     │ Пароль     │      │ подсказки  │
   ├────────────┤     ├────────────┤      ├────────────┤
7  │ 4-й символ │     │ Пароль     │      │ 4-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
8  │  титула    │     │ Флаг клавиш│      │ подсказки  │
   ├────────────┤     ├────────────┤      ├────────────┤
9  │ 5-й символ │     │ Значение кл│      │ 5-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
10 │  титула    │     │ Значение кл│      │ подсказки  │
   ├────────────┤     ├────────────┤      ├────────────┤
11 │ 6-й символ │     │ Значение кл│      │ 6-й символ │
   ├─          ─┤     ├────────────┤      ├─          ─┤
12 │  титула    │     │ Значение кл│      │ подсказки  │
   └────────────┘     └────────────┘      └────────────┘
```
Рис.9.3. Блок 3 (настройка)


##### Функции регистра режима (MODE)

- __Выбор блока__:
Два  младших  бита  регистра  MODE  (M1,M0)  используются   для
указания блока перед чтением/записью в  регистры  0..12.  Регистры
13..15 доступны при любых значениях MODE.

- __Включение/выключение будильника__:
Переключение  бита  2  регистра  MODE  (AE)  включает/выключает
будильник. Однако нужно иметь  в  виду,  что  MSX-2  будильник  не
поддерживает.

- __Завершение подсчета времени__:
Запись нуля в бит 3  выключает  счет  секунд, и  функция  часов
останавливается. Запись единицы возобновляет счет.

```
            ┌────┬────┬────┬────┐
Регистр 13  │ TE │ AE │ M1   M0 │
            └────┴────┴────┴────┘
```

##### Функции регистра теста (TEST)

Регистр теста 14 используется для быстрого увеличения  верхнего
счетчика и для подтверждения того,  что  дата  и  время  считаются
правильно.  Установка  в  единицу  каждого  бита  этого   регистра
означает прямую установку пульса 2^14 (=16384 Hz) в  счетчики  дня
(D), часа (H), минуты (M), секунды (S).

```
             ┌───┬───┬───┬───┐
Регистр  14  │ D │ H │ M │ S │
             └───┴───┴───┴───┘
```


##### Функции регистра переустановки (RESET)

- __Переустановка будильника__:
Установка в единицу бита 0 (AR)  вызывает  сброс  в  ноль  всех
регистров будильника.

- __Точная установка секунд__:
Установка в единицу бита 1 (CR) означает сброс дробей секунд.

- __Включение/выключение пульса часов__:
Установка в единицу бита 2 (C16) означает выход пульса 16 Hz, а
запись нуля в бит 3 (C1) - 1 Hz. Система MSX-2 эти возможности  не
поддерживает.

```
           ┌─────┬─────┬─────┬─────┐
Регистр 15 │ C1  │ C16 │ CR  │ AR  │
           └─────┴─────┴─────┴─────┘
```

##### Установка часов, будильника и дополнительной информации

Дата и  время  хранятся  в  блоке  0  (Рис.9.1),  значения  для
будильника - в блоке 1. Секунды для будильника не устанавливаются.
Когда времена часов и будильника совпадают, ничего не происходит.

В часах год представляется двумя цифрами (регистры 11 и 12).  В
MSX-BASICe эти две последние цифры года увеличиваются на 80. Таким
образом год 0 означает календарный год 1980.

День недели имеет значения 0..6.  Соответствие  между  реальным
днем недели и этим числом не определено.

Регистр 10 блока 1 используется для выбора между 12-ти  и  24-х
часовой шкалами времени. Шкала 12 часов устанавливается, когда бит
0 сброшен в 0, а шкала 24 часа - когда он установлен в 1.

Если установлен режим 24-х часового времени, то бит 1  регистра
5 блока 0 определяет время дня - до полудня или после.

Когда оба младших бита регистра 11  блока  1  равны  нулю,  это
означает високосный год, в котором  февраль  имеет  29  дней.  При
выполнении оператора SET DATE в MSX-BASICe эти  биты  определяются
делением года нацело на 4.

В качестве дополнительной памяти используются блоки 2 и  3.  Их
содержимое представлено на Рис.9.2, 9.3. Блок 3 имеет три функции,
зависящие от значения ID  (регистр  0).  Это  значение  определяет
различную   интерпретацию   содержимого   (поэтому   одновременная
установка приветствия титула, пароля и подсказки невозможна).


### 10. Интерфейс с кассетным магнитофоном

Кассетные накопители на магнитных лентах -  это  самые  дешевые
устройства внешней памяти, доступные на MSX. Знания об  интерфейсе
с кассетными устройствами необходимы для правильной работы с  ними
на языке ассемблера.

##### Скорость передачи информации

MSX использует две скорости передачи информации  при  работе  с
кассетами. В режиме BASICa по умолчанию  устанавливается  скорость
1200 bps. Вторая возможная скорость  -  2400  bps  (  при  меньшей
надежности записи).

##### Кодирование одного бита

Один бит данных, основа ввода/вывода на кассету, кодируется как
показано на Рис.10.1. Ширина импульса  подсчитывается  при  помощи
учета количества Т-состояний  процессора,  поэтому  при  работе  с
кассетным магнитофоном все прерывания запрещены.

Бит данных с кассеты может быть прочитан из седьмого бита порта
B общецелевого интерфейса ввода/вывода (регистр 15 PSG).

```
┌───────────┬──────┬────────────────────────────────────────┐
│ Скорость  │  Бит │             Форма волны                │
│ передачи  │      │                                        │
├───────────┼──────┼────────────────────────────────────────┤
│           │      │   |           |           |            │
│           │   0  │   |           ┌───────────┐            │
│           │      │   |           │           │  1200Hz×1  │
│   1200    │      │   |───────────┘           └            │
│    бод    ├──────┼────────────────────────────────────────┤
│           │      │   |     |     |           |            │
│           │   1  │   |     ┌─────┐     ┌─────┐            │
│           │      │   |     │     │     │     │  2400Hz×2  │
│           │      │   |─────┘     └─────┘     └            │
├───────────┼──────┼────────────────────────────────────────┤
│           │      │   |     |     |           |            │
│           │   0  │   |     ┌─────┐           |            │
│           │      │   |     │     │           |  2400Hz×1  │
│   2400    │      │   |─────┘     └           |            │
│    бод    ├──────┼────────────────────────────────────────┤
│           │      │   |  |  |     |           |            │
│           │  1   │   |  ┌──┐  ┌──┐           |            │
│           │      │   |  │  │  │  │           |  4800Hz×2  │
│           │      │   |──┘  └──┘  └           |            │
└───────────┴──────┴────────────────────────────────────────┘
                       |  |  |     |           |
                       ◄───────────────────────►──────────
                       |  |  |     |               2983 T
                       |  |  |     |              (833 msec)
                       ◄───────────►──────────
                       |  |  |        1491 T (417 msec)
                       ◄─────►───────────
                       |  |    746 T (208 msec)
                       ◄──►────────
                       |  | 373 T (104 msec)
```
Рис.10.1. Кодирование одного бита


##### Кодирование одного байта

Один байт  данных  кодируется  последовательностью  битов,  как
показано на Рис.10.2, то есть одиннадцатью битами.

```
      LSB                         MSB
─┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─
 │ 0 │ X │ X │ X │ X │ X │ X │ X │ X │ 1 │ 1 │ 
─┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─
 └─┬─┘└───────────────┬─────────────┘└───┬───┘
Стартовый          Данные             Конечные
   бит                                  биты
```
Рис.10.2. Кодирование одного байта

##### Кодирование заголовка

Заголовок (header) - это группа сигналов  специальной  частоты,
записанных на ленте, которая используется для стабилизации ленты и
определения скорости передачи  информации  после  начала  движения
ленты или для разделения двух файлов. В первом случае используется
"длинный" заголовок, во втором - "короткий".

```
┌────────────┬────────────┬──────────────────────────┐
│ Скорость   │  Заголовок │  Представление заголовка │
│ передачи   │            │                          │
├────────────┼────────────┼──────────────────────────┤
│            │   Длинный  │  2400Hz×16000 ( ў6.7 sec)│
│  1200 бод  ├────────────┼──────────────────────────┤
│            │   Короткий │  2400Hz× 4000 ( ў1.7 sec)│
├────────────┼────────────┼──────────────────────────┤
│            │   Длинный  │  4800Hz×32000 ( ў6.7 sec)│
│  2400 бод  ├────────────┼──────────────────────────┤
│            │   Короткий │  4800Hz× 8000 ( ў1.7 sec)│
└────────────┴────────────┴──────────────────────────┘
```
Рис.10.3. Представление заголовков


##### Форматы файлов на магнитной ленте

MSX-BASIC поддерживает три типа форматов  файлов  на  магнитной
ленте  -  внутренний  формат  программ  на  MSX-BASICe,  текстовый
формат, двоичный формат.


##### Файлы программ на языке MSX-BASIC

Программы на языке BASIC записываются  в этом двоичном  формате
командой CSAVE (Рис.10.4).

```
        Заголовок файла                   Тело файла
               │                               │
┌──────────────┴───────────────┐┌──────────────┴───────────────┐
┌──────────┬────────┬───────────┬──────────┬───────────┬───────┐
│ Длинный  │ D3h×10 │ Имя файла │ Короткий │ MSX-BASIC │ 00h×7 │
│ заголовок│        │           │ заголовок│ программа │       │
└──────────┴────────┴───────────┴──────────┴───────────┴───────┘
   6.7 sec   10 байт   6 байт     1.7 sec    Любая длина  7 байт
```
Рис.10.4. Двоичный BASIC-формат


##### Файлы текстов в коде ASCII

В этом формате программы на языке BASIC  записываются  командой
SAVE. Кроме этого, в  коде  ASCII  записываются  файлы,  созданные
при помощи команды OPEN. Формат представлен на Рис.10.5.

```
        Заголовок файла                   Тело файла
               │                               │
┌──────────────┴───────────────┐┌──────────────┴───────────────┐
┌──────────┬────────┬───────────┬──────────┬───────────┬──
│ Длинный  │ EAh×10 │ Имя файла │ Короткий │   Блок 1  │  ...
│ заголовок│        │           │ заголовок│           │  ...
└──────────┴────────┴───────────┴──────────┴───────────┴──
   6.7 sec   10 байт   6 байт     1.7 sec     256 байт
```
Рис.10.5. Текстовый файл в коде ASCII

Тело файла в этом формате состоит из  произвольного  количества
блоков по 256 байт,  перед  каждым  из  которых  имеется  короткий
заголовок. В последний блок должен быть включен код CTRL/Z (EOF).


##### Файлы машинных кодов

Машинные коды записываются на  ленту  командой  BSAVE.  В  теле
файла  записываются  начальный,  конечный   и   стартовый   адреса
программы в  кодах.  Поэтому  длина  файла  может  быть  вычислена
автоматически и  специальная  отметка  конца  файла  на  ленте  не
хранится.

```
       Заголовок файла                Тело файла
            │                             │
┌───────────┴──────────┐┌─────────────────┴─────────────────────┐
┌─────────┬──────┬──────┬─────────┬────────┬──────┬──────┬──────┐
│Длинный  │D0h×10│ Имя  │Короткий │Начальн.│Конечн│Старт.│Тело  │
│заголовок│      │ файла│заголовок│адрес   │адрес │адрес │прогр.│
└─────────┴──────┴──────┴─────────┴────────┴──────┴──────┴──────┘
   6.7 sec 10 байт 6 байт  1.7 sec  2 байта 2 байта 2 байта  ...
```
Рис.10.6. Двоичный BASIC-формат


### 11. Клавиатура

Имеется несколько модификаций клавиатур  MSX  -  международная,
американская,   японская,   русифицированная   и   т.д.    Матрица
клавиатуры,  используемая  на  наших  компьютерах,   приведена   в
Приложении 1.

Каждая строка матрицы  (один  байт)  определяет  статус  восьми
клавиш ("кнопок"). Одиннадцать строк матрицы  задают  статус  всех
клавиш клавиатуры в каждый конкретный момент времени.

Если некоторый бит оказался сброшен в ноль,  то  это  означает,
что в данный момент нажата соответствующая  клавиша.  Если  нажато
одновременно несколько клавиш, то будет сброшено в ноль  несколько
соответствующих битов.

Система MSX опрашивает (сканирует)  матрицу  клавиатуры  каждые
1/60 сек., используя прерывания от таймера. Если нажата  некоторая
клавиша  (или  клавиши),  то  формируется  код   символа,   и   он
записывается в кольцевой буфер клавиатуры KEYBUF (FBF0h)  размером
в 40 байт. Буфер имеет два указателя - [PUTPNT], который указывает
на место в буфере, куда нужно записать очередной введенный символ,
и [GETPNT], указывающий на  символ,  который  можно  прочитать  из
буфера.

Таким  образом,  на  нижнем  уровне   в   системе   MSX   можно
осуществлять  ввод  кодов  нажатых  клавиш  путем  опроса  матрицы
клавиатуры, а на более высоком уровне - ввод  кода  символа  путем
чтения из буфера. Имейте в виду, что запрет прерываний от  таймера
делает почти все стандартные процедуры ввода бесполезными.


### 12. Интерфейс с принтером

Интерфейс с  принтером  поддерживается  подпрограммами  BIOS  и
MSX-BASICом. MSX  управляет  принтером  при  помощи  восьмибитного
порта вывода с использованием сигналов BUSY (занят) и  STROBE.  На
Рис.12.1 показаны сигнальные линии интерфейса принтера [11,12].

```
┌────┬────┬────┬────┬────┬────┬────┐
│  7 │  6 │  5 │  4 │  3 │  2 │  1 │     1    - STROBE
└────┴────┴────┴────┴────┴────┴────┘     2..9 - данные
┌────┬────┬────┬────┬────┬────┬────┐     11   - BUSY
│ 14 │ 13 │ 12 │ 11 │ 10 │  9 │  8 │
└────┴────┴────┴────┴────┴────┴────┘
```
Рис.12.1. Интерфейс MSX-принтера


Данные передаются через порт  91h.  При  записи  сигнал  STROBE
передается  через  нулевой  бит  порта  90h,  при  чтении  принтер
сообщает через первый бит порта 90h о своей занятости  (BUSY)  или
готовности (READY).

Принтер NL-10 имеет интерфейс со скоростью передачи  данных  от
1000 до 6000 символов в  секунду.  Он  подключается  к  компьютеру
36-разъемным  соединителем,  который   соответствует   соединителю
Amphenol 57-30360. Функции разъемов приведены в Табл. 12.1.

```
┌────┬────────────┬─────┬──────────────────────────────────────┐
│  N │ Имя сигнала│ Напр│          Функция                     │
├────┼────────────┼─────┼──────────────────────────────────────┤
│  1 │ STROBE     │ IN  │ Сигнал готовности чтения данных      │
├────┼────────────┼─────┼──────────────────────────────────────┤
│  2 │ DATA1      │ IN  │ Данные: 1 - HIGH, 0 - LOW            │
│    │ ...        │     │   ...       ...       ...            │
│  9 │ DATA8      │ IN  │ Данные: 1 - HIGH, 0 - LOW            │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 10 │ ACK        │ OUT │ Подтверждение получения данных (LOW) │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 11 │ BUSY       │ OUT │ Готовность получения данных (LOW)    │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 12 │ PAPER OUT  │ OUT │ Индикация отсутствия бумаги (HIGH)   │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 13 │ SELECTED   │ OUT │ Принтер ON-LINE (HIGH)               │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 16 │ SIGNAL GND │     │ Заземление                           │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 17 │ CHASSIS GND│     │ Заземление                           │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 18 │ +5VDC      │ OUT │ Питание                              │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 19 │ GND        │     │ Заземление                           │
│    │  ...       │     │                                      │
│ 30 │ GND        │     │ Заземление                           │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 31 │ RESET      │ IN  │ Перезагрузка (LOW)                   │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 32 │ ERROR      │ OUT │ Состояние ошибки (LOW)               │
├────┼────────────┼─────┼──────────────────────────────────────┤
│ 33 │ EXT GND    │     │ Внешнее заземление                   │
└────┴────────────┴─────┴──────────────────────────────────────┘
```
Табл.12.1.Функции разъемов

Разъем 1 несет сигнал STROBE от  компьютера  к  принтеру.  Этот
сигнал  обычно  держится  компьютером  на  высоком  уровне.  Когда
компьютер  хочет  передать  данные  принтеру,  он   понижает   его
по крайней мере  на  0.5  mcs.  Когда  принтер  обнаруживает  этот
сигнал, он начинает читать данные от компьютера с  разъемов  2..9.
Каждая из этих линий несет один бит информации.  Компьютер  должен
поддерживать эти сигналы по меньшей мере  за  0.5  mcs  до  подачи
сигнала STROBE и 0.5 mcs - после.

Если принтер успешно получил  байт  данных  от  компьютера,  он
понижает уровень сигнала ACK примерно на 9 mcs.

Сигнал BUSY сообщает компьютеру, что принтер  в  данный  момент
занят. Он устанавливается на высоком уровне при получении  данных,
когда принтер отключен или когда возникла ошибка.

Кроме  этого,  принтер  сообщает  компьютеру,  что  закончилась
бумага сигналом PAPER OUT, что он готов получать данные - сигналом
SELECTED, что произошла ошибка - сигналом ERROR.

При   получении   от   компьютера   сигнала    RESET    принтер
перезагружается.

Стандартный   MSX-принтер   может   печатать   любые   символы,
отображаемые   на   экране.   Специальные   графические   символы,
соответствующие символам с кодами N=01..1Fh могут быть  напечатаны
посылкой кода 40h+N после кода графического заголовка - 01h.

При выводе на языке ассемблера можно использовать и специальные
управляющие коды, список  которых  приводится  в  документации  по
принтеру. Например, для прогона строки на  MSX-принтере   выведите
последовательно  символы  с  кодами  0Dh  и  0Ah.  Для   рисования
графических  образов  (растровой   графики)   можно   использовать
ESC-последовательности  ESC+"B"  (не   делать   промежутки   между
линиями),  ESC+"Snnnn"+n  кодов  (вывод  графических  образов)   и
другие.


### 13. Универсальный интерфейс ввода/вывода

Как было сказано выше, звукогенератор, используемый MSX,  имеет
два восьмибитных порта ввода/вывода, порт A и порт  B.  В  системе
MSX эти два порта связаны с универсальным интерфейсом ввода/вывода
(порт джойстика) и используются для обмена  данными  с  джойстиком
или графическим планшетом (paddle). Различные устройства,  которые
могут  быть  подключены  к  этому  интерфейсу  (сенсорный   экран,
световое перо, мышь, трекбол-кот) имеют  необходимые  подпрограммы
BIOS в ROM. На Рис.13.1 приведена схема универсального  интерфейса
и связи с портами.

```
   Универсальный интерфейс 1        Универсальный интерфейс 2

┌─────────────────────────────┐   ┌─────────────────────────────┐
│ (1)   (2)   (3)   (4)   (5) │   │ (1)   (2)   (3)   (4)   (5) │
│  │ (6) │ (7) │ (8) │ (9)    │   │  │ (6) │ (7) │ (8) │ (9)    │
└──┼──┼──┼──┼──┼──┼──┼────────┘   └──┼──┼──┼──┼──┼──┼──┼────────┘
   │  │  │  │  │  │  │               │  │  │  │  │  │  │
   │  │  │  │  │  └┐ │ ┌───────────┐ │  │  │  │  │  └┐ │
   └──┴──┴──┴──┴───┼─┴─┤ Переключа-├─┴──┴──┴──┴──┴───┼─┘
                  ┌┘   │   тель    ├────────────┐   ┌┘
                  │    └┬─┬─┬─┬─┬─┬┘  Сигнал    │   │
                  │     │ │ │ │ │ │   переключе-│   │
                  │     7 6 4 3 2 1    ния      │   │
                  │     │ │ │ │ │ │             │   │
                  │     │ │ │ │ │ └─────────┐   │   │
                  │     │ │ │ │ └───────┐   │   │   │
      ┌───────────┘     │ │ │ └─────┐   │   │   │   │
      │                 │ │ └───┐   │   │   │   │   │
      │                 │ └─┐   │   │   │   │   │   │
      │       ┌───┬───┬─┴─┬─┴─┬─┴─┬─┴─┬─┴─┬─┴─┐ │   │
      │       │ 7 │ 6 │ 5 │ 4 │ 3 │ 2 │ 1 │ 0 │ │   │
      │       └───┴───┴───┴───┴───┴───┴───┴───┘ │   │
      │                   Порт А                │   │
      │                                         │   │
      │                         ┌───────────────┘   │
      │                         │   ┌───────────────┘
      │                       ┌─┼───┼─┐
      └───────────────────────┘ │   │ └─┐
                          ┌───┬─┴─┬─┴─┬─┴─┬───┬───┬───┬───┐
                          │ 7 │ 6 │ 5 │ 4 │ 3 │ 2 │ 1 │ 0 │
                          └───┴───┴───┴───┴───┴───┴───┴───┘
                                          Порт B
```
Рис.13.1. Схема универсального интерфейса T19 и связи с портами ввода/вывода PSG

Разъемы 5 подключены к питанию +5V, разъемы 9 -  к  заземлению.
Бит 7 порта А используется при вводе данных с кассетной ленты, бит
7 порта B управляет индикатором арабских знаков, биты 0..3 порта В
не используются.

Схема для джойстика приведена на Рис.13.2. Как следует из  этой
схемы,  установка  в  ноль  восьмого  терминала  дает  возможность
получать информацию о стике и  кнопке  триггера,  читая  терминалы
1..4 и 6..7.

```
(1)  ─────────    ──────┐     Вперед
                        │
(2)  ─────────    ──────┤     Назад
                        │
(3)  ─────────    ──────┤     Влево
                        │
(4)  ─────────    ──────┤     Вправо
                        │
(6)  ─────────    ──────┤     Триггер А
                        │
(7)  ─────────    ──────┤     Триггер B
                        │
(8)  ───────────────────┘
```
Рис.13.2. Схема подключения джойстика



### ЗАКЛЮЧЕНИЕ

На этом мы закончим рассмотрение архитектуры компьютера  MSX-2.
Часть вопросов и некоторые детали не вошли в это учебное  пособие,
кое-что   Вы   сможете   более   подробно   узнать,    внимательно
ознакомившись с  приложениями.  Для  полного овладения  материалом
рекомендуется  выполнить  достаточное  количество  упражнений   по
программированию работы с  устройствами  этого  микрокомьютера  на
языке ассемблера.

Описание  языка  ассемблера  и  примеры   программ   управления
компьютером MSX-2 приведены во втором  нашем  учебном  пособии  по
работе в системе MSX-2.


### ЛИТЕРАТУРА

1. Бедрековский М.А., Кручинкин Н.С., Подолян В.А. Микропроцессоры. - М., Радио и связь. 1981.
2. Буреев Л.Н. и  др.  Простейшая  микро-ЭВМ:  Проектирование. Наладка. Использование.- М.: Энергоатомиздат. 1989. 216 с.
3. Локальная сеть: версия 3.0. Руководство. YAMAHA Corp. Japan. 02.88. 120 c.
4. МикроЭВМ. - М.: Энергоиздат, 1982.
5. Радио. 1982. NN 9 - 12.
6. Радио. 1988. NN 11,12.
7. Радио. 1989. NN 1-4.
8. Рафикузаман М. Микропроцессоры и машинное проектирование микропроцессорных систем. Кн.1. М.: Мир. 1988.
9. Справочное руководство по языку программирования MSX-BASIC для комплектов учебной вычислительной техники на базе персональных компьютеров "Ямаха MSX-2". 03.88. YAMAHA Corp. Japan. 474 c.
10. Черемных С.В. и др. От микропроцессоров к персональным ЭВМ.- М.: Радио и связь. 1988. 288 с.
11. MSX Interface Cartridge  for  NL-10.  Users  Manual.- Star Micronics Co., Ltd. Japan. 134 p.
12. MSX-2 Technical Handbook. ASCII Corporation. 400 p.
13. Schiller E. Computerwissen fuer alle.- Leipzig: VEB Fachbuchverlag. 1988. 232 S.
14. YAMAHA personal computer YIS503IIR/IIIR. Technical Summary. YAMAHA Corp. Hamamatsu, Japan. 07.87. 101 p.


### СВЕДЕНИЯ ОБ АВТОРАХ


##### ФАХРУТДИНОВ Кирилл Ильнурович

кандидат физико-матем. наук, заведующий кафедрой информатики
Дальневосточного университета, научный руководитель Центра
компьютерных технологий обучения

690010 Владивосток, Октябрьская, д.27, кк. 129, 332, кафедра и лаборатория информатики

690090 Владивосток, 25 Октября, д.65, к. 338


##### БОЧАРОВ Игорь Иванович

ведущий программист Центра компьютерных технологий обучения,
член Экспертной комиссии по программному обеспечению при
Координационном Совете по компьютеризации школ
Приморского края

690002 Владивосток, Московская, д.15, кв. 30


### ПРИЛОЖЕНИЕ 1. РАБОЧИЕ ОБЛАСТИ BDOS И BIOS

В  рабочей  области  системы  MSX  (MSX-2)  хранятся   значения
переменных,  используемых  интерпретатором  и   редактором   языка
MSX-BASIC. Программы  на  языке  BASIC  и  подпрограммы  на  языке
ассемблера могут использовать  эти  переменные  самыми  различными
способами [9,12]. В скобках дается содержимое ячейки по-умолчанию.

**CONTINUE FROM HERE**

                      Рабочая область BDOS
───────────────────────────────────────────────────────────────
Адрес Длина           Содержимое
───────────────────────────────────────────────────────────────
             Фрагменты рабочей области дискового обмена 

005C 16 По этому адресу COMMAND.COM организует FCB 1 файла, имя
        которого соответствует  второму слову  командной строки
006C    По этому адресу COMMAND.COM организует FCB 2 файла, имя
        которого соответствует третьему слову командной строки
E595    Область FAT дисковода A
EB95    Зона системных секторов (часть директории)
ED95    Буфер дисковода
F1BF    Буфер данных для программы записи сектора на диск (MSX 1)
F1C5  4 (=буфер+6) номер логического дисковода, которому прина-
        длежит текущая дискета
F1C9    Программа   вывода   строки    (DE-адрес,    остается
        подключенным дисковое ПЗУ) 
F1D9    Подпрограмма  переброски  ОЗУ:  откл.  драйвер,  LDIR,
        подключ.драйвер, RET
F1E2    Переход по адресу в ОЗУ:  отключ.  DRIVER,  JP (F1E6);
        (F1E6)=0
F1EB    CALL в  ОЗУ,  ([HL])=  адрес  вызываемой  подпрограммы,
        возврат в драйвер
F1F4  3 JP 5604h - Вызов драйвера из драйвера (используется для
        перехода в драйвере)
F1F7    Названия устройств DB 'PRN LST NUL AUX CON'
F20B    Имя устройства, найденное драйвером при  распознавании
        устройства (Пример: DB 'PRN')
F216    Атрибуты файла (PRN=-5, LST=-4, NUL=-3, AUX=-2, CON=-1)
F221  2 Время создания
F223    Дата создания
F22B 12 Таблица числа дней в каждом месяце
F22F    Не 0, если надо сохранить на диске содержимое
F237    Координата курсора X для системных функций
F23C    =0 , если директорию из памяти на диск сохранять не надо
F23D    Адрес обмена, устанавливаемый функцией 1Ah (BDOS или Disk
        BASIC), адрес DMA. В этой ячейке хранится адрес обмена
        информацией. Операцию:
            LD   C,1AH
            LD   DE,ADRESS
            CALL 5
        можно заменить просто на:
            LD HL,ADRESS 
            LD (F23DH),HL
        и адрес обмена информацией будет установлен.
F23F    Номер сектора в буфере дисковода
F241  1 Номер диска, сектор которого в буфере дисковода
F242  1 =0, если не надо сохранить сектор из буфера дисковода
F243  2 Адрес DPB сектора в буфере дисковода 
F245  1 Номер страницы оглавления, находящейся в памяти
F246  1 Номер диска, часть директории которого находится в памяти
F247  1 Номер текущего логического дисковода (0 - A)
F248  1 Текущее число
F249  1 Текущий месяц
F24A  1 Текущий год
F24C  2 DATE, т.е. количество прожитых дней
F24E  2 День недели

                       Дисковые ловушки

F24F    Вывод сообщения "Insert  diskette  for  drive..."
        (глубина 1), в А - номер дисуковода (А='А', 'B',...)
F252  3 Проход по FAT (I: DE - адрес FAT, HL -  кластер;
        О: HL - следующий кластер, A = [H] or [L] ) 
F255  3 Поиск имени в F2B9 в именах устройств
F258  3 Поиск вхождения файла 
F25B  3 Поиск файла в директории, позиция которого = А
F25E  3 Переход к следующему файлу
F261  3 Проверка наличия дисковода (I: A -  номер  дисковода
        (0 - текущий, 1 - 'А'); О: А=(F2E1) )
                              65  

F264  3 Заполнение FCB из DEF (I: HL - DEF, DE - FCB; O: DE─
        новый FCB) 
F267  3 Проверка смены дисковода, в IX адрес DPB (ловушка
        дисковода 44DB)
F26A  3 Вычисление адреса DPB текущего диска (I:(F2E1))
F26D  3 Запись FAT на диск
F270  3 Чтение сектора,  B  -  количество  секторов,  DE  -
        стартовый сектор, HL - адрес DMA, IX - адрес DPB
F273  3 Вызов подпрограмы  обработки   дисковых   ошибок
        (см.F323)
F276  3 Запись сектора директории на диск. Параметры: (F245)
        и (F246)
F279  3 Запись сектора, B - кол-во секторов, DE - стартовый
        сектор, HL - адрес DMA, IX - адрес DPB 
F27C  3 Умножение ( I: DE, BC; O: [HLBC]=DE x BC )
F27F  3 Деление ( I:  HL,  DE,  BC;  O:  BC=[HLBC]  div  DE,
        HL=[HLBC] mod DE )
F282  3 Нахождение BC-го кластера файла
F285  3 Прихождение по FAT (I: HL - первый кластер,  BC  -
        количество; O: HL - найденный кластер, DE - счетчик)
F288  3 Переход к следующему сектору с пересылкой данных из
        буфера дисковода в DMA
F28B  3 Переход к следующему сектору с пересылкой данных из
        DMA в буфер дисковода
F28E  3 Чтение данных
F291  3 Проверка совпадения записанного в DMA с  количеством
        записей в памяти
F294  3 Переход к следующей записи (?)
F297  3 Обработки ошибки
F29A  3 Записи данных
F29D  3 Переход к последнему  сектору  и  сохранения  длины
        файла в FCB
F2A0  3 Выделение максимального числа идущих подряд секторов
        (I:HL - первый кластер, BC - количество; O:A - количество
        секторов, DE - первый кластер )
F2A3  3 Перевод номера кластера в номер сектора
F2A6  3 Для резервирования BC кластеров в FAT BC секторов,
        первый в HL
                              66  

F2A9  3 Очистка кластеров в FAT (Enter:  HL  -  первый кластер,
        BC -  номер кластера, на  который  будет указывать  HL,
        Return: HL)
F2AC  3 Ввод символа с клавиатуры функцией 0Ah
F2AF  3 Вывод символа  на  экран  из  [A]  и  изменения
        координаты курсора по X
F2B2  3 Опрос даты и времени (задание даты из F33B, если в
        F338 - 0), возвращает в DE время, в BC - дату
        (см. драйвер 5496)
F2B5  3 Определение, високосный ли год

                  Рабочие ячейки

F2B8  1 Номер элемента директории
F2B9 11 Место, где располагается имя первого файла при работе
        драйвера
F2C4  1 Подобно F2E1, но при этом ( 0-текущий, 1-A, 2-B )
        (Драйвер из FCB )
F2C5 11 Место, где располагается имя второго файла при работе
        драйвера
F2D0 11 Место, где располагается имя третьего файла при работе
        драйвера
F2DC  1 Флаг =0 при определении диска
F2DD  1 Номер сектора в кластере ( 0-первый, 1-второй )
F2DE    =1, если была ошибка
F2E1  1 Номер диска,  с  которым  производится  операция  (0-A,
        1-B) (используется только драйвером)
F2E2  2 Адрес конца DMA после конца работы
F2E4  4 Запись прямого доступа
F2E8  2 Количество записей, которые нужно читать
F2EA  2 Текущий кластер ( абсолютный )  [ относительный  во
        время заполнения]
F2EC  2 Текущий кластер ( относительный)
F2EE  2 Номер текущего сектора
F2F0  2 Число секторов в файле
F2F2  2 Смещение относительно начала буфера дисковода ( указывает
        на данные в секторе )
F2F4  4 Запись прямого доступа X размер записи - номер байта для
        чтения
F2F8  5 Количество байтов, которые надо читать в текущем секторе
                              67  

F2FC  2 Количество оставшихся для чтения секторов
F2FE  1 Номер первого пустого элемента директории ( FF - нет )
F2FF  1 Какая операция с диском производилась последней
        ( для F323 ), 0 - чтение, 1 - запись сектора
F300  2 При работе с устройствами -  адрес,  откуда  брать
        следующее данное ( 1 байт )
F302  4 Число кластеров + 1 ( из DPB )
F306  1 =0, если у файла размер записи <> 0
F307  5 Адрес FCB с параметрами для поиска
F30B  1 Номер элемента, найденный последним  поиском  вхождения,
        FF, если его нет
F30C  1 Сохраняет байт, следующий сразу за расширением имени
        файла из FCB ( см. драйвер 5667h )
F30D  1 При обращении к функции 2E BDOS'а с нулем в [E]
        записывает  0 в эту ячейку (бит верификации)
F30E  1 <> 0, если символ в имени файла > или = 80h и < или =  BAh
        заменяется символом из таблицы с адреса драйвера 5696h
        ( см. драйвер 5631h )
F30F    4 байта из BIOS с адреса 2B
F323  2 Адрес таблицы адресов подпрограмм обработки дисковых ошибок
        (в A - номер дисковода (0,1,..), в C - код ошибки)
F325  2 Указывает на слово памяти, где лежит адрес подпрограммы
        обработки CTRL+STOP или RST 0
F327  2 Адрес перехода по CTRL/STOP ( рестарт DOS)
F329  2 Загружает в [A] признак конца файла и делает RET
        ( LD A,26; RET )
F331  5 Вызов функций Disk Basic'а
F336  1 Не 0, если был служебный символ ( если был, то он в F337)
F337  1 Код служебного символа (см. F336 )
F338  1 =0, если задается новая дата через (F33B)
F339  2 В данной ячейке находится адрес стека, который сохраняется
        всякий раз, когда происходит работа с подрограммами  ПЗУ.
        После окончания работы MSXDOS.SYS  производит  рестарт  с
        восстановлением стека
F33B  5 Если в (F338) 0, то из этого слова задается новая дата
        ( дата в прожитых днях )
F340  1 Не 0, если загружалась система (при выходе в Basic
        не пишет Enter Date) = F3h
F341  1 Слот ОЗУ 1-ой страницы (NxxxSSPP)
F342  1 Слот ОЗУ 2-ой страницы (NxxxSSPP)
                              68  

F343  1 Слот ОЗУ 3-ей страницы (NxxxSSPP)
F344  1 Слот ОЗУ 4-ой страницы (NxxxSSPP)
F345  1 Максимальное количество файлов для Basic'а
F346  1 Флаг загрузки системы (CALL SYSTEM)=FFh (равняется
        нулевому байту бут-сектора)
F347  1 Общее количество  дисководов  (  [F247]<[F347]) 0, если
        такие отсутствуют, 1, если только 'A:',2, если 'A:' и 'B:'
F348  1 Приоритетный слот драйвера дисковода, адрес слота
        Disk BASICа
F349  2 Начало зоны дисковода 
F34B  2 Конец памяти для системы, начало рабочей области BDOS
F34D  2 Вершина памяти после первого резервирования памяти  по
        1 * (F6AB) байт 
F34F  2 Вершина памяти после второго резервирования памяти  по
        2 * (F6AB) байт для адреса буфера дисковода (0ED95h)
F351  2 Вершина памяти после третьего резервирования памяти  по
        3 * (F6AB) байт для части директории, хранящйся в памяти
        (0EB95h)
F353  2 В Basic'е - начало памяти , где находится FCB файлов 
F355  2 Адрес DPB дисковода A:
F357  2 Адрес DPB дисковода B:
F359  2 Адрес DPB дисковода C:
F35B  2 Адрес DPB дисковода D:
F35D  2 Адрес DPB дисковода A:
F35F  2 Адрес DPB дисковода B:
F361  2 Адрес DPB дисковода C:
F363  2 Адрес DPB дисковода D:

                     Дисковые подпрограммы

F365  3 Подпрограмма Driver 5FE7 ( ? Возвращает в [A] номер слота,
        откуда вызывалась ловушка )
F368  3 Подпрограмма подключения слота драйвера дисковода.
        Организует подключение 1 страницы из слота  3-1, а значит,
        делает доступным прямое (CALL... или  JP...)  обращение  к
        подпрограммам работы с диском.  Указатель  слота,  который
        использует данная подпрограмма, находится в ячейке F248H,и
        он может быть заменен на любой другой указатель,  а  тогда
        первая страница будет выбрана из другого слота
                              69  

F36B  3 Подпрограмма отключения слота драйвера дисковода.
        Организует подключение 1 страницы из слота  3-2,а  значит,
        делает доступным прямое (CALL... или  JP...)  обращение  к
        Вашим подпрограммам.  Указатель  слота,который  использует
        данная подпрограмма , находится в ячейке F242H, и он может
        быть заменен на  любой  другой  указатель,а  тогда  первая
        страница будет выбрана из другого слота 
F36E  3 Подпрограмма перемещения  участка   памяти   в   ОЗУ   при
        подключенном слоте драйвера дисковода
F371  3 Возвращает в A символ-признак конца файла (26), т.е.
        JP F327
F374  3 Подпрограмма (RET) (JP F32C)
F377  3 JP nn \ Переход на 
F37A  3 JP nn / резидента
F37D  3 Вызов функций Disk BASIC'а (JP F331), команда перехода к
        MSX-DISK BASIC
───────────────────────────────────────────────────────────────

                        РАБОЧАЯ ОБЛАСТЬ

───────────────────────────────────────────────────────────────
Адрес Дл. Имя         Содержимое
───────────────────────────────────────────────────────────────
                    Подпрограммы на машинном языке, которые
                      используются для межслотовых вызовов

F380 5  RDPRIM  программа  чтения из основного слота (basic slot),
                читать примитив:
                       OUT  (0A8),A  ; А - карта слота: aabbccdd
                       LD   E,(HL)   ; HL - адрес чтения
                       JR   WRPRM1   ; D -карта текущего слота
                возвращает в Е прочитанный байт
F385 7  WRPRIM  программа записи  в  основной  слот  (basic slot),
                записать примитив
                           OUT  (0A8),A  ; A - карта слота
                           LD   (HL),E   ; HL - адрес записи
                   WRPRM1: LD   A,D      ; D - карта текущ. слота
                           OUT  (0A8),A  ; Е - записываемый байт
                           RET
                              70  

F38C 14 CLPRIM  вызов основного слота, вызов примитива
                           OUT  (0A8),A  ; A - карта слота
                           EX   AF,AF'   ; IX - адрес подпрогр.
                           CALL CLPRM1   ; A' - знач.A для подпр.
                           EX   AF,AF'   ; (SP) - карта тек.слота
                           POP  AF
                           OUT  (0A8),A
                           EX   AF,AF'
                           RET
                   CLPRM1: JP   (IX)

                        Рабочие ячейки

F39A 20 USRTAB  адрес   таблицы  адресов вызываемых  функций  USR,
                по  2   байта  на  10  функций  (0..9).  Исходное 
                значение - FCERR (475Ah)
F3AE 1  LINL40  длина строки ( 39,40 ), SCREEN 0
F3AF 1  LINL32  длина строки ( 29,31 ), SCREEN 1
F3B0 1  LINLEN  ширина    экрана,   устанавливается    без    его 
                очистки (29)
F3B1 1  CRTCNT  количество строк на экране (24)
F3B2 1  CLMLST  интервал  между столбцами для оператора PRINT (14)
           адреса таблиц SCREEN 0
F3B3 2  TXTNAM  адрес таблицы имен PNT (0000h)
F3B5 2  TXTCOL  Width 40 - не используется, width 80 - адрес CT
F3B7 2  TXTCGP  адрес таблицы генератора шаблонов PGT (0800h)
F3B9 2  TXTATR  = 0, не используется
F3BB 2  TXTPAT  = 0, не используется
           SCREEN 1
F3BD 2  T32NAM  адрес таблицы имен PNT (1800h)
F3BF 2  T32COL  адрес таблицы цветов CT (2000h)
F3C1 2  T32CGP  адрес таблицы генератора шаблонов PGT (0)
F3C3 2  T32ATR  адрес таблицы атрибутов спрайтов SAT (1B00h)
F3C5 2  T32PAT  адрес таблицы шаблонов спрайтов  SGT (3800h)
          SCREEN 2
F3C7 2  GRPNAM  адрес таблицы имен PNT (1800h)
F3C9 2  GRPCOL  адрес таблицы цветов CT (2000h)
F3CB 2  GRPCGP  адрес таблицы генератора шаблонов PGT (0)
F3CD 2  GRPATR  адрес таблицы атрибутов спрайтов SAT (1B00h)
F3CF 2  GRPPAT  адрес таблицы шаблонов спрайтов SGT (3800h)
                              71  

          SCREEN 3
F3D1 2  MLTNAM  адрес таблицы имен PNT (0800h)
F3D3 2  MLTCOL  = 0, адрес таблицы цветов CT
F3D5 2  MLTCGP  адрес таблицы генератора шаблонов PGT (0)
F3D7 2  MLTATR  адрес таблицы атрибутов спрайтов SAT (1B00h)
F3D9 2  MLTPAT  адрес таблицы  шаблонов спрайтов SGT (3800h)
F3DB 1  CLICKSW отзвук клавиши (0-нет отзвука)
F3DC 1  CSRY    строка текстового курсора (1)
F3DD 1  CSRX    колонка текстового курсора (1)
F3DE 1  CNSDFG  отображение текста функциональных клавиш
                ( 0 - отображение)
F3DF 1  RG0SAV  регистр 0 VDP (0)
F3E0 1  RG1SAV  регистр 1 VDP (E0h)
         ...
F3E6 1  RG7SAV  регистр 7 VDP (0)
F3E7 1  STATFL  хранит статус VDP, регистр статуса 0 (0)
F3E8 1  TRGFLG  фиксирует статус клавиши пробел и кнопки триггера
                джойстика (FFh)
F3E9 1  FORCLR  цвет текста (15)
F3EA 1  BAKCLR  цвет фона (4)
F3EB 1  BRDCLR  цвет бордюра (7)
F3EC 3  MAXUPD  JMP $CODE, переход  на  0, используется оператором
                CIRCLE
F3EF 3  MINUPD  JMP $CODE, переход  на  0, используется оператором
                CIRCLE
F3F2 1  ATRBYT  код цвета для пикселя в графике (15)

                   Рабочая область для PLAY

F3F3 2  QUEUES  адрес таблицы очередей QUETAB (F959h)
F3F5 1  FRCNEW  используется интерпрeтатором BASIC. Равна 0 при
                CLOAD, иначе - 255

                   Рабочая область для ввода клавиш

F3F6 1  SCNCNT  ключ развертки синхронизации, интервал
                сканирования клавиш (1)
F3F7 1  REPCNT  задержка до начала автоповторения клавиши (50)
F3F8 2  PUTPNT  указатель  буфера клавиатуры  для  записи символов
                (FBF0h)
                              72  

F3FA 2  GETPNT  указатель  буфера  клавиатуры  для взятия символов
                (FBF0h)

                     Параметры для кассеты

F3FC 10 CS120   параметры 5*2 ввода/вывода кассеты
                для 1200 BAUD:
                   LOW01 (53h),HIGH01 (5Ch),LOW11 (26h),
                   HIGH11 (2Dh), HEDLEN *2/256 (0Fh)
                для 2400 BAUD
                   LOW02 (25h), HIGH02 (2Dh), LOW12 (0Eh),
                   HIGH12 (16h), HEDLEN *4/256 (1Fh)

F406 2  LOW     параметр для кассеты, устанавливается SCREEN
F408 2  HIGH    длительность  0, 1, и ..., устанавливается SCREEN
F40A 1  HEADER  заголовок
F40B 2  ASPCT1  отношение 256/сторону (aspect), устанавливается
                SCREEN для  CIRCLE
F40D 2  ASPCT2  отношение 256*сторону (aspect), устанавливается
                SCREEN для CIRCLE
F40F 5  ENDPGM  фиктивный    конец    программы   для    оператора
                RESUME NEXT (":")
F414 1  ERRFLG  номер последней ошибки
F415 1  LPTPOS  позиция головки принтера (0)
F416 1  PRTFLG  флаг выдачи: 1 - на принтер MSX, 0 -на экран
F417 1  NTMSXP  0 - для принтера MSX, иначе - не MSX
F418 1  RAWPRT  если  1 - табуляция, иначе печать пробела
F419 2  VLZADR  значимая функция; адрес символа, заменяемого   VAL
F41B 1  VLZDAT  символ, заменяемый нулем функцией VAL
F41C 2  CURLIN  номер строки, которую выполняет в текущий момент
                BASIC. Если непосредственный оператор - FFFFh
F41E 1          префикс начала оператора BASIC'a - ':'
F41F 318 KBUF   скоростной буфер клавиатуры (CRUNCH),транслируется
                в промежуточный язык из BUF
F55D 1  BUFMIN  запятая для команды ввода INPUT 
F55E 258  BUF   Буфер  клавиатуры - логическая  строка.  Непосред-
                ственный    оператор    в  коде  ASCII выполняется
                отсюда. Ввод уничтожает BUF
F660 1  ENDBUF  конец   буфера,  предотвращает   переполнение  BUF
                              73  

F661 1  TTYPOS  позиция  на   терминале,   виртуальный  курсор для
                BASICа
F662 1  DIMFLG  флаг массива, BASIC
F663 1  VALTYP  указывает тип переменной в DAC
F664 0  OPRTYP  тип  оператора. Записывает  номер  оператора перед
                применением оператора
F664 1  DORES   указывает, может ли записанное слово быть
                "crunched"
F665 1  DONUM   флаг для скоростной работы (crunch)
F666 2  CONTXT  сохранение  указателя  текста  для  выбора символа
                для CHRGET после сканирования констант
F668 1  CONSAV  сохранить токен для константы, внутренняя  форма
                константы  после выбора символа CHRGET
F669 1  CONTYP  тип сохраненной константы
F66A 8  CONLO   значение  сохран. константы  (после вызова CHRGET)
F672 2  MEMSIZ  вершина памяти (начало ОЗУ пользователя)
F674 2  STKTOP  возможная вершина стека, BASIC
F676 2  TXTTAB  адрес PIT (начало текста BASIC программы),
                не меняется по INIT
F678 2  TEMPPT  указатель  на  первый  свободный  временный  деск-
                риптор
F67A 30 TEMPST  временные   дескрипторы,  описатели  для   NUMTEMP
F698 3  DSCTMP  дескриптор   ответа  строковой  функции, описатель
                строки
F69B 2  FRETOP  верхний    адрес   неиспользованного    строкового
                пространства
F69D 2  TEMP3   временная  переменная  для  сбора мусора  функцией
                USR
F69F 2  TEMP8   временная  переменная  для  сбора мусора  функцией
                USR
F6A1 2  ENDFOR  указатель на конец оператора FOR (для следующего
                выполнения тела цикла)
F6A3 2  DATLIN  номер строки оператора DATA, читаемого READ
F6A5 1  SUBFLG  рабочий флаг для FOR и USR для массивов
F6A6 1  FLGINP  рабочий флаг для INPUT и READ
F6A6 0  USFLG   флаг
F6A7 2  TEMP    временная переменная для кода операции
F6A9 1  PTRFLG  = 0, если не программная строка
F6AA 1  AUTFLG  = 0, если режим AUTO (автоматический)
                              74  

F6AB 2  AUTLIN  текущий номер строки для AUTO или длина сектора
                при начальном резервировании
F6AD 2  AUTINC  инкремент  AUTO,  увеличение   номера строки  (10)
F6AF 2  SAVTXT  указатель текста, в  основном для оператора RESUME
F6B1 2  SAVSTK  область сохранения указателя стека при появлении
                ошибок
F6B3 2  ERRLIN  номер строки, в которой была ошибка
F6B5 2  DOT     номер  последней  строки, которая была изображена
                на экране или введена
F6B7 2  ERRTXT  указатель   текста   для    RESUME, где  произошла
                ошибка
F6B9 2  ONELIN  номер   строки    начала  подпрограммы   обработки
                ошибок (ON ERROR GOTO)
F6BB 1  ONEFLG  = 1, если происходит обработка ошибок
F6BC 2  TEMP2   временная память
F6BE 2  OLDLIN  номер    строки,    установленный   при    нажатии
                CTRL/STOP, STOP, END   или  выполненной  последней
F6C0 2  OLDTXT  текстовый   указатель  на оператор, который должен
                выполняться следующим
F6C2 2  VARTAB  адрес  конца  текста  программы,  начальный  адрес
                переменных, NEW устанавливает TXTTAB + 2
F6C4 2  ARYTAB  начальный    адрес   таблицы  массивов  переменных
F6C6 2  STREND  конец   памяти   пользователя  в  текущий   момент
F6C8 2  DATPTR  текстовый    указатель   в   оператор   DATA   для
                выполнения READ
F6CA 26 DEFTBL  тип   по умолчанию  для   каждой  буквы  скалярных
                переменных

                Работа с параметрами функций пользователя

F6E4 2  PRMSTK  адрес предыдущего блока в стеке, для сбора мусора
F6E6 2  PRMLEN  длина таблицы, число блоков в строке
F6E8 PRMSIZ PARM1 таблицы параметров для функций, определяемых
                пользователем (100)
F74C 2  PRMPRV  указатель предыдущего блока параметров
F74E 2  PRMLN2  размер блока параметров
F750 100 PARM2  хранение параметров
F7B4 1  PRMFLG  флаг  источника  параметров, был  ли  поиск PARM 1
F7B5 2  ARYTA2  конечный указатель для поиска
F7B7 1  NOFUNS  = 0, если нет объектной (активной) функции USR
                              75  

F7B8 2  TEMP9   временная работа по сбору мусора
F7BA 2  FUNACT  количество активных (объектных) функций USR
F7BC 8  SWPTMP  работа   по   обмену, значение  первой  переменной
                оператора SWAP
F7C4 1  TRCFLG  = 0, если выключено трассирование (TRACE)

                Работа математического пакета

F7C5 43 FBUFFR  рабочая область для пакета программ BCD (для
                вывода вещественных чисел)
F7F0 2  DECTMP  временная переменная для преобразования
                десятичного числа  в число с плавающей точкой
F7F2 2  DECTM2  временная переменная для деления
F7F4 2  DECCNT  счетчик для деления
F7F6 16 DAC     десятичный аккумулятор
F806 48 HOLD8   область  сохранения  регистров   для   десятичного
                умножения
F836 8  HOLD2   временная переменная
F83E 8  HOLD    временная переменная
F847 16 ARG     вторичный арифметический аккумулятор
F857 8  RNDX    последнее    сгенерированное    случайное    число
                двойной точности

                Область интерпретатора BASIC

F85F 1 MAXFIL   максимальное    возможное    количество     файлов
                (MAXFILES)
F860 2  FILTAB  начальный адрес данных о файлах
F862 2  NULBUF  адрес буфера файла номер 0 (SAVE, LOAD)
F864 2  PTRFIL  указывает на данные текущего файла
F866 2  RUNFLG  <>0, если  был  запуск  после  загрузки (LOAD..,R)
F866 11 FILNAM  название для файлов для NAME
F871 11 FILNM2  второе название для NAME
F87C 1  NLONLY  <>0 при загрузке программ
F87D 2  SAVEND  конечный адрес программы в кодах для BSAVE
F87F 160 FNKSTR значения функциональных клавиш, 16*10
F91F 3  CGPNT   слот и адрес таблицы образов шаблонов символов -
                PGT ROM
                              76  

                Адреса таблиц видеопроцессора:

F922 2  NАMBAS  адрес PNT
F924 2  CGPBAS  адрес PGT
F926 2  PATBAS  адрес SGT
F928 2  ATRBAS  адрес SAT
F92A 2  CLOC    для GENGRP, графика
F92C 1  CMASK   временная переменная, для графики
F92D 2  MINDEL  временный минимум, для графики
F92F 2  MAXDEL  временный максимум, для графики

                Рабочая область для оператора CIRCLE

F931 2  ASPECT  отношение стороны (aspect), коэффициент сжатия
F933 2  CENCNT  счетчик конца, конечный угол
F935 1  CLINEF  флаг рисования линии в центр
F936 2  CNPNTS  указатель на plot, текущая изображаемая точка
F938 1  CPLOTF  флаг "plot polarity"
F939 2  CPCNT   1/8 числа точек
F93B 2  CPCNT8  количество точек в окружности
F93D 2  CRCSUM  сумма CIRCLE
F93F 2  CSTCNT  начальный счетчик
F941 1  CSCLXY  шкала X и Y
F942 2  CSAVEA  область сохранения для ADVGRP
F944 1  CSAVEM  область сохранения для ADVGRP
F945 2  CXOFF   смещение X от центра
F947 2  CYOFF   смещение Y от центра

                Рабочая область для оператора PAINT

F949 1  LOHMSK  область сохранения RАМ
F94A 1  LOHDIR  внутренняя переменная
F94B 2  LOHADR  внутренняя переменная
F94D 2  LOHCNT  внутренняя переменная
F94F 2  SKPCNT  счетчик пропусков
F951 2  MOVCNT  счетчик движения
F953 1  PDIREC  направление закраски
F954 1  LFPROG  внутренняя переменная
F955 1  RTPROG  внутренняя переменная
                              77  

                Рабочая область для оператора PLAY

F956 2  MCLTAB  указатель на верхушку  таблицы макрокоманды  PLAY
                или DRAW
F958 1  MCLFLG  PLAY / DRAW - присваивание
F959 24 QUETAB  таблица очередей (4 очереди по 6 байт)
                +0: смещение PUT
                +1: смещение GET
                +2: символ поддержки (backup)
                +3: длина очереди
                +4: адрес очереди
                +5: адрес очереди
F971 4  QUEBAK  используется в BCKQ
F975 128 VOICAQ очередь для голоса А
F9F5 128 VOICBQ очередь для голоса B
FA75 128 VOICCQ очередь для голоса C

                    Рабочая область для MSX-2

FAF5 1  DPPAGE  номер отображаемой страницы
FAF6 1  ACPAGE  номер активной страницы
FAF7 1  AVSAV   сохраняет AV управляющий порт
FAF8 1  EXBRSA  указатель слота для SUBROM EBIOS
FAF9 1  CHRCNT  счетчик  символов  в  буфере, используется при
                переводе ROMAN-KANA (0..2)
FAFA 2  ROMA    область  хранения  символов  в  буфере,   перевод
                ROMAN-KANA
FAFC 1  MODE    переключатель типа/размера VRAM: 0000FBB0
                F - 1 -маска, 0 - нет маски (определять ли адрес
                      VRAM как операцию AND с 3FFFh (SCREEN 0..3))
                BB - 00 - 16K  VRAM
                     01 - 64K  VRAM
                     10 - 128K VRAM
FAFD 1  NORUSE  не используется
FAFE 2  XSAVE   ISSS SSSS XXXX XXXX. X - координата пера или мыши,
                I=1 - прерывание  от  светового  пера,  SSSSSSS  -
                смещение без знака (см. с.129, NEWPAD)
FB00 2  YSAVE   *SSS SSSS YYYY YYYY. Y - координата пера или мыши,
                SSSSSSS - смещение без знака (см. с.129, NEWPAD)
FB02 1  LOGOPR  код логической операции
                              78  

                   Область для RS232C

FB03 5  RSTMP   рабочая область для RS232C или диска
FB03 1  TOCNT   внутренняя переменная
FB04 2  RSFCB   адрес RS232C
FB06 1  RSIQLN  внутренняя переменная
FB07 5  MEXBIH
                +0: RST 30h
                +1: байт данных
                +2: адрес
                +3: адрес
                +4: RET
FB0C 5  OLDSTT
                +0: RST 30h
                +1: байт данных
                +2: адрес
                +3: адрес
                +4: RET
FB12 5  OLDINT
                +0: RST 30h
                +1: байт данных
                +2: адрес
                +3: адрес
                +4: RET
FB17 1  DEVNUM  номер устройства, внутренняя переменная
FB18 3  DATCNT  данные (1) и указатель (2)
FB1B 3  ERRORS  ошибки, внутренняя переменная
FB1C 1  FLAGS   флаги, внутренняя переменная
FB1D 1  ESTBLS  внутренняя переменная
FB1E 1  COMMSK  внутренняя переменная
FB1F 1  LSTCOM  внутренняя переменная
FB20 1  LSTMOD  внутренняя переменная

                Область для DOS

FB21-FB34 19    зарезервированы (список слотов BDOS)
FB35 1  PRSCNT  анализ (разбор) строки
FB36 2  SAVSP   сохранение указателя стека для PLAY
FB38 1  VOICEN  текущий голос для исполнения
FB39 2  SAVVOL  сохранение размера паузы
                              79  

FB3B 1  MCLLEN  внутренняя переменная PLAY
FB3C 2  MCLPTR  внутренняя переменная PLAY
FB3E 1  QUEUEN  внутренняя переменная, очередь PLAY
FB3F 1  MUSICF  флаг прерывания для воспроизведения музыки
                (биты 0,1,2 - для голосов A,B,C)
FB40 1  PLYCNT  количество операторов PLAY, записанных в очереди
FB41 37 VCBA    статистические данные голоса А:
FB41 2  METREX  счетчик вниз
FB43 1  VCXLEN  MCLLEN для этого голоса
FB44 2  VCXPTR  MCLPTR для этого голоса
FB46 2  VCXSTP  хранит вершину указателя стека
FB48 1  OLENGX  количество байтов, хранимых в очереди
FB49 2  NTICSX  новый счетчик вниз
FB4B 2  TONPRX  область установки периода тона (звучания)
FB4D 1  AMPPRX  уменьшение громкости и envelope
FB4E 2  ENVPRX  область для установки периода envelope
FB50 1  OCTAVX  область для установки октавы
FB51 1  NOTELX  область для установки длины звучания (тона)
FB52 1  TEMPOX  область для установки темпа
FB53 1  VOLUMX  область для установки громкости
FB54 14 ENVLPX  область для установки формы волны envelope
FB62 3  MCLSTX  область хранения стека
FB65 1  MCLSEX  стек инициализации
FB66 1  VCBSIZ  размер статического буфера
FB66 37 VCBB    статистические данные голоса B
FB8B 37 VCBC    статистические данные голоса C

                Область данных

FBB0 1  ENSTOP  если   не  0 ,  то  программу  можно   остановить,
                нажав Ctrl + Shift + Graph + РУС
FBB1 1  BASROM  не  0,  если  текст  на  BASICе  находится  в ROM;
                при  этом  CTRL/STOP  и  STOP   не  обрабатывается
FBB2 24 LINTTB  таблица  ограничителя  строк, информация о  концах 
                строк на экране
FBCA 2  FSTPOS  позиция  первого  символа  строки  в INLIN (00B1h)
                в BIOS
FBCC 1  CODSAV  хранение кодa символа, на котором находится курсор
FBCD 1  FNKSWI  показывает,   какие   функциональные      клавиши 
                отображаются   (1-F1..F5, 0-F6..F10)
                              80  

FBCE 10 FNKFLG  флаги    ловушек   для   функциональных     ключей
                (разрешение, запрет  или  приостановка  для  ONKEY
                GOSUB, KEY ON/OFF)
FBD8 1  ONGSBF  флаг, было ли событие в TRPTBL (FC4Ch)
FBD9 1  CLIKFL  флаг звука клавиши
FBDA 11 OLDKEY  старый статус клавиш
FBE5 11 NEWKEY  новый статус клавиш

                  Сканирование клавиатуры

 > T16
  ┌─────┬──────────────────────────────────────────────┬──────┐
  │ Байт│           Установка    бита                  │ Адрес│
  ├─────┼──────┬──────┬─────┬────┬────┬─────┬────┬─────┼──────┤
  │     │  X7  │  X6  │ X5  │ X4 │ X3 │ X2  │ X1 │ X0  │NEWKEY│
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y0  │   6  │   5  │  4  │  3 │  2 │  1  │  ; │  9  │ FBE5 │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y1  │   V  │   *  │  H  │  - │  = │  0  │  8 │  7  │ FBE6 │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y2  │   I  │   F  │  ?  │  < │  @ │  B  │  > │  \  │ FBE7 │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y3  │   O  │   [  │  R  │  P │  A │  U  │  W │  S  │ FBE8 │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y4  │   K  │   J  │  Z  │  ] │  T │  X  │  D │  L  │ FBE9 │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y5  │   Q  │   N  │  |  │  C │  M │  G  │  E │  Y  │ FBEA │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y6  │  F3  │  F2  │  F1 │ РУС│CAPS│GRAPH│CTRL│SHIFT│ FBEB │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y7  │RETURN│SELECT│  BS │STOP│ TAB│ ESC │ F5 │  F4 │ FBEC │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y8  │RIGHT │ DOWN │  UP │LEFT│ DEL│ INS │HOME│SPACE│ FBED │
  └─────┴──────┴──────┴─────┴────┴────┴─────┴────┴─────┴──────┘


                   Дополнительная клавиатура


  ┌─────┬──────┬──────┬─────┬────┬────┬─────┬────┬─────┬──────┐
  │ Y9  │  4   │   3  │  2  │  1 │  0 │  *  │  + │ RET │ FBEE │
  ├─────┼──────┼──────┼─────┼────┼────┼─────┼────┼─────┼──────┤
  │ Y10 │   .  │   ,  │  -  │  9 │  8 │  7  │  6 │  5  │ FBEF │
  └─────┴──────┴──────┴─────┴────┴────┴─────┴────┴─────┴──────┘

FBF0 40 KEYBUF  40-символьный буфер клавиатуры
FC17 1  BUFEND  конец буфера клавиатуры
FC18 40 LINWRK  временная работа экранного обработчика, 8 байт
                символа курсора, строка экрана
FC40 8  PATWRK  временная работа преобразователя образца
FC48 2  BOTTOM  начальный адрес ОЗУ (обычно 8000h)
FC4A 2  HIMEM   нижняя граница рабочей области системы (CLEAR)
                ( верхний адрес доступной памяти )

                              81  

FC4C 78 TRPTBL  таблица  ловушек  для обработки прерываний, первый
                байт  означает  статус  ON/OFF/STOP,  остальные  -
                адреса:
                   3*10: ON KEY      GOSUB
                   3*1 : ON STOP     GOSUB
                   3*1 : ON SPRITE   GOSUB
                   3*5 : ON STRIG    GOSUB
                   3*1 : ON INTERVAL GOSUB
                   остальные: зарезервированы для расширений
FC9A 1  PTYCNT  внутренний счетчик
FC9B 1  INTFLG  03h вызывает остановку при нажатии CTRL/STOP
FC9C 1  PADY    координаты Y,X графического планшета и игровых
FC9D 1  PADX       манипуляторов (типа "Мышь" и "Трекбол")
FC9E 2  JIFFY   таймер, используется внутренне оператором PLAY,
                увеличивается на единицу 60 раз в секунду,
                при достижении максимума сбрасывается в ноль
FCA0 2  INTVAL  интервал, устанавливается ON INTERVAL GOSUB
FCA2 2  INTCNT  счетчик интервалов
FCA4 1  LOWLIM  чтение с кассеты
FCA5 1  WINWID  чтение с кассеты
FCA6 1  GRPHED  флаг заголовка графического символа (1 - графич.,
                0 - нормальный
FCA7 1  ESCCNT  счетчик последовательности ESC-кодов
FCA8 1  INSFLG  флаг типа вставки (0 - нормальный курсор)
FCA9 1  CSRSW   курсор выключен (0) или включен
FCAA 1  CSTYLE  код символа, используемого курсором (0 - полный
                курсор, иначе - подчерк, 3/8)
FCAB 1  CAPST   статус клавиши CAPS:
                255/0 - вкл. заглавные/строчные буквы
FCAC 1  KANAST  статус клавиши РУС:
                255/0 - вкл. русские/латинские буквы
FCAD 1  KANAMD  статус упорядочивания клавиш KANA
FCAE 1  FLBMEM  0, пока загружается программа на BASICе
FCAF 1  SCRMOD  режим (номер) текущего экрана (0,1,2,...)
FCB0 1  OLDSCR  старый режим экрана (для выхода из графики)
FCB1 1  CASPRV  символ для CAS:
FCB2 1  BRDATR  граничный цвет для PAINT
FCB3 2  GXPOS   позиция X графического курсора
FCB5 2  GYPOS   позиция Y графического курсора
FCB7 2  GRPACX  значение X графического аккумулятора
                              82  

FCB9 2  GRPACY  значение Y графического аккумулятора
FCBB 1  DRWFLG  флаг, используемый DRAW
FCBC 1  DRWSCL  масштаб DRAW (0 - нет масштаба)
FCBD 1  DRWANG  угол DRAW (0..3)
FCBE 1  RUNBNF  если ="R", был запуск загруженной  программы  в
                кодах; флаг BLOAD/BSAVE или ни то, ни другое
FCBF 2  SAVENT  стартовый адрес объектной программы для BSAVE
FCC1 4  EXPTBL  таблица флагов для расширенного слота, расширяется
                ли слот (старший бит каждого байта)
FCC5 4  SLTTBL  статус для каждого регистра текущего расширенного
                слота, текущие подслоты
FCC9 64 SLTATR  атрибуты слотов (по одному байту на каждую  ло-
                гическую страницу каждого слота, 4 - на вторич-
                ный слот, 16 - на слот) 
FD02 1  SLT321  32, если адрес перехода на программу в  кодах
                по 'CALL' находится в RAM по адресу 4004h
                (слот 3, вторичный слот 2, страница 1)
FD09 128 SLTWRK специальная рабочая область для каждого слота
FD89 16 PROCNM  сюда 'CALL' заносит имя вызываемой функции или
                OPEN - устройство расширения. 0 обозначает конец
FD99 1  DEVICE  ID устройства для cartrige 0-3
───────────────────────────────────────────────────────────────

                            ЛОВУШКИ

   Ловушки (hooks, хуки) предназначены для перехвата переходов  на
подпрограммы. Обычно они содержат команду возврата  или  рестарта,
вместо  которой  можно  поставить   команду   перехода   на   свою
подпрограмму. На каждую ловушку отводится по 5 байт.
───────────────────────────────────────────────────────────────
FD9A H.KEYI MSXIO начало подпрограммы обработки прерываний MSXIO.
                  Например, от RS232C
FD9F H.TIMI MSXIO начало программы обработки прерываний от таймера
FDA4 H.CHPH MSXIO начало CHPUT подпрограмм (вывод одного символа
                  на текстовый экран, в регистре A - код символа)
FDA9 H.DSPC MSXIO начало отображения курсора (Вывод курсора после
                  вывода одного символа на текстовый экран)
FDAE H.ERAC MSXIO начало уничтожения курсора (Уничтожение курсора
                  перед выводом одного символа на текстовый экран)
FDB3 H.DSPF MSXIO начало отображения функциональной клавиши
                              83  

FDB8 H.ERAF MSXIO начало уничтожения функциональной клавиши
FDBD H.TOTE MSXIO начало перехода в текстовый режим
FDC2 H.CHGE MSXIO начало ввода символа (CHGET)
FDC7 H.INIP MSXIO начало подпрограммы, инициализирующей образы
                  символов. Определение альтернативного набора
                  символов.
FDCC H.KEYC MSXIO подпрограмма кодирования клавиш. Изменяет
                  действие клавиши
FDD1 H.KYEA MSXIO подпрограмма NMI,присваивающая клавишам функцию.
                  Изменяет действие клавиши (key easy).
FDD6 H.NMI  MSXIO немаскируемые прерывания (NMI)
FDDB H.PINL MSXINL ввод строки программы (program line), PINLIN
FDE0 H.QINL MSXINL знак вопроса и ввод строки
FDE5 H.INLI MSXINL ввод строки
FDEA H.ONGO MSXSTS ON GOTO
FDEF H.DSKO MSXSTS DSKO$
FDF4 H.SETS MSXSTS установка атрибутов
FDF9 H.NAME MSXSTS RENAME,NAME
FDFE H.KILL MSXSTS KILL
FE03 H.IPL  MSXSTS начальная загрузка программы, IPL
FE08 H.COPY MSXSTS COPY
FE0D H.CMD  MSXSTS расширенная команда, CMD
FE12 H.DSKF MSXSTS DISK FREE, DSKF
FE17 H.DSKI MSXSTS DSKI$
FE1C H.ATTR MSXSTS ATTR$
FE21 H.LSET MSXSTS LSET
FE26 H.RSET MSXSTS RSET
FE2B H.FIEL MSXSTS FIELD
FE30 H.MKI$ MSXSTS MKI$
FE35 H.MKS$ MSXSTS MKS$
FE3A H.MKD$ MSXSTS MKD$
FE3F H.CVI  MSXSTS CVI
FE44 H.CVS  MSXSTS CVS
FE49 H.CVD  MSXSTS CVD
FE4E H.GETP SPCDSK ввести указатель файла (GETPTR)
FE53 H.SETF SPCDSK установить указатель файла
FE58 H.NOFO SPCDSK NO FOR. При открытии файла не указан режим
                   ввода/вывода
FE5D H.NOLO SPCDSK NOLL FILE OPEN, открыт неиспользуемый файл
FE62 H.NTFL SPCDSK файл не номер 0
                              84  

FE67 H.MERG SPCDSK MERGE
FE6C H.SAVE SPCDSK сохранить BASIC-программу. SAVE
FE71 H.BINS SPCDSK BSAVE
FE76 H.BINL SPCDSK BLOAD
FE7B H.FILE SPCDSK FILES
FE80 H.DGET SPCDSK DISK GET
FE85 H.FILO SPCDSK FILE OUT 1, вывод в файл
FE8A H.INDS SPCDSK ввод символа (атрибута) диска
FE8F H.RSLF SPCDSK RE-SELECT OLD DRIVE, INPUT$
FE94 H.SAVD SPCDSK SAVE CURRENT DRIVE
FE99 H.LOC  SPCDSK LOC$
FE9E H.LOF  SPCDSK LOF
FEA3 H.EOF  SPCDSK EOF
FEA8 H.FPOS SPCDSK позиция файла (FROS)
FEAD H.BAKU SPCDSK BACK UP
FEB2 H.PARD SPCDEV Анализирует имя устройства, ввод имени
                   периферийного устройства
FEB7 H.NODE SPCDEV Имя не является подтвержденным именем
                   устройства. NODEVN (no device name) routine.
FEBC H.POSD SPCDEV POSSIBLY DISK
FEC1 H.DEVN SPCDEV Имя устройства подтверждено. Определение
                   новых имен, обработка имени устройства
FEC6 H.GEND SPCDEV GENERAL DEVICE DISPAT CHR. Устройство
                   не является дисководом. Приписывание устройства
FECB H.RUNC BIMISC NEW, RUN Clear
FED0 H.CLEA BIMISC CLEAR
FED5 H.LOPD BIMISC SET LOOP AND DEFAULT VALUE
FEDA H.STKE BIMISC STACK ERROR FEDF H.ISFL IS FILE. Хук запуска
                   после перезагрузки
FEDF H.ISFL BIMISC ISFLIO (есть файл I/O или нет)
FEE4 H.OUTD BIO    Вывод символов. Выполнение OUT
FEE9 H.CRDO BIO    CRDO (выполнение CRlf)
FEEE H.DSKC BIO    DSKCHI (ввод атрибута (символа) диска)
FEF3 H.DOGR GENGRP DOGRPH (выполнение графической операции)
FEF8 H.PRGE BINTRP PRGEND (конец программы, END)
FEFD H.ERRP BINTRP ERRPRT (печать, вывод ошибки)
FF02 H.ERRF BINTRP подпрограмма обработки ошибки
FF07 H.READ BINTRP вход ready, подпрограмма вывода сообщения "Ok"
FF0C H.MAIN BINTRP вход в MAIN
FF11 H.DIRD BINTRP вход DIRDO (выполнение прямого оператора)
                              85  

FF16 H.FINI BINTRP
FF1B H.FINE BINTRP
FF20 H.CRUN BINTRP
FF25 H.CRUS BINTRP
FF2A H.ISRE BINTRP
FF2F H.NTFN BINTRP
FF34 H.NOTR BINTRP
FF39 H.SNGF BINTRP
FF3E H.NEWS BINTRP
FF43 H.GONE BINTRP
FF48 H.CHRG BINTRP подпрограмма CHRGET
FF4D H.RETU BINTRP RETURN
FF52 H.PRTF BINTRP PRINT
FF57 H.COMP BINTRP
FF5C H.FINP BINTRP
FF61 H.TRMN BINTRP
FF66 H.FRME BINTRP
FF6B H.NTPL BINTRP
FF70 H.EVAL BINTRP
FF75 H.OKNO BINTRP
FF7A H.FING BINTRP
FF7F H.ISMI BINTRP MID$ или нет
FF84 H.WIDT BINTRP WIDTH
FF89 H.LIST BINTRP LIST или LLIST
FF8E H.BUFL BINTRP BUFLIN (строка буфера)
FF93 H.FRQI BINTRP POKE, FRQINT, подпрограмма преобразования
                   в целое
FF98 H.SCNE BINTRP
FF9D H.FRET BISTRG FRETMP, free up to temporaries
FFA2 H.PTRG BIPTRG PTRGET, получение указателя
FFA7 H.PHYD MSXIO  PHYDIO, физический  ввод/вывод с диска
                   (BIOS 144h)
FFAC H.FORM MSXIO  FORMAT, форматирование диска
FFB1 H.ERRO BINTRP ERROR, обработка ошибки
FFB6 H.LPTO MSXIO  LPTOUT, вывод символа на принтер
FFBB H.LPTS MSXIO  LPTSTT, проверка статуса принтера
FFC0 H.SCRE MSXSTS SCREEN
FFC5 H.PLAY MSXSTS PLAY
FFCA H.EBIOS EBIOS ловушка расширенных BIOS
FFCF DISINT  DOS   отключение прерываний
                              86  

FFD0-FFD3          резерв
FFD4 ENAINT  DOS   обеспечение прерываний, окончание чтения диска
FFD5-FFE6          резерв
───────────────────────────────────────────────────────────────

           ОБЛАСТЬ СОХРАНЕНИЯ РЕГИСТРОВ VDP V9938 MSX-2

───────────────────────────────────────────────────────────────
FFE7 1  Rg8SAVE
FFE8 1  Rg9SAVE
FFE9 1  Rg10SAVE
FFEA 1  Rg11SAVE
FFEB 1  Rg12SAVE
FFEC 1  Rg13SAVE
FFED 1  Rg14SAVE
FFEE 1  Rg15SAVE
FFEF 1  Rg16SAVE
FFF0 1  Rg17SAVE
FFF1 1  Rg18SAVE
FFF2 1  Rg19SAVE
FFF3 1  Rg20SAVE
FFF4 1  Rg21SAVE
FFF5 1  Rg22SAVE
FFF6 1  Rg23SAVE

FFF7 1  слот для MAIN-ROM
FFF8-FFFB  резерв
FFFC 1  регистр состояния вторичных слотов
FFFD 1  регистр состояния вторичных слотов
FFFE 1  регистр состояния вторичных слотов
FFFF 1  регистр состояния вторичных слотов
───────────────────────────────────────────────────────────────






                              87  
      ПРИЛОЖЕНИЕ 2. ПОРТЫ ВВОДА/ВЫВОДА

    Ниже приводится список портов RS232C, PPI, PSG, VDP, принтера,
маппера  и  их  назначение.  Порты  PPI  затем  рассмотрены  более
подробно. Порты хранят восьмибитное значение.

  ┌──────┬─────────┬───────────────────────────────────┬─────┐
  │ Порт │ Чтение/ │             Назначение            │Устр-│
  │      │ Запись  │                                   │ во  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │   0  │    З    │ Запись в порт данных (8251)       │     │
  │      │    Ч    │ Чтение из порта                   │     │
  │   1  │   Ч/З   │ Порт команд/состояния (8251)      │  R  │
  │   2  │    Ч    │ Номер компьютера, таймер          │  S  │
  │      │    З    │ Запись в регистр маски прерываний │  2  │
  │   4  │   Ч/З   │ Счетчик 0 (8253)                  │  3  │
  │   5  │   Ч/З   │ Счетчик 1 (8253)                  │  2  │
  │   6  │   Ч/З   │ Счетчик 2 (8253)                  │  C  │
  │   7  │    З    │ Запись в регистр вида(mode) (8253)│     │
  │   8  │    З    │ Запись в регистр режимов          │     │
  │   9  │    З    │ Команда                           │ MSX │
  │  12  │    Ч    │ Состояние                         │  2  │
  │  14  │   Ч/З   │ Данные                            │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  2D  │    Ч    │ Версия ПЗУ. MSX-1 = 0, MSX-2 × 0  │     │
  │  40  │   З/Ч   │ Регистр номера ID устройства      │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  41  │    З    │ Поддержка защелки RAM-адреса      │  Y  │
  │  42  │    Ч    │ Поддержка READ/WRITE данных RAM   │  M  │
  │      │    З    │                                   │  3  │
  │  46  │    З    │ Бит-отображающая функция          │  8  │
  │  47  │    Ч    │ Код цвета                         │  1  │
  │      │    З    │ Бит-шаблон/ FG,BG код цвета       │  4  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  80  │         │ Данные для 8251                   │  R  │
  │  81  │         │ Статус/команда для 8251           │  S  │
  │  82  │         │ Статус чтения/ маска прерывания   │  2  │
  │  83  │         │ Не используется                   │  3  │
  │  84  │         │ 8253                              │  2  │
  │  85  │         │ 8253                              │  C  │
  │  86  │         │ 8253                              │     │
  │  87  │         │ 8253                              │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  88  │         │ Порты I/O для адаптера VDP 9938   │     │
  │  89  │         │          MSX-1                    │  V  │
  │  8A  │         │                                   │  D  │
  │  8B  │         │                                   │  P  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  8C  │         │ Порты для модема                  │  M  │
  │  8D  │         │                                   │  D  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  90  │    З    │ Строб OUT (b0) длиной OUT (вывод) │     │
  │      │    Ч    │ Статус IN (b1) 1=BUSY (занято)    │ PRI‐│
  │  91  │    З    │ Вывод символа на принтер          │ NTER│
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  98  │    З    │ Запись данных в память VRAM       │     │
  │      │    Ч    │ Чтение данных из памяти VRAM      │ VDP │
  │  99  │    З    │ Установка команды, адреса         │     │
  │      │    Ч    │ Чтение статуса                    │     │
  │  9A  │    З    │ Установка палитры цветов          │     │
  │  9B  │    З    │ Косвенная запись во внутр. регистр│     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  A0  │    З    │ Длина адреса, номер регистра      │     │
  │  A1  │    З    │ Запись данных в регистр           │ PSG │
  │  A2  │    Ч    │ Чтение данных из портов 14 и 15   │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  A8  │    З    │ Запись данных в порт A            │     │
  │      │    Ч    │ Чтение данных из порта A          │  P  │
  │  A9  │    З    │ Запись данных в порт B            │  P  │
  │      │    Ч    │ Чтение данных из порта B          │  I  │
  │  AA  │    З    │ Запись данных в порт C            │  8  │
  │      │    Ч    │ Чтение данных из порта C          │  2  │
  │  AB  │    З    │ Запись в регистр режима PPI       │  5  │
  │      │    Ч    │ Чтение из регистра режима PPI     │  5  │
  └──────┴─────────┴───────────────────────────────────┴─────┘


                             88  


  ┌──────┬─────────┬───────────────────────────────────┬─────┐
  │  AC  │         │      Двигатель (мотор) MSX        │  E  │
  │  AD  │         │        (один чип MSX I/O)         │  N  │
  │  AE  │         │                                   │  G  │
  │  AF  │         │                                   │  N  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │   Расширение памяти (SONY X8255)  │     │
  │  B0  │         │ Порт A, адрес (А0..А7)            │  S  │
  │  B1  │         │ Порт B, адрес, управление, R/W    │  O  │
  │  B2  │         │ Порт C, адрес (A11..A12), данные  │  N  │
  │  B3  │         │ Установка вида                    │  Y  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  B4  │    З    │ Календарь,часы. Защелка адреса    │Кален│
  │  B5  │    Ч    │ Данные                            │дарь │
  │      │    З    │ Данные                            │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │ Управление световым пером (SANYO) │  S  │
  │  B8  │   Ч/З   │                                   │  A  │
  │  B9  │   Ч/З   │                                   │  N  │
  │  BA  │   Ч/З   │                                   │  Y  │
  │  BB  │    З    │                                   │  O  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │     Управление VHD (JVCX8255)     │     │
  │  BC  │         │ Порт А                            │  V  │
  │  BD  │         │ Порт B                            │  H  │
  │  BE  │         │ Порт C                            │  D  │
  │  BF  │         │ Установка режима                  │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  C0  │         │ MSX-AUDIO                         │  A  │
  │  C1  │         │ MSX-AUDIO                         │  U  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  C8  │         │         MSX-интерфейс             │  I  │
  │  ... │         │                                   │  N  │
  │  CF  │         │                                   │  F  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  D0  │         │ Контроллер флоппи-диска (FDC)     │  F  │
  │  ... │         │                                   │  D  │
  │  D7  │         │                                   │  C  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │        Kanji ROM (TOSHIBA)        │  K  │
  │  D8  │    З    │ b5-b0 младшие биты адреса         │  R  │
  │  D9  │    З    │ b5-b0 старшие биты адреса         │  O  │
  │      │    Ч    │ b7-b0 данные                      │  M  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  DA  │         │  Для будущих расширений Kanji     │  E  │
  │  DB  │         │                                   │  K  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │       Контроль системы            │     │
  │  F5  │    З    │ b0 Kanji ROM                      │  C  │
  │      │    З    │ b1 резерв для kanji               │  O  │
  │      │    З    │ b2 MSX-Audio                      │  N  │
  │      │    З    │ b3 superimpose                    │  T  │
  │      │    З    │ b4 интерфейс MSX                  │  R  │
  │      │    З    │ b5 RS-232C                        │  O  │
  │      │    З    │ b6 световое перо                  │  L  │
  │      │    З    │ b7 CLOCK-IC, часы (только MSX-2)  │     │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │  F6  │         │  Шина ввода/вывода цвета          │ CB  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │        Управление A/V             │  A  │
  │  F7  │    З    │ b0 Включение смешивания Audio R   │  V  │
  │      │    З    │ b1 Выключение смешивания Audio L  │  C  │
  │      │    З    │ b2 Выбор видеовхода (21p RGB)     │  O  │
  │      │    Ч    │ b3 Детекция видеовхода            │  N  │
  │      │    З    │ b4 Управление A/V  (TV)           │  T  │
  │      │    З    │ b5 Управление Ym                  │  R  │
  │      │    З    │ b6 Инверсия бита 4 VDP-регистра 9 │  O  │
  │      │    З    │ b7 Инверсия бита 5 VDP-регистра 9 │  L  │
  ├──────┼─────────┼───────────────────────────────────┼─────┤
  │      │         │                                   │  M  │
  │  FC  │    З/Ч  │                                   │  A  │
  │  FD  │    З/Ч  │  Управление физическими           │  P  │
  │  FE  │    З/Ч  │                  страницами       │  P  │
  │  FF  │    З/Ч  │                                   │  E  │
  │      │         │                                   │  R  │
  └──────┴─────────┴───────────────────────────────────┴─────┘




                             89  


        Порты программируемого периферийного интерфейса
                            (PPI ports)


┌────────┬─────┬───────┬───────┬──────────────────────────────┐
│   Порт │ Бит │ Ввод/ │  Имя  │           Значение           │
│        │     │ Вывод │       │                              │
├────────┼─────┼───────┼───────┼──────────────────────────────┤
│        │  0  │       │ CS0L  │ Выбор слота для адресов в    │
│        │  1  │   В   │ CS0H  │ диапазоне 0000-3FFF          │
│        ├─────┤   Ы   ├───────┼──────────────────────────────┤
│        │  2  │   В   │ CS1L  │ Выбор слота для адресов в    │
│        │  3  │   О   │ CS1H  │ диапазоне 4000-7FFF          │
│   A    ├─────┤   Д   ├───────┼──────────────────────────────┤
│  (A8h) │  4  │   /   │ CS2L  │ Выбор слота для адресов в    │
│        │  5  │   В   │ CS2H  │ диапазоне 8000-BFFF          │
│        ├─────┤   В   ├───────┼──────────────────────────────┤
│        │  6  │   О   │ CS3L  │ Выбор слота для адресов в    │
│        │  7  │   Д   │ CS3H  │ диапазоне C000-FFFF          │
├────────┼─────┼───────┼───────┼──────────────────────────────┤
│        │  0  │   в   │       │                              │
│   B    │  1  │   в   │       │ Состояние строки клавиатуры  │
│  (A9h) │ ... │   о   │       │                              │
│        │  7  │   д   │       │                              │
├────────┼─────┼───────┼───────┼──────────────────────────────┤
│        │  0  │       │  KB0  │                              │
│        │  1  │       │  KB1  │ Выбор строки при сканирова‐  │
│        │  2  │       │  KB2  │ нии клавиатуры               │
│        │  3  │   В   │  KB3  │                              │
│        ├─────┤       ├───────┼──────────────────────────────┤
│        │  4  │   Ы   │ CASON │ CAS CTRL (1-ON)              │
│        │     │       │       │ кассетник включен мотор      │
│   C    ├─────┤   В   ├───────┼──────────────────────────────┤
│  (AAh) │  5  │       │ CASW  │ Запись на кассету            │
│        ├─────┤   О   ├───────┼──────────────────────────────┤
│        │  6  │       │ CAPS  │ CAPS LAMP (1-ON)             │
│        │     │   Д   │       │ Вкл/выкл заглавных букв      │
│        ├─────┤       ├───────┼──────────────────────────────┤
│        │  7  │       │ SOUND │ Вывод звука (SOFT)           │
└────────┴─────┴───────┴───────┴──────────────────────────────┘


                   Порты управления маппером
                      (только для MSX-2)


      ┌──────┬─────────────────────┬──────────────────────┐
      │ Порт │ Логическая страница │ Физическая страница  │
      ├──────┼─────────────────────┼──────────────────────┤
      │  FCh │          0          │                      │
      ├──────┼─────────────────────┤      Значения        │
      │  FDh │          1          │ задаются в интервале,│
      ├──────┼─────────────────────┤ зависящем от объема  │
      │  FEh │          2          │ RAM (например, если  │
      ├──────┼─────────────────────┤ RAM = 128К, то 0..7  │
      │  FFh │          3          │                      │
      └──────┴─────────────────────┴──────────────────────┘



                             90  
  
 

 
      ПРИЛОЖЕНИЕ 3. ПОДПРОГРАММЫ MSX-BASIC BIOS

   ВНИМАНИЕ. Ниже используются следующие обозначения:
* 1 - такая же подпрограмма BIOS, как в MSX-1;
* 2 - вызывает SUB-ROM для экранов 5..8;
* 3 - всегда вызывает SUB-ROM;
* 4 - не вызывает SUB-ROM для экранов 5..8;
?   - изменение содержимого регистров зависит от вызова.

       ∙ Прерывания: интерпретатор, управление слотами,
         аппаратные прерывания

   Интерпретатор языка  MSX-BASIC  использует  прерывания  по  RST
00h..28h.  Подпрограмма  обработки  прерывания   по   адресу   30h
используется  для  межслотовых  вызовов,  по  адресу  38h  -   для
прерываний от аппаратуры.

0000 CHKRAM * 1
   Проверяет ОЗУ (RAM)  и  устанавливает  слот  для  системы.  Для
дальнейшей инициализации должен быть сделан переход на INIT.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

0008 SYNCHR * 1
   Сравнивает    символ    на    который    указывает    [HL]    с
символом, следующим за RST; если они равны, осуществляется переход
на CHRGTR; в противном случае выдается сообщение о  синтаксической
ошибке.
Вход:   [HL] - адрес проверяемого символа
               Например,          LD   HL,Letter
                                  RST  08h
                                  DB   'A'
                                  ...
                          Letter: DB  'B'
Выход:  [HL] - адрес следующего символа
        [A] - символ [HL]
        Флаг C=1, если символ является цифрой
        Флаг Z=1, если конец оператора (0h или 3Ah)
Изм:    AF,HL
                          91  

000C RDSLT * 1
   Выбирает слот в соответствии со значением A  и  считывает  один
байт по указанному адресу из слота. Прерывания отменены  и  заново
не активируются.
Вход:   [A] - F000SSPP
        F=1 если указан вторичный слот
        SS=номер вторичного слота (0-3)
        PP=номер первичного слота (0-3)
        [HL] - Адрес памяти приемника
Выход:  [A] - содержимое памяти
Изм:    AF,BC,DE

0010 CHRGTR * 1
   Выбирает следующий символ или лексему из  текста  программы  на
языке BASIC.
Вход:   [HL] - адрес символа
Выход:  [HL] - адрес следующего символа
        [A] - символ [HL]
        Флаг C=1, если символ является цифрой
        Флаг Z=1, если конец оператора (0h или 3Ah)
Изм:    AF,HL

0014 WRSLT * 1
   Выбирает  слот  в  соответствии  со  входными   параметрами   и
записывает в него по указанному адресу новое значение.  Прерывания
отменены и заново не активируются.
Вход:   [A] - так же, как и для RDSLT
        [HL] - адрес памяти приемника
        [E] - записываемые данные
Выход:  Ничего
Изм:    AF,BC,D

0018 OUTDO * 2
   Выводит  данные  на  активированное   устройство   (экран   или
принтер).
Вход:   [A] - символ
        PTRFIL, PTRFLG - куда выводить
Выход:  Ничего
Изм:    Ничего
                          92  

001C CALSLT * 1
   Межслотовый вызов по указанному адресу. Прерывания  отменены  и
заново  не  активируются.  Передача  параметров  через   индексные
регистры Z80, [IX] или [IY] невозможна.
Вход:   [IY] - F000SSPP 00000000 (см. RDSLT)
        [IX] адрес вызова
Выход:  ?
Изм:    ?

0020 DECOMPR * 1
   Сравнивает [HL] с [DE].
Вход:   [HL], [DE]
Выход:  Флаги
Изм:    AF

0024 ENASLT * 1
   Выбирает  слот  в  соответствии  со  входными   параметрами   и
активирует слот. Прерывания отменены и заново не активируются.
Вход:   [A] - F000SSPP (см. RDSLT)
Выход:  Ничего
Изм:    Все регистры

0028 GETYPR * 1
   Возвращает тип десятичного аккумулятора DAC.
Вход:   DAC
Выход:  Флаги:

                    ┌──────────────┬───┬───┬───┬─────┐
                    │    Тип       │ C │ S │ Z │ P/V │
                    ├──────────────┼───┼───┼───┼─────┤
                    │ Целый        │ 1 │ 1 │ 0 │  1  │
                    ├──────────────┼───┼───┼───┼─────┤
                    │ Вещественный │ 1 │ 0 │ 0 │  0  │
                    ├──────────────┼───┼───┼───┼─────┤
                    │ Двойной      │ 0 │ 0 │ 0 │  1  │
                    ├──────────────┼───┼───┼───┼─────┤
                    │ Строковый    │ 1 │ 0 │ 1 │  1  │
                    └──────────────┴───┴───┴───┴─────┘

Изм:    AF
                          93  

0030 CALLF * 1
   Межслотовый вызов. Например,
                      RST  30h
                      DB   N     ; указатель слота
                      DW   NN    ; вызываемый адрес
Вход:   байты за RST
Выход:  ?
Изм:    AF+?

0038 KEYINT * 1
   Выполняет процедуру прерывания по таймеру.
Вход:   Ничего
Выход:  Ничего
Изм:    Ничего

               ∙ Инициализация ввода/вывода

003B INITIO * 1
   Инициализация устройств.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

003E INIFNK * 1
   Инициализация текста функциональных клавиш.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

       ∙ Доступ к видеопроцессору TMS9918, MSX-1

0041 DISSCR * 1
   Отключение изображения экрана (без его очистки).
Вход:   Ничего
Выход:  Ничего
Изм:    AF,BC

                          94  

0044 ENASCR * 1
   Активирует изображение экрана.
Вход:   Ничего
Выход:  Ничего
Изм:    AF,BC

0047 WRTVDP * 2
   Записывает данные в регистр VDP. Вызывает расширенное ОЗУ, если
бит EV регистра 0 изменен или если у Вас регистр 8..46.
Вход:   [C] - номер регистра (0-23 или 32-46)
        [B] - записываемое значение
Выход:  Ничего
Изм:    AF,BC

004A RDVRM * 1
   Считывает один байт из видеопамяти.
Вход:   [HL] - адрес
Выход:  [A] - считанное значение
Изм:    AF

004D WRTVRM * 1
   Записывает один байт в видеопамять.
Вход:   [HL] - адрес
        [A] - записываемое значение
Выход:  Ничего
Изм:    AF

0050 SETRD * 1
   Устанавливает регистр VDP для последовательного  чтения  байтов
из видеопамяти с автоинкрементом.
Вход:   [HL] - адрес
Выход:  Ничего
Изм:    AF

0053 SETWRT * 1
       Устанавливает VDP для последовательной  записи  (аналогично
SETRD).
Вход:   [HL] - адрес
Выход:  Ничего
Изм:    AF
                          95  

0056 FILVRM * 4
   Записывает один байт заданное число раз в видеопамять.
Вход:   [HL] - начальный адрес
        [BC] - длина
        [A] - записываемое значение
Выход:  Ничего
Изм:    AF,BC

0059 LDIRMV * 4
   Переносит блок данных из видеопамяти в ОЗУ.
Вход:   [HL] - адрес видеопамяти   │ При межслотовом вызове
        [DE] - адрес ОЗУ           │ адрес ОЗУ должен быть
        [BC] - длина               │ больше 4000h
Выход:  Ничего
Изм:    Все регистры

005C LDIRVM * 4
   Переносит блок данных из ОЗУ в видеопамять.
Вход:   [HL] - адрес ОЗУ           │ При межслотовом вызове
        [DE] - адрес видеопамяти   │ адрес ОЗУ должен быть
        [BC] - длина               │ больше 4000h
Выход:  Ничего
Изм:    Все регистры

005F CHGMOD * 3
   Устанавливает режим видеопроцессора в  соответствии  с  режимом
SCREEN.  Палитра  не  инициализируется.   Для   ее   инициализации
используйте CHGMDP в расширенном ПЗУ.
Вход:   [A] - режим экрана (0..8)
Выход:  Ничего
Изм:    Все регистры

0062 CHGCLR * 1
   Изменяет цвет экрана, если он графический - только бордюр.
Вход:   FORCLR (F3E9), BAKCLR (F3EA), BRDCLR (F3EB)
Выход:  Ничего
Изм:    Все регистры
                          96  

0066 NMI * 1
   Выполняет процедуры немаскируемых прерываний.
Вход:   Ничего
Выход:  Ничего
Изм:    Ничего

0069 CLRSPR * 3
   Инициализирует все спрайты. Образы очищаются,  номера  спрайтов
устанавливаются   по   значениям   плоскостей    спрайтов,    цвет
устанавливается  на  значение  цвета  фона.  Вертикальная  позиция
устанавливается на 209 (SCREEN 0..3) или 217 (SCREEN 4..8).
Вход:   SCRMOD
Выход:  Ничего
Изм:    Все регистры

006C INITXT * 3
   Инициализирует экран для SCREEN 0 (40*24). Определяет VDP.  Эта
подпрограмма  не  инициализирует  палитру.  Для  ее  инициализации
используйте INIPLT в расширенном ПЗУ.
Вход:   TXTNAM, TXTCGP, LIN40
Выход:  Ничего
Изм:    Все регистры

006F INIT32 * 3
   Инициализирует экран для SCREEN 1 (32*24).Определяет  VDP.  Эта
подпрограмма не инициализирует палитру.
Вход:   T32NAM, T32CGR, T32COL, T32ATR, T32PAT
Выход:  Ничего
Изм:    Все регистры

0072 INIGRP * 3
   Инициализирует  экран  для  SCREEN  2.  Определяет   VDP.   Эта
подпрограмма не инициализирует палитру.
Вход:   GRPNAM, GRPCGP, GRPCOL, GRPATR, GRPPAT
Выход:  Ничего
Изм:    Все регистры
                          97  

0075 INIMLT * 3
   Инициализирует  экран  для  SCREEN  3.  Определяет   VDP.   Эта
подпрограмма не инициализирует палитру.
Вход:   MLTNAM, MLTCGP, MLTCOL, MLTATR, MLTPAT
Выход:  Ничего
Изм:    Все регистры

0078 SETTXT * 3
   Устанавливает VDP для SCREEN 0 (40*24).
Вход:   TXTNAM, TXTCGP, LIN40
Выход:  Ничего
Изм:    Все регистры

007B SETT32 * 3
   Устанавливает VDP для SCREEN 1 (32*24).
Вход:   T32NAM, T32CGP, T32COL, T32ATR, T32PAT
Выход:  Ничего
Изм:    Все регистры

007E SETGRP * 3
   Устанавливает VDP для SCREEN 2.
Вход:   GRPNAM, GRPCGP, GRPCOL, GRPATR, GRPPAT
Выход:  Ничего
Изм:    Все регистры

0081 SETMLT * 3
   Устанавливает VDP для SCREEN 3.
Вход:   MLTNAM, MLTCGP, MLTCOL, MLTATR, MLTPAT
Выход:  Ничего
Изм:    Все регистры

0084 CALPAT * 1
   Возвращает адрес образа спрайта.
Вход:   [A] - номер спрайта
Выход:  [HL] - адрес используемого спрайтом образа
Изм:    AF,DE,HL
                          98  

0087 CALATR * 1
   Возвращает адрес атрибутов спрайта.
Вход:   [A] - номер спрайта
Выход:  [HL] - адрес используемых спрайтом атрибутов
Изм:    AF,DE,HL

008A GSPSIZ * 1
   Возвращает размер спрайта.
Вход:   Ничего
Выход:  [A] - число байтов, занимаемых спрайтом
        Флаг C=1, если 16*16
Изм:    AF

008D GRPPTR * 2
   Выводит символ на графический экран.
Вход:   [A] - код символа. Код логической операции в SCREEN 5..8
        - в LOGOPR.
Выход:  Ничего
Изм:    Ничего

              ∙ Доступ к PSG (звукогенератору)

0090 GICINI * 1
   Инициализирует  PSG  и  устанавливает  начальные  значения  для
оператора PLAY.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

0093 WRTPSG * 1
   Записывает данные в регистр PSG. 
Вход:   [A] - номер регистра, [E] - записываемое значение 
Выход:  Ничего 
Изм:    Ничего

0096 RDPSG * 1
   Считывает значение из регистра PSG.
Вход:   [A] - номер регистра PSG
Выход:  [A] - его содержимое
Изм:    Ничего
                          99  

0099 STRTMS * 1
   Проверяет и запускает фоновую музыку оператора PLAY.
Вход:   (QUEUE) - запись MML на внутреннем языке
Выход:  Ничего
Изм:    Все регистры

        ∙ Доступ к консоли (клавиатуре, монитору и принтеру)

009C CHSNS * 1
   Проверяет статус буфера клавиатуры.
Вход:   Ничего
Выход:  Флаг Z=0, если в буфере есть хотя бы один символ
Изм:    Ничего

009F CHGET * 1
   Читает один символ  из  буфера  клавиатуры.  Если  буфер  пуст,
выводит курсор и ждет нажатия клавиши. Во время ожидания  работают
CAPS и RUS. После выполнения CHGET интервал сканирования SCNCNT  и
задержка до  автоповторения  снова  инициализируются,  поэтому  их
нужно устанавливать каждый раз заново.
Вход:   Ничего
Выход:  [A] - код символа
Изм:    AF

00A2 CHPUT * 1
   Выводит символ на монитор.
Вход:   [A] - код символа
Выход:  Ничего
Изм:    Ничего

00A5 LPTOUT * 1
   Выводит символ на принтер.
Вход:   [A] - код символа
Выход:  Флаг C=1 в случае невыполнения
Изм:    F
                         100  

00A8 LPTSTT * 1
   Проверяет статус принтера.
Вход:   Ничего
Выход:  A=255 и флаг NZ - готов
        A=0   и флаг Z  - не готов
Изм:    AF

00AB CNVCHR * 1
   Выполнение CNVCHR после CHGET вызывает трансляцию  графического
кода  в  однобайтовый  код,  другие  символы  не  транслируются  и
возвращаются - проверяет графический заголовок и преобразует код.
Вход:   [A] - код символа
Выход:  [А] - транслированный графический символ
        флаг C=0: графический заголовок 01h;
        флаг C=1 и флаг Z=1: графический  символ был;
        флаг C=1 и флаг Z=0: введен нормальный символ,
             преобразования нет.
Изм:    AF

00AE PINLIN * 1
   Принимает строку с  клавиатуры  до  ввода  RETURN  или  STOP  и
записывает  ее  в  буфер  строки   BUF.   Доступны   все   символы
редактирования.
Вход:   Ничего
Выход:  [HL] - адрес начала буфера - 1 (конец строки - код 00h).
        Флаг C=1, если нажато STOP; C=0 - если RETURN.
        [LINTTB] - 00h,  когда  одна  физическая  строка  является
        продолжением строки выше
Изм:    Все регистры

00B1 INLIN * 1
   То же, что и PINLIN, за исключением того случая,  когда  AUTFLG
не является нулевым. 
Вход:   Ничего 
Выход:  [HL] - адрес  начала буфера-1; Флаг C=1, если нажато STOP.
Изм:    Все регистры
                         101  

00B4 QINLIN * 1
   Выводит на экран "? "  и переходит на INLIN.
Вход:   Ничего
0ыход   [HL] - адрес начала буфера-1; Флаг C=1, если STOP
Изм:    Все регистры

00B7 BREAKX * 1
   Проверяет, не нажата ли комбинация  CTRL/STOP.  Работает, когда
прерывания отменены (в этом случае символы в буфер  клавиатуры  не
поступают).
Вход:   Ничего
Выход:  Флаг C=1, если нажаты CTRL/STOP.
Изм:    AF

00BA ISCNTC
   Проверяет, не нажата ли комбинация CTRL/STOP.
Вход:   Ничего
Выход:  Ничего
Изм:    Ничего

00BD CKCNTC
   То же, что и ISCNTC, но используется MSX-BASIC.
Вход:   Ничего
Выход:  Ничего
Изм:    Ничего

00C0 BEEP * 3
   Формирует звуковой сигнал, чистит регистры PSG.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

00C3 CLS * 3
   Очищает экран.
Вход:   Флаг Z=1
Выход:  Ничего
Изм:    AF,BC,DE
                         102  

00C6 POSIT * 1
   Локализует курсор.
Вход:   [H] - колонка, [L] - строка
Выход:  Ничего
Изм:    AF

00C9 FNKSB * 1
   Проверяет, активирован ли вывод текста функциональных клавиш на
экран (FNKFLG). Если да - выводит, иначе - убирает.
Вход:   FNKFLG
Выход:  Ничего
Изм:    Все регистры

00CC ERAFNK * 1
   Отменяет вывод текста функциональных клавиш.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

00CF DSPFNK * 2
   Активирует вывод текста функциональных клавиш.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

00D2 TOTEXT * 1
   Переводит экран в режим 0 или 1 в  конце  программы  или  после
ошибки.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

             ∙ Доступ к игровому вводу/выводу

00D5 GTSTCK * 1
   Возвращает статус джойстика (0 -  управление  курсором,  1,2  -
джойстик)
Вход:   [A] - номер джойстика (0-2)
Выход:  [A] - направление (0-8)
Изм:    Все регистры
                         103  

00D8 GTTRIG * 1
   Возвращает статус кнопки триггера (0 - пробел, 1,2 - триггер).
Вход:   [A] - номер кнопки (0-4)
Выход:  [A] - 255 -  нажата, 0 - не нажата
Изм:    AF

00DB GTPAD * 1
   Возвращает статус нажатия  графического  планшета  или  других
устройств (аналогично в MSX-BASIC).
Вход:   [A] - номер PAD или устройства (0..19)
Выход:  [A] - информация:

┌───────────┬────────────┬────────────────────────────────────┐
│ Device ID │ Устройство │ Возвращаемая информация            │
├───────────┼────────────┼────────────────────────────────────┤
│     0     │            │ FFh - когда касается, 0 - если нет │
├───────────┤            ├────────────────────────────────────┤
│     1     │ Сенсорная  │ X-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│     2     │ панель-1   │ Y-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│     3     │            │ FFh - кнопка нажата, 0 - когда нет │
├───────────┼────────────┼────────────────────────────────────┤
│     4     │            │ FFh - когда касается, 0 - если нет │
├───────────┤            ├────────────────────────────────────┤
│     5     │ Сенсорная  │ X-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│     6     │ панель-2   │ Y-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│     7     │            │ FFh - кнопка нажата, 0 - когда нет │
├───────────┼────────────┼────────────────────────────────────┤
│     8     │            │ FFh - правильные данные, 0 -  нет  │
├───────────┤            ├────────────────────────────────────┤
│     9     │ Световое   │ X-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    10     │   перо     │ Y-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    11     │            │ FFh - переключатель нажат, 0 - нет │
├───────────┼────────────┼────────────────────────────────────┤
│    12     │            │ всегда FFh (используется для ввода)│
├───────────┤            ├────────────────────────────────────┤
│    13     │ Мышь-1 или │ X-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    14     │ трекбол-1  │ Y-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    15     │            │ Всегда 00h                         │
├───────────┼────────────┼────────────────────────────────────┤
│    16     │            │ всегда FFh (используется для ввода)│
├───────────┤            ├────────────────────────────────────┤
│    17     │ Мышь-2 или │ X-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    18     │ трекбол-2  │ Y-координата (0..255)              │
├───────────┤            ├────────────────────────────────────┤
│    19     │            │ Всегда 00h                         │
└───────────┴────────────┴────────────────────────────────────┘

   Примечания.
   Хотя информация  о  координатах  светового  пера  (А=9,  10)  и
переключателя (А=11) читается в одно и то же время при вызове BIOS
с А=8, другие значения имеют смысл только тогда,  когда  результат
равен FFh. Если же при вызове BIOS с А=8 получается результат 00h,
                           104  

значения координат и статуса переключателя полученные после  этого
- бессмысленны.
   Мышь и трекбол распознаются автоматически.
   Для получения значений координат мыши и трекбола сделайте вызов
ввода  (А=12  или  А=16),  затем  выполните  вызов  для  реального
получения координат. В этом  случае  интервал  между  этими  двумя
вызовами должен быть минимальным.
   Для  получения  статуса  кнопки  триггера  мыши  или  джойстика
используйте GTTRIG, а не GTPAD.
Изм:    Все регистры

00DE GTPDL * 2
   Возвращает статус графического планшета (paddle).
Вход:   [A] - номер (1..12)
Выход:  [A] - угол поворота (0..255)
Изм:    Все регистры

              ∙ Доступ к кассетной ленте

00E1 TAPION * 1
   Включает мотор и считывает длинный или  короткий  заголовок  с
ленты. В это же время устанавливается скорость передачи данных  и
соответственно устанавливается рабочая область.
Вход:   Ничего
Выход:  Флаг C=1 в случае ненормального завершения
Изм:    Все регистры. Прерывания запрещены

00E4 TAPIN * 1
   Читает один байт с ленты.
Вход:   Ничего
Выход:  [A] - данные;
        флаг C=1 в случае ненормального завершения
Изм:    Все регистры

00E7 TAPIOF * 1
   Заканчивает чтение с ленты (останавливается мотор).
Вход:   Ничего
Выход:  Разрешаются прерывания
Изм:    Ничего
                         105  

00EA TAPOON * 1
   Включает мотор и записывает заголовок указанного типа.
Вход:   [A]<>0 - для записи длинного заголовка,
            =0 - для записи короткого;
Выход:  флаг C=1 в случае ненормального завершения 
Изм:    Все регистры. Прерывания запрещены

00ED TAPOUT * 1
   Записывает на ленту один байт.
Вход:   [A] - записываемое значение
Выход:  Флаг C=1 в случае ненормального завершения
Изм:    Ничего

00F0 TAPOOF * 1
   Заканчивает запись на ленту (останавливает мотор).
Вход:   Ничего
Выход:  Флаг C=1 в случае ненормального завершения 
        Прерывания разрешены
Изм:    Ничего

00F3 STMOTR * 1
   Управляет мотором.
Вход:   [A] - 0 - для остановки, 1 - для  включения;
              255 - изменить текущий статус.
Выход:  Ничего
Изм:    AF

           ∙ Обработка очередей (для оператора PLAY)

00F6 LFTQ
   Возвращает количество байтов, оставшихся в очереди.
Вход:
Выход:
Изм:

00F9 PUTQ
   Помещает байт в очередь.
Вход:
Выход:
Изм:
                         106  

      ∙ Подпрограммы, используемые модулями GENGRP и ADVGRP

00FF LEFTC
   Сдвигает на один пиксель влево (GRACX уменьшается).
Вход:
Выход:
Изм:

0102 UPC
   Сдвигает на один пиксель вверх (GRACY уменьшается).
Вход:
Выход:
Изм:

0105 TUPC
   Сдвигает на один пиксель вверх (GRACY уменьшается).
Вход:
Выход:
Изм:

0108 DOWNC
   Сдвигает на один пиксель вниз (GRACY наращивается).
Вход:
Выход:
Изм:

010B TDOWNC
   Сдвигает на один пиксель вниз (GRACY наращивается).
Вход:
Выход:
Изм:

010E SCALXY
   Масштабирует координаты XY.
Вход:   [BC] - X, [DE] - Y
Выход:  [BC] - модуль ширины X, [DE] - модуль ширины Y
Изм:
                         107  

0111 MAPXY
   Соотносит координаты с физическим адресом
Вход:   [BC] - X, [DE] - Y
Выход:  [HL] - адрес видеопамяти, [A] - маска
Изм:

0114 FETCHC
   Выдает текущий физический адрес и конфигурацию маски.
Вход:   Ничего
Выход:  [HL] - адрес, [A] - маска
Изм:    A,HL

0117 STOREC
   Записывает физический адрес и маску.
Вход:   [HL] - адрес, [A] - маска
Выход:  Ничего
Изм:

011A SETATR
   Устанавливает байт атрибута.
Вход:
Выход:
Изм:

011D READC
   Считывает атрибут текущего пикселя. Вызывает расширенное  ПЗУ,
если SCREEN больше 3.
Вход:
Выход:
Изм:

0120 SETC
   Устанавливает текущий  пиксель  в  соответствии  со  значением
указанного атрибута (ATTRBYT). Вызывает расширенное ПЗУ, если  Вы
в SCREEN 3.
Вход:
Выход:
Изм:
                         108  

0126 GTASPC
   Возвращает коэффициент сжатия CIRCLE.
Вход:   Ничего
Выход:  [DE]
        [HL]
Изм:    DE,HL

0129 PNTINI
   Инициализирует оператор PAINT.
Вход:
Выход:
Изм:

012C SCANR
   Сканирует пиксели слева направо (PAINT).
Вход:
Выход:
Изм:

012F SCANL
   Сканирует пиксели справа налево (PAINT).
Вход:
Выход:
Изм:

            ∙ Дополнительные подпрограммы

0132 CHGCAP * 1
   Включает и выключает индикатор CAPS.
Вход:   [A] - 0 -для выключения, <>0 - для включения
Выход:  Ничего
Изм:    AF

0135 CHGSND * 1
   Изменяет бит включения/выключения звука 7 порта C PSG.
Вход:   [A] - 0 - для выключения, <>0 - для включения.
Выход:  Ничего
Изм:    AF
                         109  

0138 RSLREG * 1
   Считывает текущие данные, вводимые в первичный слот (порт A).
Вход:   Ничего
Выход:  [A] - считанное значение
Изм:    A

013B WSLREG * 1
   Записывает в регистр первичного слота (порт A).
Вход:   [A]
Выход:  Ничего
Изм:    Ничего

013E RDVDP * 1
   Считывает регистр статуса VDP.
Вход:   Ничего
Выход:  [A] - читанное значение
Изм:    A

0141 SNSMAT * 1
   Возвращает  статус   указанной   строки   матрицы   клавиатуры
(записывает в порт C и считывает порт D).
Вход:   [A] - номер строки матрицы клавиатуры
Выход:  [A] - статус строки (соответствующий нажатой  клавише бит
              сбрасывается в 0)
Изм:    AF,C

0144 PHYDIO
   Выполняет операции на устройстве внешней памяти (дисковод).  В
минимальной конфигурации обеспечивается только одна ловушка.
Вход:   см. BDOS
Выход:
Изм:    ?

0147 FORMAT
   Выполняет  инициализацию  на  устройстве  внешней  памяти.   В
минимальной конфигурации обеспечивается только одна ловушка.
Вход:
Выход:
Изм:
                         110  

014A ISFLIO * 1
   Проверяет,  выполняет  ли  устройство  операцию   ввода/вывода
(активно ли).
Вход:   Ничего
Выход:  A=0 - активно, А<>0 - неактивно
Изм:    AF

014D OUTDLP * 1
   Вывод на LPT. Эта подпрограмма отличается от LPTOUT следующим:
TAB преобразуется в пробел; при прерывании осуществляется переход
на сообщение 'Device I/O error'; преобразует hiragana в  katakana
на не MSX-принтерах
Вход:   [A] - код
Выход:  Ничего
Изм:    AF

0150 GETVCP
   Проигрывает музыку в режиме фоновой задачи.
Вход:   [A] - номер канала (0-2)
Выход:
Изм:

0153 GETVC2
   Проигрывает музыку в режиме фоновой задачи.
Вход:
Выход:
Изм:

0156 KILBUF * 1
   Очищает буфер клавиатуры.
Вход:   Ничего
Выход:  Ничего
Изм:    HL

0159 CALBAS * 1
   Выполняет межслотовый вызов подпрограммы интерпретатора  языка
MSX-BASIC.
Вход:   [IX] адрес
Выход:  ?
Изм:    ?
                         111  

           ∙ Точки входа, добавленные в MSX-2 

015C SUBROM * 1
   Выполняет межслотовый вызов SUBROM EBIOS
Вход:   [IX] - записанный в стеке адрес подпрограммы EBIOS
Выход:  ?
Изм:    IX,IY зарезервированы

015F EXTROM
   Выполняет межслотовый вызов SUBROM EBIOS
Вход:   [IX] - адрес подпрограммы EBIOS
Выход:  ?
Изм:    IX,IY зарезервированы

0162 CHKSLZ
   Сканирует слот из SUBROM.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

0165 CHEKNEW
   Проверяет режим экрана.
Вход:   Ничего
Выход:  Флаг C=0, если SCREEN 5-8
Изм:    AF

0168 EOL
   Стирает до конца строки.
Вход:   [H] - номер  колонки, [L] - номер строки.
        Курсор  должен остаться неизмененным.
Выход:  Ничего
Изм:    Все регистры

016B BIGFIL
   То  же, что  и  FILVRM, за  исключением   следующего:   FILVRM
проверяет, является ли текущим режимом экрана 0-3. Если это  так,
то он ведет себя так же, как VDP, имеющий видеопамять  только  16
К.  Это  необходимо  для   сохранения   совместимости   с   MSX1.
BIGFIL, однако, не проверяет режим экрана и заполняет видеопамять
так, как определено параметрами.
                         112  

Вход:   [HL] - адрес, [BC] - длина, [A] - записываемое значение
Выход:  Ничего
Изм:    AF,BC

016E NSETRD
   Устанавливает VDP для чтения.
Вход:   [HL] - адрес VRAM
Выход:  Ничего
Изм:    AF

0171 NSTWRT
   Устанавливает VDP для записи.
Вход:   [HL] - адрес VRAM
Выход:  Ничего
Изм:    AF

0174 NRDVRM
   Считывает видеопамять, адресованную посредством [HL].
Вход:   [HL] - адрес VRAM
Выход:  [A] - прочитанный байт
Изм:    F

0177 NWRVRM
   Записывает [A] в видеопамять, адресованную [HL].
Вход:   [HL] - адрес, [A] - данные
Выход:  Ничего
Изм:    AF

      ∙  Расширенное ПЗУ

   Вызов расширенного ПЗУ (например, INIPLT):
        ld      IX,INIPLT
        call    EXTROM
   ; возврат сюда 
        ...
   Второй вариант:
INIPAL: push    ix
        ld      ix,INIPLT
        jp      SUBROM
   ; возврат в вызвавшую INIPAL программу
                         113  

   Третий вариант:
        ld      iy,(EXBRASA-1)
   ; получает адрес слота расширенного ПЗУ
        ld      ix,INIPLT
        call    CALSLT

      ∙ Работа с графическими средствами BASIC

0069 PAINT
   Выполняет закраску. Для SCREEN 5-8.
Вход:   [HL] содержит текстовый указатель на внутреннее  предс-
        тавление оператора (токен) BASIC
Выход:  [HL] содержит обновленный текстовый указатель
Изм:    Все регистры

006D PSET
   Устанавливает точку. Для SCREEN 5-8.
Вход:   [HL] как в предыдущем случае
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры

0071 ATRSCN
   Сканирует атрибут цвета. Для SCREEN 5-8.
Вход:   [HL] как в предыдущем случае
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры

0075 GLINE
   Рисует линию. Для SCREEN 5-8.
Вход:   [HL] как в предыдущем случае
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры

0079 DOBOXF
   Рисует закрашенный квадрат. Для SCREEN 5-8.
Вход:   [HL] как в предыдущем   случае.  Начальная   координата
        ([BC],[DE]). Конечная координата (GXPOS,GYPOS)
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры
                         114  

007D DOLINE
   Рисует линию. Для SCREEN 5-8.
Вход:   [HL] как в предыдущем  случае.   Начальная   координата
        ([BC],[DE]). Конечная координата (GXPOS,GYPOS)
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры

0081 BOXLIN
   Рисует квадрат. Для SCREEN 5-8.
Вход:   [HL]  как  в  предыдущем  случае. Начальная  координата
        ([BC],[DE]). Конечная координата (GXPOS,GYPOS)
Выход:  [HL] как в предыдущем случае
Изм:    Все регистры

              ∙  Графика нижнего уровня

0085 DOGRPH
   Рисует линию. Для SCREEN 5-8.
Вход:   Начальная  координата ([BC],[DE]). Конечная  координата
        (GXPOS,GYPOS). Атрибут в (ATRBYT). Код логической  опе-
        рации (LOGOPR)
Выход:  Ничего
Изм:    AF

0089 GRPPTR
   Выводит символ на графическом экране (только для SCREEN 5-8).
Вход:   [A] -код. Цвет - (ATRBYT), код логической  операции -
        (LOGOPR)
Выход:  Ничего
Изм:    Ничего

008D SCALXY
   Масштабирует координаты XY.
Вход:   [BC] горизонтальная позиция. [DE] вертикальная позиция
Выход:  [BC] усеченная горизонтальная  позиция. [DE]  усеченная
        вертикальная позиция
Изм:    AF
                         115  

0091 MAPXYC
   Соотносит координату с физическим адресом. Для SCREEN 3,5-8.
Вход:   Координата ([BC],[DE])
Выход:  SCREEN 3: [HL] - адрес видеопамяти (CLOC). [A] и (CMASK)
        - маска битов
        SCREEN 5-8: [HL] и (CLOC) - горизонтальная позиция [A] и
        (CMASK) - вертикальная позиция
Изм:    F

0095 READC
   Считывает атрибут текущего пикселя. Для SCREEN 3,5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  [A] - атрибут
Изм:    AF

0099 SETATR
   Устанавливает байт атрибута.
Вход:   [A] - атрибут
Выход:  Флаг C=1, если атрибут недействителен
Изм:    F

009D SETC
   Устанавливает текущий пиксель на указанный атрибут. Для SCREEN
3,5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Ничего
Изм:    AF

00A1 TRIGHT
   Сдвигает на один пиксель вправо. Для SCREEN 5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK). Флаг C=1, если
        указаная координата находится на границе экрана.
Изм:    AF

00A5 RIGHTC
   Сдвигает на один пиксель вправо. Для SCREEN 3.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK)
Изм:    AF
                         116  

00A9 TLEFTC
   Сдвигает на один пиксель влево. Для SCREEN 3, 5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK). Флаг C=1, если
        указаная координата находится на границе экрана.
Изм:    AF

00AD LEFTC
   Сдвигает на один пиксель влево. Для SCREEN 3.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK)
Изм:    AF

00B1 TDOWNC
   Сдвигает на один пиксель вниз. Для SCREEN 3, 5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK). Флаг C=1, если
        указаная координата находится на границе экрана.
Изм:    AF

00B5 DOWNC
   Сдвигает на один пиксель вниз. Для SCREEN 3.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK). Флаг C=1, если
        указаная координата находится на границе экрана.
Изм:    AF

00B9 TUOC
   Сдвигает на один пиксель вверх. Для SCREEN 3, 5-8.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK). Флаг C=1, если
        указаная координата находится на границе экрана.
Изм:    AF

00BD UPC
   Сдвигает на один пиксель вверх. Для SCREEN 3.
Вход:   Координата (CLOC) и (CMASK)
Выход:  Измененная координата (CLOC) и (CMASK)
Изм:    AF
                         117  

00C1 SCANR
   Сканирует пиксели слева направо. Для SCREEN 3, 5-8.
Вход:   [B] - флаг задержки; [DE] - счетчик границы
Выход:  [DE] - счетчик границы; [C] - флаг изменения пикселя
Изм:    Все регистры

00C5 SCANL
   Сканирует пиксели справа налево . Для SCREEN 3,5-8.
Вход:   [DE] - счетчик границы
Выход:  [DE] - счетчик границы; [C] - флаг изменения пикселя
Изм:    Все регистры

00C9 NVBXLN
   Рисует квадрат. Для SCREEN 5-8.
Вход:   Начальная координата ([BC],[DE]); Конечная   координата
        (GXPOS,GYPOS); Цвет -(ATRBYT); Код логической операции
        в (LOGOPR)
Выход:  Ничего
Изм:    Все регистры

00CD NVBXFL
   Рисует закрашенный квадрат. Для SCREEN 5-8.
Вход:   Начальная координата ([BC],[DE]); Конечная   координата
        (GXPOS,GYPOS); Цвет в (ATRBYT); Код логической операции в
        (LOGOPR)
Выход:  Ничего
Изм:    Все регистры

          ∙  Доступ к VDP (видеопроцессору 9938)

00D1 CHGMOD
   Изменяет режим VDP.
Вход:   [A] - режим экрана
Выход:  Ничего
Изм:    Все регистры
                         118  

00D5 INITXT
   Инициализирует   экран   для   текстового   режима    (40*24),
устанавливает VDP.
Вход:   TXTNAM, TXTCGP
Выход:  Ничего
Изм:    Все регистры

00D9 INIT32
   Инициализирует   экран   для   текстового   режима    (32*24),
устанавливает VDP.
Вход:   T32NAM, T32CGP, T32COL, T32ATR, T32PAT
Выход:  Ничего
Изм:    Все регистры

00DD INIGRP
   Инициализирует   экран   для   режима   высокого   разрешения,
устанавливает VDP.
Вход:   GRPNAM, GRPCGP, GRPCOL, GRPATR, GRPPAT
Выход:  Ничего
Изм:    Все регистры

00E1 INIMLT
   Инициализирует экран для многоцветного  режима,  устанавливает
VDP.
Вход:   MLTNAM, MLTCGP, MLTCOL, MLTATR, MLTPAT
Выход:  Ничего
Изм:    Все регистры

00E5 SETTXT
   Устанавливает VDP для текстового (40*24) режима.
Вход:   TXTNAM, TXTCGP
Выход:  Ничего
Изм:    Все регистры

00E9 SETT32
   Устанавливает VDP для текстового (32*24) режима.
Вход:   T32NAM, T32CGP, T32COL, T32ATR, T32PAT
Выход:  Ничего
Изм:    Все регистры
                         119  

00ED SETGRP
   Устанавливает VDP для режима высокого разрешения.
Вход:   GRPNAM, GRPCGP, GRPCOL, GRPATR, GRPPAT
Выход:  Ничего
Изм:    Все регистры

00F1 SETMLT
   Устанавливает VDP для многоцветного режима.
Вход:   MLTNAM, MLTCGP, MLTCOL, MLTNAM, MLTPAT
Выход:  Ничего
Изм:    Все регистры

00F5 CLRSPR
   Инициализирует все спрайты. Образы очищаются, номера  спрайтов
устанавливаются   по   значениям   плоскостей   спрайтов,    цвет
устанавливается  на  значение  цвета  фона. Вертикальная  позиция
устанавливается на 217.
Вход:   SCRMOD
Выход:  Ничего
Изм:    Все регистры

00F9 CALPAT
   Возвращает адрес образа спрайта.
Вход:   [A] - номер спрайта
Выход:  [HL] - адрес используемого спрайтом образа
Изм:    AF,DE,HL

00FD CALATR
   Возвращает адрес атрибутов спрайта.
Вход:   [A] - номер спрайта
Выход:  [HL] - адрес используемых спрайтом атрибутов
Изм:    AF,DE,HL

0101 GSPSIZ
   Возвращает размер спрайта.
Вход:   Ничего
Выход:  [A] - число байтов в спрайте
        Флаг C=1, если 16*16
Изм:    AF
                         120  

0105 GETPAT
   Возвращает образ символа.
Вход:   [A] - код символа
Выход:  Образ символа в (PATWRK)
Изм:    Все регистры

0109 WRTVRM
   Запись в видеопамять.
Вход:   [HL] - адрес VRAM (0..FFFFh), [A] - данные
Выход:  Ничего
Изм:    AF

010D RDVRM
   Чтение из видеопамяти VRAM (0..FFFFh).
Вход:   [HL] - адрес
Выход:  [A] - данные
Изм:    AF

0111 CHGCLR
   Изменяет цвет экрана.
Вход:   FORCLR,BAKCLR,BRDCLR
Выход:  Ничего
Изм:    Все регистры

0115 CLSSUB
   Очищает экран.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

0119 CLRTXT
   Очищает текстовый экран.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры
                         121  

 T34011D DSPFNK
   Отображает функциональные клавиши.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

0121 DELLN0
   Удаляет строку в текстовом режиме.
Вход:   [L] - номер строки.
Выход:  Ничего
Изм:    Все регистры

0125 INSLN0
   Вставляет строку в текстовом режиме.
Вход:   Номер строки в [L]
Выход:  Ничего
Изм:    Все регистры

0129 PUTVRM
   Вставляет символ в текстовом режиме.
Вход:   [H] - номер колонки, [L] - номер строки
Выход:  Ничего
Изм:    AF

012D WRTVDP
   Запись в регистр VDP.
Вход:   [B] - данные, [C] - номер регистра
Выход:  Ничего
Изм:    AF,BC

0131 VDPSTA
   Считывает статус VDP.
Вход:   [A] - регистр статуса (0-9)
Выход:  [A] - значение
Изм:    F

013D SETPAG
   Переключает активные и отображаемые страницы (SET PAGE).
Вход:   (ACPAGE), (DPPAGE)
Выход:  Ничего
Изм:    AF
                         122  

              ∙ Доступ к палитре

   Палитра  видеопроцессора  состоит  из  трех  цветов   (красный,
зеленый,  синий).  Каждый  цвет  имеет  3  бита  для   отображения
интенсивности. Текущая палитра записана в  видеопамяти,  поскольку
не имеется возможности считывать палитру из видеопроцессора (VDP).

0141 INIPLT
   Инициализирует палитру ( текущая палитра сохраняется во VRAM )
Вход:   Ничего
Выход:  Ничего
Изм:    AF,BC,DE

0145 RSTPLT
   Восстанавливает палитру из видеопамяти.
Вход:   Ничего
Выход:  Ничего
Изм:    AF,BC,DE

0149 GETPLT
   Получает коды цветов из палитры.
Вход:   [A] - палитра (0-15)
Выход:  [B] - RED, красный (старшие 4 бита);
        [B] - BLUE, синий (младшие 4 бита);
        [C] - GREEN, зеленый (младшие 4 бита)
Изм:    AF,DE

014D SETPLT
   Задает цвета для указанной палитры.
Вход:   [D] - номер палитры (0-15);
        Код RED (красный) в старших 4 битах [A];
        Код BLUE (синий) в младших 4 битах [A];
        Код GREEN (зеленый) в младших 4 битах [E]
Выход:  Ничего
Изм:    AF
                         123  

         ∙ Операторы расширенного MSX-BASIC

0151 PUTSPR
   Помещает спрайты на экран.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0155 COLOR
   Изменяет цвет экрана, спрайта, палитру.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0159 SCREEN
   Изменяет режим экрана.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

015D WIDTHS
   Изменяет ширину текстового экрана.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0161 VDP
   Устанавливает регистр VDP.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0165 VDPF
   Считывает текущий регистр VDP.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры
                         124  

0169 BASE
   Устанавливает регистр базы VDP.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

016D BASEF
   Считывает регистр базы VDP.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0171 VPOKE
   Записывает один байт в видеопамять.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0175 VPEEK
   Считывает один байт из видеопамяти.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0179 SETS
   Устанавливает звук сигнала, настройку экрана, время и дату
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

                    ∙ Разные подпрограммы

017D BEEP
   Формирует короткий звуковой сигнал (зуммер).
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры
                         125  

 T340181 PROMPT
   Выводит подсказку.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

                ∙ Восстановление экрана

0185 SDFSCR
   Восстанавливает относящиеся  к  экрану  параметры  из  ОЗУ  на
микросхеме  таймера,  являющейся  энергонезависимой.  Не  выводит
текст функциональных клавиш, если перенос сброшен  при  обращении
из MSX-DOS.
Вход:   Флаг C=0 при обращении из MSX-DOS
Выход:  Ничего
Изм:    Все регистры

0189 SETSCR
   Восстанавливает экран и выводит открывающее сообщение.
Вход:   Ничего
Выход:  Ничего
Изм:    Все регистры

           ∙ Функции передачи данных для видеопамяти

018D SCOPY
   Копирует видеопамять, массивы и файлы на дискетах.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

0191 BLTVV
   Копирует видеопамять в видеопамять.
Вход:   [HL] = 0F562h
        SX    (F562H, 2) - координата X источника
        SY    (F564H, 2) - координата Y источника
        DX    (F566H, 2) - координата X получателя
        DY    (F568H, 2) - координата Y получателя
        NX    (F56AH, 2) - количество точек в направлении X
        NY    (F56CH, 2) - количество точек в направлении Y
        CDUMMY(F56EH, 1) - фиктивный, не требуется
                         126  

        ARG   (F56FH, 1) - выбор направления и расширения RAM
                           аналог R#45 VDP
        LOGOP (F570H, 1) - код логической операции (как в VDP)
Выход:  Флаг C сбрасывается
Изм:    Все регистры

0195 BLTVM
   Копирует массив в видеопамять.
Вход:   [HL] = 0F562h
        DPTR  (F562H, 2) - адрес источника в памяти
        DUMMY (F564H, 2) - фиктивный, не требуется
        DX    (F566H, 2) - координата X получателя
        DY    (F568H, 2) - координата Y получателя
        NX    (F56AH, 2) - количество точек в направлении X
                           (установка не требуется)
        NY    (F56CH, 2) - количество точек в направлении Y
                           (установка не требуется)
        CDUMMY(F56EH, 1) - фиктивный, не требуется
        ARG   (F56FH, 1) - выбор направления и расширения RAM
                           аналог R#45 VDP
        LOGOP (F570H, 1) - код логической операции (как в VDP)
   Необходимо зарезервировать память в следующих размерах:
        SCREEN 6: кол-во точек по X × кол-во точек по Y /4 +4
        SCREEN 5,7: кол-во точек по X × кол-во точек по Y /2 +4
        SCREEN 8: кол-во точек по X × кол-во точек по Y /2 +4
   Для диска или RAM первые два  байта  дают  количество  точек  в
направлении X, следующие два байта - в направлении Y.
Выход:  Флаг C устанавливается, если количество  байт передаваемых
        данных неправильно
Изм:    Все регистры

0199 BLTMV
   Копирует видеопамять в массив.
Вход:   [HL] = 0F562h
        SX     (F562H, 2) - координата X источника
        SY     (F564H, 2) - координата Y источника
        DPTR   (F566H, 2) - адрес получателя в памяти
        DUMMY  (F568H, 2) - фиктивный, не требуется
        NX     (F56AH, 2) - количество точек в направлении X
        NY     (F56CH, 2) - количество точек в направлении Y
                           127  

 T34        CDUMMY (F56EH, 1) - фиктивный, не требуется
        ARG    (F56FH, 1) - выбор направления и расширения RAM
                            аналог R#45 VDP
Выход:  Флаг С сбрасывается
Изм:    Все регистры

019D BLTVD
   Копирует файл с дискеты в видеопамять.
Вход:   [HL] = 0F562h
        FNPTR  (F562H, 2) - адрес имени файла
        DUMMY  (F564H, 2) - фиктивный, не требуется
        DX     (F566H, 2) - координата X получателя
        DY     (F568H, 2) - координата Y получателя
        NX     (F56AH, 2) - количество точек в направлении X
                            (установка не требуется)
        NY     (F56CH, 2) - количество точек в направлении Y
                            (установка не требуется)
        CDUMMY (F56EH, 1) - фиктивный, не требуется
        ARG    (F56FH, 1) - выбор направления и расширения RAM
                            аналог R#45 VDP
        LOGOP (F570H, 1)  - код логической операции (как в VDP)
   Имя файла устанавливается следующим образом:
         LD   HL,FLNAME
         LD   (FNPTR),HL
         ...  ...
 FLNAME: DB   22h,'B:TEST.SCR',22h,0
   При  возникновении  ошибки   управление   передается   на   хук
MSX-BASIC'a H.ERRO (FFB1h).
Выход:  Флаг С устанавливается, если была ошибка в параметрах
Изм:    Все регистры

01A1 BLTDV
   Копирует видеопамять в файл на дискете.
Вход:   [HL] = 0F562h
        SX     (F562H, 2) - координата X источника
        SY     (F564H, 2) - координата Y источника
        FNPTR  (F566H, 2) - адрес имени файла
        DUMMY  (F568H, 2) - фиктивный, не требуется
        NX     (F56AH, 2) - количество точек в направлении X
        NY     (F56CH, 2) - количество точек в направлении Y
        CDUMMY (F56EH, 1) - фиктивный, не требуется
                         128  

Выход:  Флаг С сбрасывается
Изм:    Все регистры

01A5 BLTMD
   Загружает данные в массив из файла на дискете.
Вход:   [HL] = 0F562h
        FNPTR  (F562H, 2) - адрес имени файла
        SY     (F564H, 2) - фиктивный, не требуется
        SPTR   (F566H, 2) - стартовый адрес для загрузки
        EPTR   (F568H, 2) - конечный адрес загрузки
Выход:  Флаг С сбрасывается
Изм:    Все регистры

01A9 BLTDM
   Записывает данные из массива в файл на дискете.
Вход:   [HL] = 0F562h
        SPTR   (F562H, 2) - стартовый адрес для записи
        EPTR   (F564H, 2) - конечный адрес для записи
        FNPTR  (F566H, 2) - адрес имени файла
Выход:  Флаг С сбрасывается
Изм:    Все регистры

                ∙ Работа с манипуляторами

01AD NEWPAD
   Считывает  данные  с  аналогово-игрового   манипулятора,   с
манипуляторов типа "Мышь" и "Трекбол", светового пера.
Вход:   Коды подпрограммы работы с манипуляторами.   Передаются
        через параметр GTPAD в заголовке BIOS (00DBh)
        [A] =
        8 - опрос светового пера (возвращает  255,  если  опрос
            происходит нормально)
        9  - возвращает координату X
        10 - возвращает координату Y
        11 - возвращает статус кнопки пера  (255,  если  кнопка
             нажата)
        12 - опрос, подключена ли мышь к разъему 1
        13 - возвращает смещение X
        14 - возвращает смещение Y
        15 - всегда 0
                           129  

        16 - опрос, подключена ли мышь к разъему 2
        17 - возвращает смещение X
        18 - возвращает смещение Y
        19 - всегда 0
Выход:  [A] - значение
Изм:    Все регистры

Прим:   В  процессе  опроса  получаются  реальные  координаты X, Y
        мыши, которые записываются  в  однобайтные  ячейки  памяти
        FAFE и FB00. Функции 13/14 и  17/18  просто  передают  эти
        байты как результат. Поэтому рекомендуется выполнить  один
        раз вызов с параметром 12 или 16, чтобы узнать, подключена
        ли  мышь  и  куда,  а  дальше  просто   загружать   нужные
        координаты X,Y из соответствующих ячеек [LD A,(0FAFEh) или
        LD A,(0FB00h)].


                   ∙ Разное

01B1 GETPUT
   Обращение к подпрограммам GET TIME, GET DATE и PUT KANJI.
Вход:   [HL] - указатель текста
Выход:  [HL] - измененный указатель текста
Изм:    Все регистры

01B5 CHGMDP
   Изменяет режим VDP. Палитра инициализируется.
Вход:   [A] - режим экрана (0-8)
Выход:  Ничего
Изм:    Все регистры

01B9 RESVL
   Не используется. Зарезервирована.
Вход
Выход:
Изм:


                         130  


      ∙ Доступ к микросхеме таймера и энергонезависимой памяти

01F5 REDCLK
   Считывает данные микросхемы таймера и энергонезависимой памяти
CLOCK-IC (астрономическое время, пароль, тип экрана, цвет, ...)
Вход:   [C] - адрес RAM CLOCK-IC:
              бит   7 6  5  4  3  2  1  0
              [C]   0 0 M1 M0 A3 A2 A1 A0
        M1 M0 - номер блока CLOCK-IC
        A3 A2 A1 A0 - номер регистра CLOCK-IC
Выход:  [A] - считанные данные (действительны младшие 4 бита)
Изм:    F
01F9 WRTCLK
   Записывает данные в RAM CLOCK-IC:
Вход:   [C] - адрес RAM CLOCK-IC:
             бит   7 6  5  4  3  2  1  0
             [C]   0 0 M1 M0 A3 A2 A1 A0
        M1 M0 - номер блока CLOCK-IC
        A3 A2 A1 A0 - номер регистра CLOCK-IC
        [A] - записываемое значение
Выход:  Ничего
Изм:    F















                         131  
           ПРИЛОЖЕНИЕ 4. ВХОДНЫЕ ТОЧКИ BDOS

   Ниже приведен список  основных  входных  точек  MSX  BDOS.  Код
входной  точки  передается  DOS   через   регистр   C,   остальные
используемые регистры указаны в строках Вход и Выход.
Примечания:
  ∙ Функции, обозначенные 'NO FUNCTION' возвращают 0 в регистре
    [A]
  ∙ [CP] - совместимость с CP/M
  ∙ [-]  - нет совместимости
  ∙ FCB означает File Control Block, блок управления файлом

00  [CP] SYSTEM RESET
   Если MSX-DOS, то переход по адресу 0000; иначе,  осуществляется
'теплый' старт DISK BASIC.
Вход:           Нет
Выход:          Нет

01  [CP] CONSOLE INPUT
   Ввод символа с клавиатуры. Если  нажато  CTRL-C,  то  выполняет
функцию 00; если CTRL-P,  то  начинается  выдача  эхо-сигналов  на
печать; если CTRL-N, то прекращает выдачу эхо-сигналов на  печать.
Вводимый символ отображается на экране.
Вход:           Нет
Выход:          Регистр А содержит код ASCII символа,
                введеного с  клавиатуры.

02  [CP] CONSOLE OUTPUT
   Вывод символа, код ASCII которого находится в  регистре  Е,  на
экран терминала.
Вход:          E - код ASCII выводимого символа
Выход:         Символ на экране

03  [CP] AUX INPUT
   Ввод символа  с  устройства  AUX  (вспомогательное  устройство,
например, принтер или драйвер диска).
Вход:           Нет
Выход:          Регистр А содержит код ASCII-символа, введеного
                с устройства AUX.
                           132  

04 [CP]  AUX OUTPUT
   Вывод символа на устройство AUX.
Вход:           В регистре Е содержится код выводимого ASCII
                символа.
Выход:          Нет

05 [CP]  LST OUTPUT
   Вывод на печать ASCII символа.
Вход:           В регистре Е содержится код выводимого ASCII
                символа.
Выход:          Нет

06 [CP]  DIRECT CONSOLE I/O
   Если в Е находится FFh, то если  нет  ввода  с  клавиатуры,  то
возвращает 0. Иначе, возвращает ASCII-код введенного символа.  Нет
эхо-печати символов. Не фиксируются управляющие коды CTRL-*.
   Иначе, вывод символа из регистра Е на экран.
Вход:           Е  определяет функцию ввода или вывода, а также
                   хранит код выводимого символа (если вывод).
Выход:          А - если ввод, то содержит код введенного символа

07 [-]   DIRECT INPUT
   Ввод символа с клавиатуры.  Нет  эхо-символов.  Не  фиксируются
управляющие коды CTRL-*.
Вход:           Нет
Выход:          А содержит код введенного символа.

08 [-]   DIRECT INPUT
   Ввод символа с клавиатуры (без  эха).  Фиксируются  управляющие
коды CTRL-C, CTRL-P, CTRL-N.
Вход:           Нет
Выход:          А содержит код введенного символа.

09 [CP]  STRING OUTPUT
   Вывод строки, начальный адрес которой  указывает  пара  DE,  до
символа '$' если он встретится в этой строке.
Вход:           DE содержит адрес первого символа строки.
Выход:          Вывод строки
                           133  

0А [CP]  BUFFERED INPUT
   Ввод строки с клавиатуры до нажатия клавиши  возврата  каретки.
Первый символ строки заносится по адресу [DE+2]. По адресу  [DE+1]
заносится число введенных символов строки (не считая  кодов  LF  и
CR). По адресу [DE] хранится максимальное число символов в строке,
которое может быть введено.
Вход:           DE определяет адрес буфера, отводимого на хранение
                вводимой строки,
                (DE) определяет максимальное количество символов,
                которое может быть введено ( 0 ..255)
Выход:          (DE)+1 - длина, (DE)+2, ... - введенная строка

0B [CP]  CONSOLE STATUS
   Eсли нет ввода с клавиатуры, то возвращает 0; иначе, возвращает
FFh.
Вход:           Нет
Выход:          А содержит состояние клавиатуры: 0 или FFh.

0C [CP]  GET VERSION NUMBER
   Oпределение номера версии.
Вход:           Нет
Выход:          HL содержит номер версии (H: 0; L: 22h)

0D [CP]  DISK RESET
   Устанавливает драйвер диска  по  умолчанию  (А:)  Устанавливает
адрес передачи равным  80h.  Стирает  все  сектора,  которые  были
изменены, но не были записаны на диск.
Вход:           Нет
Выход:          Нет

0E [CP]  SELECT DISK
   Устанавливает драйвер диска  по  умолчанию  (  0  соответствует
устройству А: ).
Вход:           Е содержит номер драйвера диска (0,1,...)
Выход:          Нет

0F [CP]  OPEN FILE
   Открывает файл,  определяемый  FCB,  начальный  адрес  которого
содержится в DE. Поле размера записи, поле  текущего  блока,  поле
текущей записи и поле записи  прямого  доступа  будут  установлены
                           134  

после выполнения функции. Поле размера файла, поля даты и  времени
создания, поле идентификатора устройства (ID),  поле  расположения
каталога, поле первого кластера, поле последнего кластера  и  поле
последнего  доступного  кластера  копируются  из  каталога.   Если
функция выполнилась, то возвращает 0; иначе, FFh.
Вход:           DE: указывает на первый байт FCB
Выход:          A: 0, если файл открылся; FFh, в противном случае

10 [CP]  CLOSE FILE
   Закрывает файл,  определяемый  FCB,  начальный  адрес  которого
содержится в DE. Если функция выполнилась, то возвращает 0; иначе,
- FFh.
Вход:           DE: указывает на первый байт FCB
Выход:          A: 0, если файл закрылся; FFh, в прот. случае

11 [CP]   SEARCH FIRST
   Поиск первого появления  файла,  определяемого  FCB,  начальный
адрес которого содержится в DE. Если файл  найден,  входная  точка
каталога  (32  байта)  копируется  по   адресу   передачи   (DMA),
возвращается 0; иначе, возвращает FFh.
   Примечание. В имени файла возможны спец. символы (* и ?).
Вход:           DE указывает на первый байт FCB
Выход:          A - 0, если файл найден, копирование DIR в DMA;
                   FFh, в противном случае

12 [CP]   SEARCH NEXT
   Поиск  следующего  появления  файла,  определенного   последним
вызовом функции SEARCH FIRST.  Если  файл  найден,  входная  точка
каталога  (32  байта)  копируется  по   адресу   передачи   (DMA),
возвращается 0; иначе, возвращает FFh.
   Примечание. В имени файла возможны спец. символы (* и ?).
Вход:           Нет
Выход:          A  - 0, если файл найден; FFh, в противном случае


                           135  

13 [CP]  DELETE FILE
   Стирает  файл,  определяемый  FCB,  начальный  адрес   которого
содержится в DE. Если функция выполнилась, то возвращает 0; иначе,
- FFh.
   Примечание. В имени файла возможны спец. символы (* и ?).
Вход:           DE указывает на первый байт FCB
Выход:          A  0, если файл был удален;
                   FFh, в противном случае

14 [CP]  SEQUENTAL READ
   Читает  запись  файла,  определяемого  FCB,   начальный   адрес
которого содержится в DE. Передает прочитанную  запись  по  адресу
передачи. Запись определяется полем текущего блока и полем текущей
записи. Поля текущего блока и текущей записи  увеличиваются  на  1
при выходе из функции. Размер записи всегда равен 128 байтам. Если
функция выполнилась, то возвращает 0; иначе, - 1.
   Примечание. Эта функция оставлена  для  совместимости  с  CP/M.
Настоятельно рекомендуется использовать  другую  функцию:  'RANDOM
BLOCK READ'.
Вход:           DE указывает на первый байт FCB
Выход:          A  0, если чтение выполнилось;
                   1, в противном случае

15 [CP]  SEQUENTAL WRITE
   Посылает запись  в  файл,  определяемый  FCB,  начальный  адрес
которого содержится в DE. Запись определяется полем текущего блока
и полем текущей записи.  Поля  текущего  блока  и  текущей  записи
увеличиваются на 1 при выходе из  функции.  Размер  записи  всегда
равен 128 байтам.  Если  функция  выполнилась,  то  возвращает  0;
иначе, - 1.
   Примечание. Эта функция оставлена  для  совместимости  с  CP/M.
Настоятельно рекомендуется использовать  другую  функцию:  'RANDOM
BLOCK WRITE'.
Вход:           DE указывает на первый байт FCB
Выход:          A 0, если запись выполнена; 1, в противном случае

16 [CP]  CREATE FILE
   Открывает файл,  определяемый  FCB,  начальный  адрес  которого
содержится в DE. Если данный файл уже существует, то он стирается.
Поле размера записи, поле текущей записи, поле  текущего  блока  и
                           136  

поле записи произвольного доступа устанавливаются после выполнения
этой функции. Если функция выполнилась, то возвращает 0; иначе,  -
FFh.
Вход:           DE указывает на первый байт FCB
Выход:          A - 0, если файл открылся; FFh, в противном случае

17 [CP]  RENAME FILE
   Меняет имя файла, определяемого FCB, начальный  адрес  которого
содержится в DE, на имя файла, определяемое FCB,  начальный  адрес
которого  содержится  в  (DE+16).  Если  функция  выполнилась,  то
возвращает 0; иначе, - FFh.
   Примечание. В имени файла возможны спец. символы (* и ?).
Вход:           DE указывает на первый байт FCB старого файла;
                (DE+16) указывает на первый байт FCB нового 
                файла
Выход:          A - 0, если файл переименован;
                    FFh, в противном случае

18 [CP]  GET LOGIN VECTOR
   Возвращает  таблицу  битов  для  включенных  устройств  (вектор
начального состояния системы). В отличие от  CP/M,  все  системные
устройства включены.
Вход:           Нет
Выход:          HL содержит вектор начального состояния системы

19 [CP]  GET DEFAULT DRIVE NAME
   Возвращает номер текущего устройства (по умолчанию).
Вход:           Нет
Выход:          А - имя (номер) устройства по умолчанию (0,1,..)

1А [CP]  SET DMA ADDRESS
   Устанавливает адрес передачи.
Вход:           DE устанавливаемый (новый) адрес передачи
                    (буфера дисковода, DMA)
Выход:          Нет

                           137  

1B [-]   GET ALLOCATION
   Возвращает информацию о драйвере, определенном  в  регистре  Е,
если имя драйвера правильное; иначе, возвращает FFh.
Вход:           Е: номер (имя) драйвера
Выход:          А: число секторов в кластере или
                    FFh (при неудаче);
                Если А: не FFh:
                  BC: размер сектора (байт);
                  DE: кол-во кластеров на диске;
                  HL: кол-во свободных кластеров;
                  IX: указатель на блок параметров драйвера DPB;
                  IY: указатель на таблицу размещения файла FAT.

   ∙ Системные вызовы для CP/M версии 2.0 и более поздних версий

1C [-]   NO FUNCTION
   Установка вектора защиты записи

1D [-]   NO FUNCTION
   Чтение вектора защиты записи

1Е [-]   NO FUNCTION
   Установка атрибутов файла

1F [-]   NO FUNCTION
   Чтение адреса параметров диска

20 [-]   NO FUNCTION
   Установка/чтение кода пользователя

21 [CP]  RANDOM READ
   Чтение записи файла произвольного доступа,  определяемого  FCB,
начальный адрес которого содержится в DE.  Запись  переносится  по
адресу передачи. Запись  определяется  полем  блока  произвольного
доступа. Это поле не изменяется  при  выполнении  данной  функции.
Размер записи  всегда  128  байт.  Если  функция  выполнилась,  то
возвращает 0; иначе, - 1.
   Примечание. Эта функция оставлена  для  совместимости  с  CP/M.
                           138  

Настоятельно рекомендуется использовать  другую  функцию:  'RANDOM
BLOCK READ'.
Вход:           DE: указывает на первый байт FCB
Выход:          A: 0, если запись прочиталась;
                   1, в противном случае

22 [CP]  RANDOM WRITE
   Посылает запись в файл произвольного доступа, определяемый FCB,
начальный адрес которого  содержится  в  DE.  Запись  переносится,
начиная  с  адреса  передачи.  Запись  определяется  полем   блока
произвольного доступа.  Это  поле  не  изменяется  при  выполнении
данной функции.  Размер  записи  всегда  128  байт.  Если  функция
выполнилась, то возвращает 0; иначе, - 1.
   Примечание. Эта функция оставлена  для  совместимости  с  CP/M.
Настоятельно рекомендуется использовать  другую  функцию:  'RANDOM
BLOCK WRITE'.
Вход:           DE указывает на первый байт FCB
Выход:          A - 0, если запись осуществилась;
                    1, в противном случае

23 [CP]  GET FILE SIZE
   Вычисляет размер файла (кратное  число  блоков  по  128  байт),
определяемого FCB,  начальный  адрес  которого  содержится  в  DE.
Устанавливает размер файла в поле  записи  произвольного  доступа.
Если функция выполнилась, то возвращает 0; иначе, - FFh.
Вход:          DE указывает на первый байт FCB
Выход:         A - 0, если размер получен; FFh, в противном случае

24 [CP]  SET RANDOM RECORD
   Вычисляет текущую позицию записи по полю текущего блока и  полю
текущей записи данного FCB, начальный адрес которого содержится  в
DE. Устанавливает позицию записи в  поле  записи  прямого  доступа
данного FCB.
Вход:           DE указывает на первый байт FCB
Выход:          Нет

      ∙ Системные вызовы для CP/M версии 2.2 и более поздних

25 [-]   NO FUNCTION
   Сброс драйвера диска
                           139  

26 [-]   RANDOM BLOCK WRITE
   Посылает запись (записи) в файл,  определяемый  FCB,  начальный
адрес которого содержится в  DE.  Запись  переносится,  начиная  с
адреса передачи. Запись  определяется  полем  блока  произвольного
доступа. Поле записи прямого доступа  автоматически  увеличивается
при успешном исходе операции.  Размер  записи  определяется  полем
размера записи. Количество записей определяет содержимое пары  HL.
Если функция выполнилась, то возвращает 0; иначе, - 1.
Вход:           DE указывает на первый байт FCB
                HL указывает количество последовательных записей
Выход:          A: 0, если запись осуществилась;
                   1, в противном случае

27 [-]   RANDOM BLOCK READ
   Читает запись (записи) из файла, определяемого  FCB,  начальный
адрес которого содержится в  DE.  Запись  переносится,  по  адресу
передачи. Запись определяется полем блока  произвольного  доступа.
Поле  записи  прямого  доступа  автоматически  увеличивается   при
успешном исходе операции. Размер записи определяется полем размера
записи.  Количество  записей  определяет   содержимое   пары   HL.
Количество прочитанных записей после завершения операции заносится
в пару HL. Если функция выполнилась, то возвращает 0; иначе, - 1.
Вход:           DE указывает на первый байт FCB
                HL указывает количество последовательных записей
Выход:          A: 0, если чтение осуществилось;
                   1, в противном случае
                HL указывает количество прочитанных записей

28 [CP]  RANDOM WRITE WITH ZERO FILL
   Посылает запись  в  файл,  определяемый  FCB,  начальный  адрес
которого содержится в DE. Запись  переносится,  начиная  с  адреса
передачи. Запись определяется полем блока  произвольного  доступа.
Это поле не изменяется  данной  операцией.  Размер  записи  всегда
равен 128 байт. Если файл расширяется, то все записи,  которые  не
заносятся,  заполняются  нулями.  Если  функция  выполнилась,   то
возвращает 0; иначе, - 1.
Вход:           DE указывает на первый байт FCB
Выход:          A: 0, если запись осуществилась;
                   1, в противном случае
                           140  

              ∙ Системные вызовы только для MSX-DOS

29 [-]   NO FUNCTION

2А [-]   GET DATE
   Возвращает дату.
Вход:           Нет
Выход:          HL: год
                D:  месяц
                E:  день
                А:  день недели

2B [-]   SET DATE
   Устанавливает дату. Если успешно, то возвращает 0; иначе - FFh.
Вход:           HL: год
                D:  месяц
                E:  день
                А:  день недели
Выход:          A: 0, если дата установилась;
                   FFh, в противном случае

2C [-]   GET TIME
   Возвращает время.
Вход:           Нет
Выход:          H: часы
                L: минуты
                D: секунды
                E: 1/100 секунды

2D [-]   SET TIME
   Устанавливает время. Если успешно, то возвращает 0; иначе- FFh.
Вход:           H: часы
                L: минуты
                D: секунды
                E: 1/100 секунды
Выход:          A: 0, если дата установилась;
                   FFh, в противном случае
                           141  

2E [-]   SET/RESET VERIFY FLAG
   Установка/сброс флага 'чтение после записи' (VERIFY).
Вход:           Е: 0 (флаг сбрасывается);
                   не 0 (флаг устанавливается)
Выход:          Hет

2F [-]   ABSOLUTE DISK READ
   Чтение Н секторов, начиная с сектора с логическим номером DE, с
драйвера, определяемого регистром L. Данные записываются в память,
начиная с адреса передачи (DMA).
Вход:           DЕ: логический номер сектора
                Н: количество секторов для чтения
                L: номер драйвера  (0 - A, 1 - B)
Выход:          Hет

30 [-]   ABSOLUTE DISK WRITE
   Запись Н секторов, начиная с сектора с логическим номером DE, с
драйвера, определяемого  регистром  L.  Данные  переписываются  из
памяти, начиная с адреса передачи (DMA).
Вход:           DЕ: логический номер сектора
                Н: количество секторов для записи
                L: номер драйвера  (0 - A, 1 - B)
Выход:          Hет















                           142  
 
 
     ПРИЛОЖЕНИЕ 5. ВХОДНЫЕ ТОЧКИ ИНТЕРПРЕТАТОРА
                   ЯЗЫКА MSX-BASIC


                  Операции над целыми числами

┌────────┬───────┬────────────────────┬───────────────────────┐
│Название│       │                    │                       │
│ подпро-│ Адрес │Выполняемые действия│  Изменяемые регистры  │
│ граммы │       │                    │                       │
├────────┼───────┼────────────────────┼───────────────────────┤
│ UMULT  │ 314Ah │   DE := BC╟DE      │       A,B,C,D,E       │
│ ISUB   │ 3167h │   HL := DE-HL      │          Все          │
│ IADD   │ 3172h │   HL := DE+HL      │          Все          │
│ IMULT  │ 3193h │   HL := DE╟HL      │          Все          │
│ IDIV   │ 31E6h │   HL := DE/HL      │          Все          │
│ IMOD   │ 323Ah │   HL := DE mod HL  │          Все          │
│ INTEXP │ 383Fh │   DAC:= DE^HL      │                       │
└────────┴───────┴────────────────────┴───────────────────────┘




                 Арифметические операции и функции



┌────────┬───────┬────────────────────┬───────────────────────┐
│Название│       │                    │                       │
│ подпро-│ Адрес │Выполняемые действия│   Изменяемые регистры │
│ граммы │       │                    │                       │
├────────┼───────┼────────────────────┼───────────────────────┤
│ DECSUB │ 268Ch │  DAC := DAC-ARG    │          Все          │
│ DECADD │ 269Ah │  DAC := DAC+ARG    │          Все          │
│ DECNRM │ 26FAh │ Нормализовать DAC  │          Все          │
│ DECROU │ 273Ch │   Округлить DAC    │          Все          │
│ DECMUL │ 27E6h │  DAC := DAC╟ARG    │          Все          │
│ DECDIV │ 289Fh │  DAC := DAC/ARG    │          Все          │
│ COS    │ 2993h │  DAC := COS(DAC)   │          Все          │
│ SIN    │ 29ACh │  DAC := SIN(DAC)   │          Все          │
│ TAN    │ 29FBh │  DAC := TAN(DAC)   │          Все          │
│ ATN    │ 2A14h │  DAC := ATN(DAC)   │          Все          │
│ LOG    │ 2A72h │  DAC := LOG(DAC)   │          Все          │
│ SQR    │ 2AFFh │  DAC := SQR(DAC)   │          Все          │
│ EXP    │ 2B4Ah │  DAC := EXP(DAC)   │          Все          │
│ RND    │ 2BDFh │  DAC := RND(DAC)   │          Все          │
│ SIGN   │ 2E71h │  A   := SIGN(DAC)  │          A            │
│ ABSFN  │ 2E82h │  DAC := ABS(DAC)   │          Все          │
│ NEG    │ 2E8Dh │  DAC := - DAC      │          A,H,L        │
│ SGN    │ 2E97h │  DAC := SGN(DAC)   │          A,H,L        │
└────────┴───────┴────────────────────┴───────────────────────┘




                     Возведение в степень



┌────────┬───────┬────────────────────┬───────────────────────┐
│Название│       │                    │                       │
│ подпро-│ Адрес │Выполняемые действия│          Тип          │
│ граммы │       │                    │                       │
├────────┼───────┼────────────────────┼───────────────────────┤
│ SNGEXP │ 37C8h │  DAC := DAC^ARG    │   Одинарная точность  │
│ DBLEXP │ 37D7h │  DAC := DAC^ARG    │    Двойная точность   │
└────────┴───────┴────────────────────┴───────────────────────┘




                             143  

                         Пересылки


┌────────┬───────┬────────────────┬────────┬──────────────────┐
│Название│       │                │        │                  │
│ подпро-│ Адрес │   Выполняемые  │  Тип   │    Изменяемые    │
│ граммы │       │     действия   │        │     регистры     │
├────────┼───────┼────────────────┼────────┼──────────────────┤
│ MAF    │ 2C4Dh │   ARG := DAC   │ Double │    A,B,D,E,H,L   │
│ MAM    │ 2C50h │   ARG := (HL)  │ Double │    A,B,D,E,H,L   │
│ MOV8DH │ 2C53h │   (DE):= (HL)  │ Double │    A,B,D,E,H,L   │
│ MFA    │ 2C59h │   DAC := ARG   │ Double │    A,B,D,E,H,L   │
│ MFM    │ 2C5Ch │   DAC := (HL)  │ Double │    A,B,D,E,H,L   │
│ MMF    │ 2C67h │   (HL):= DAC   │ Double │    A,B,D,E,H,L   │
│ MOV8HD │ 2C6Ah │   (HL):= (DE)  │ Double │    A,B,D,E,H,L   │
│ XTF    │ 2C6Fh │   (SP):= DAC   │ Double │    A,B,D,E,H,L   │
│ PHA    │ 2CC7h │   ARG := (SP)  │ Double │    A,B,D,E,H,L   │
│ PHF    │ 2CCCh │   DAC := (SP)  │ Double │    A,B,D,E,H,L   │
│ PPA    │ 2CDCh │   (SP):= ARG   │ Double │    A,B,D,E,H,L   │
│ PPF    │ 2CE1h │   (SP):= DAC   │ Double │    A,B,D,E,H,L   │
│ PUSHF  │ 2EB1h │   DAC := (SP)  │ Single │    D,E           │
│ MOVFM  │ 2EBEh │   DAC := (HL)  │ Single │    B,C,D,E,H,L   │
│ MOVFR  │ 2EC1h │  DAC := (CBED) │ Single │    D,E           │
│ MOVRF  │ 2ECCh │  (CBED):= DAC  │ Single │    B,C,D,E,H,L   │
│ MOVRMI │ 2ED6h │  (CBED):= (HL) │ Single │    B,C,D,E,H,L   │
│ MOVRM  │ 2EDFh │  (BCDE):= (HL) │ Single │    B,C,D,E,H,L   │
│ MOVMF  │ 2EE8h │   (HL):= DAC   │ Single │    B,C,D,E,H,L   │
│ MOVE   │ 2EEBh │   (HL):= (DE)  │ Single │    B,C,D,E,H,L   │
│ VMOVAM │ 2EEFh │   ARG := (HL)  │ VALTYP │    B,C,D,E,H,L   │
│ MOVVFM │ 2EF2h │   (DE):= (HL)  │ VALTYP │    B,C,D,E,H,L   │
│ VMOVE  │ 2EF3h │   (HL):= (DE)  │ VALTYP │    B,C,D,E,H,L   │
│ VMOVFA │ 2F05h │   DAC := ARG   │ VALTYP │    B,C,D,E,H,L   │
│ VMOVFM │ 2F08h │   DAC := (HL)  │ VALTYP │    B,C,D,E,H,L   │
│ VMOVAF │ 2F0Dh │   ARG := DAC   │ VALTYP │    B,C,D,E,H,L   │
│ VMOVMF │ 2F10h │   (HL):= DAC   │ VALTYP │    B,C,D,E,H,L   │
└────────┴───────┴────────────────┴────────┴──────────────────┘


                         Сравнения


┌────────┬───────┬─────────┬───────┬───────┬──────────────────┐
│Название│       │         │ Левая │ Правая│                  │
│ подпро-│ Адрес │   Тип   │ часть │ часть │ Измен. регистры  │
│ граммы │       │         │условия│условия│                  │
├────────┼───────┼─────────┼───────┼───────┼──────────────────┤
│ FCOMP  │ 2F21h │ Single  │  CBED │  DAC  │      HL          │
│ ICOMP  │ 2F4Dh │ Integer │   DE  │   HL  │      HL          │
│ XDCOMP │ 2F5Ch │ Double  │  ARG  │  DAC  │      Все         │
└────────┴───────┴─────────┴───────┴───────┴──────────────────┘
   Подпрограмма возвращает следующее содержимое регистра A:
         +1, если  левая часть условия < правой части условия,
          0, если  левая часть условия = правой части условия,
         -1, если  левая часть условия > правой части условия.

                       Преобразования

   Для преобразования из строки в число используется  подпрограмма
с именем FIN:

┌─────────────────────────────────────────────────────────────┐
│   FIN (3299h)                                               │
│   Аргументы:   HL - адрес строки символов,                  │
│                A  - первый символ строки.                   │
│   Результаты:  DAC- вещественное число,                     │
│                C   - { 0 - была десятичная точка,           │
│                { FFh - десятичной точки не было,            │
│                B  - количество цифр после десятичной точки, │
│                D  - количество цифр в числе.                │
└─────────────────────────────────────────────────────────────┘

                             144  

   Для преобразования  числа  в  строку  для  вывода  имеются  две
подпрограммы:

┌─────────────────────────────────────────────────┐
│        FOUT (3425h) -  неформатный вывод,       │
│      PUFOUT (3426h) -  форматный вывод;         │
└─────────────────────────────────────────────────┘

   Эти подпрограммы преобразуют число, находящееся в DAC, в строку
символов.

Аргументы: A - формат; содержимое его битов может быть следующим:
     bit7: если 1, то вывод осуществляется по формату;
     bit6: если 1, то через каждые 3 цифры вставляются запятые;
     bit5: если 1, то первые нули заменить на символ "*";
     bit4: если 1, то перед числом вставить символ "$";
     bit3: если 1, то число выводится всегда со знаком;
     bit2: если 1, то вставить знак после числа;
     bit1:     не используется;
     bit0:{если 0, то число выводится с фиксированной точкой;
          {если 1, то число выводится с плавающей точкой;
           B - количество цифр перед точкой;
           C - количество цифр после точки + 1.

Результаты:  HL - начальный адрес строки символов.

                    Преобразования в текст

┌────────┬───────┬─────────────────────────────────────┐
│Название│       │                                     │
│ подпро-│ Адрес │         Преобразование в текст      │
│ граммы │       │                                     │
├────────┼───────┼─────────────────────────────────────┤
│ FOUTB  │ 371Ah │ Целое число в двоичный вид          │
│ FOUTO  │ 371Eh │ Целое число в восьмеричный вид      │
│ FOUTH  │ 3722h │ Целое число в шестнадцатеричный вид │
└────────┴───────┴─────────────────────────────────────┘

   Для этих подпрограмм:
Аргументы:        DAC    - целое число,
                  VALTYP = 2.
Результаты:       HL - начальный адрес строки.
                             145  


                    Преобразования типов

┌────────┬───────┬────────────────────────────────────────────┐
│Название│       │                                            │
│ подпро-│ Адрес │            Выполняемые действия            │
│ граммы │       │                                            │
├────────┼───────┼────────────────────────────────────────────┤
│ FRCINT │ 2F8Ah │ Содержимое DAC преобразуется к целому типу │
│ FRCSNG │ 2FB2h │ Содержимое DAC преобразуется к типу        │
│        │       │          одинарной точности                │
│ FRCDBL │ 303Ah │ Содержимое DAC преобразуется к типу        │
│        │       │          двойной точности                  │
│ FIXER  │ 30BEh │          DAC:=SGN(DAC)GINT(ABS(DAC))       │
└────────┴───────┴────────────────────────────────────────────┘

   После выполнения подпрограммы в ячейке с  именем  VALTYP  будет
находиться код типа числа, находящегося в DAC.























                             146  
  
 

 

       ПРИЛОЖЕНИЕ 6. СЕТЕВЫЕ ФУНКЦИИ MSX-DOS BIOS

   Сеть   MSX-2   RS232C   имеет   систему   стандартных   функций
ввода-вывода  (BIOS),  включающую  в   себя   различные   функции.
Обращаясь прямо к ней, можно  работать  с  сетью  из  программ  на
машинном языке в MSX-DOS.
   Описываемая  NET-BIOS  будет  работать  только  в  операционной
системе MSX-DOS 1.03 ( дистрибутивный диск MSX-DOS). Для работы  в
MSX-DOS 1.26 или в Nike-DOS, используйте адреса:
      Инициализация сети        8FH/401CH
      Обращение к NET-BIOS      8FH/4019H
      Конец работы с сетью      8FH/4016H
  Их вызов можно осуществить следующим образом :
         rst    30H
         defb   8Fh       ; указатель слота
         defw   address   ; адрес

               Список функций NET-BIOS

  Номер и название             Функция

   0  00H    INIT        : Инициализация сети.
   1  01H    INTON       : Разрешение прерываний по сети.
   2  02H    INTOFF      : Запрещение прерываний по сети.
   3  03H    PON         : Начало упорядоченного опроса.
   4  04H    POFF        : Конец упорядоченного опроса.
   6  06H    WHO         : Проверка номера.
   8  08H    SHEX        : Пересылка программы в кодах.
   9  09H    SHEXS       : Пересылка видеопамяти (VRAM).
  11  0BH    RHEX        : Прием программы в кодах.
  12  0CH    RHEXS       : Прием видеопамяти (VRAM).
  13  0DH    MESS        : Передача сообщения ученику.
  14  0EH    TALK        : Передача сообщения преподавателю.
  15  0FH    SNDM        : Передача "почтового ящика".
  16  10H    RNDM        : Прием "почтового ящика".
  17  11H    POKE        : Запись в память.
  18  12H    PEEK        : Чтение из памяти.
  19  13H    SNDCMD      : Передача команды.
  22  16H    BREAK       : Передача кода остановки программы.
  23  17H    CHECK       : Проверка подключения к сети.
                              147  

  24  18H    ENDNET      : Конец работы с сетью.
  25  19H    ENACOM      : Разрешение связи между учениками.
  26  1AH    DISCOM      : Запрещение связи между учениками.


1 : INTON                    Преподаватель/ученик
   Эта функция разрешает прерывания при работе с сетью.  Без  этой
команды какая-либо связь в классе невозможна.
Вход:   Нет
Выход:  Нет

2 : INTOFF                   Преподаватель/ученик
   Эта функция запрещает прерывания при работе с  сетью.  Так  как
связь в классе поддерживается через прерывания  процессора,  когда
они запрещены, какая-либо связь невозможна.
Вход:   Нет
Выход:  Нет

3 : PON                      Преподаватель
   Эта функция начинает упорядоченный  опрос  учеников.  Без  него
невозможно правильно определить, кто из учеников подключен к  сети
(т.е. правильность работы  Функции  24  CHECK  не  гарантируется),
невозможен также  прием  сообщений  от  учеников  (Функция  TALK).
Помните, вызов Функции 1 (INTON), не  означает  что  опрос  начат,
т.е.  при  ее  вызове  опрос  отключен  и  его  надо  активировать
отдельно.
Вход:   Нет
Выход:  Нет

4 : POFF                     Преподаватель
   Прекращает  упорядоченный  опрос  учеников.  Для   его   начала
используйте Функцию 3 (PON).
Вход:   Нет
Выход:  Нет

5 : HELP                      Преподаватель/ученик
   Эта  функция   выводит   на   экран   список   сетевых   команд
интерпретатора MSX-BASIC. Этот список различен для преподавателя и
                              148  

ученика (см. выше). Для ученика эта функция высвечивает также  его
номер. Экран должен быть в текстовом режиме.
Вход:   Нет
Выход:  Нет

6 : WHO                        Преподаватель/ученик
   Эта функция возвращает в регистре A  номер  Вашего  компьютера,
установленный переключателем в сетевом блоке. В классе  не  должно
быть несколько компьютеров с одинаковыми  номерами.  Если  это  не
так, воспользуйтесь переключателем в сетевом блоке.
Выход:  A = номер преподавателя или ученика:
               00H = преподаватель
               01H - 0FH = ученики

7 : SEND                       Преподаватель/ученик
   Эта  функция  читает  программу  на  языке  BASIC  с  диска   и
пересылает ее ученику или всем ученикам. Файл  с  этой  программой
определяется блоком управления файлом (FCB) и должен  быть  открыт
до  вызова  этой  функции.  Ученик  должен  находиться  в   режиме
MSX-BASIC.
Вход:   DE = адрес блока параметров
           PAR 1 = номер ученика:
              00H  = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2-3 = адрес блока управления файлом (FCB)
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

8 : SHEX                       Преподаватель
   [Функция 1] Подпрограмма пересылает программу на машинном языке
или данные из памяти компьютера преподавателя в память  компьютера
ученика или всех учеников.
Вход:   DE = адрес блока параметров
           PAR 1 = номер ученика:
             00H = всем ученикам
             01H - 0FH = номер отдельного ученика
           PAR 2   = 0
           PAR 3-4 = начальный адрес ученика
           PAR 5-6 = начальный адрес преподавателя
           PAR 7-8 = конечный адрес преподавателя
                              149  

Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

   [Функция 2] Читает  программу  на  машинном  языке  с  диска  и
пересылает ее ученику или всем ученикам. Файл  с  этой  программой
определяется в блоке управления файлом (FCB) и должен быть  открыт
до вызова функции.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2   = любое значение кроме 0
           PAR 3-4 = начальный адрес у ученика
           (если указать 0FFFFH - будет  начальный адрес файла)
           PAR 5-6 = адрес блока управления файлом (FCB)
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

9 : SHEXS                      Преподаватель
   [Функция 1]  Пересылает  изображение  (данные  видеопамяти)  из
видеопамяти  компьютера  преподавателя  в  видеопамять  компьютера
одного ученика или всех учеников.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2   = 0
           PAR 3-4 = начальный адрес у ученика
           PAR 5-6 = начальный адрес у преподавателя
           PAR 7-8 = конечный адрес у преподавателя
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.

   [Функция 2] Читает изображение (данные видеопамяти) с  диска  и
пересылает их ученику или всем  ученикам.  Файл  с  этими  данными
определяется в блоке управления файлом (FCB)  и должен быть открыт
до вызова функции.
                              150  

Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2   = любое значение кроме 0
           PAR 3-4 = начальный адрес у ученика
           (если указать 0FFFFH - будет начальный адрес файла)
           PAR 5-6 = адрес блока управления файлом (FCB)
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.

10: RECEIVE                    Преподаватель
   Эта функция принимает программу на  языке  BASIC  у  указанного
ученика и записывает ее на диск. Файл для программы на языке BASIC
должен быть определен в блоке управления файлом  (FCB)  до  вызова
этой функции. Ученик должен быть в режиме BASIC.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2-3 = адрес блока управления файлом (FCB)
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

11: RHEX                     Преподаватель
   [Функция 1] Принимает программу на машинном языке или данные из
памяти компьютера ученика в память компьютера преподавателя.
Вход:   DE = адрес блока параметров
          PAR 1   = номер ученика
             01H - 0FH = номер отдельного ученика
          PAR 2   = 0
          PAR 3-4 = начальный адрес ученика
          PAR 5-6 = конечный адрес ученика
          PAR 7-8 = начальный адрес преподавателя
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.
   [Функция 2] Передает программу  на  машинном  языке  из  памяти
ученика и записывает ее на диск. Файл для  этой  программы  должен
быть определен в блоке управления файлом (FCB) и открыт до  вызова
этой функции.
                              151  

Вход:   DE = адрес блока параметров
          PAR 1   = номер ученика
             01H - 0FH = номер отдельного ученика
          PAR 2   = любое значение кроме 0
          PAR 3-4 = начальный адрес ученика
          PAR 5-6 = конечный адрес ученика
          PAR 7-8 = адрес блока контроля файлов (FCB)
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

12: RHEXS                      Преподаватель
   [Функция  1]  Принимает  изображение  (данные  видеопамяти)  из
видеопамяти   компьютера   ученика   в   видеопамять    компьютера
преподавателя.
Вход:   DE = адрес блока параметров
          PAR 1   = номер ученика
             01H - 0FH = номер отдельного ученика
          PAR 2   = 0
          PAR 3-4 = начальный адрес ученика
          PAR 5-6 = конечный адрес ученика
          PAR 7-8 = начальный адрес преподавателя
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

   [Функция 2] Передает изображение (данные видеопамяти)  по  сети
из компьютера ученика и записывает его  на  диск.  Файл  для  этой
программы должен быть определен в блоке управления файлом (FCB)  и
открыт до вызова функции.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              01H - 0FH = номер отдельного ученика
           PAR 2   = любое значение кроме 0
           PAR 3-4 = начальный адрес ученика
           PAR 5-6 = конечный адрес ученика
           PAR 7-8 = адрес блока контроля файлов (FCB)
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.
                              152  

13: MESSAGE                    Преподаватель
   Передает сообщение от учителя одному или  всем  ученикам.  Если
ученик находится в  режиме  BASIC,  сообщение  будет  выведено  на
экран. Если же ученик работает в MSX-DOS,  сообщение  выведено  не
будет и для его обработки необходима специальная подпрограмма.  Ее
работа возможна, так  как  при  принятии  сообщения   выставляется
специальный флаг, который и должен обрабатываться подпрограммой.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного  ученика
           PAR 2-3 = адрес памяти, начиная с которого записано
                     сообщение
           PAR 4-5 = длина сообщения.
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

14: TALK                       Преподаватель
   Если ученик получил разрешение участвовать в связи по сети,  то
он может посылать сообщения преподавателю и другим ученикам.  Если
разрешение не дано, то сообщения от него могут  посылаться  только
преподавателю. Для стирания сообщений нажимают на любую клавишу.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
               00H       = преподаватель
               01H - 0FH = номер отдельного  ученика
           PAR 2-3 = адрес памяти, начиная с которого записано
                      сообщение
           PAR 4-5 = длина сообщения.
Выход:  A  = 00H - сообщение записано нормально,
             FFH - осталось старое сообщение.
        Флаг CARRY ON  - ошибка.

15: SNDMAIL                    Преподаватель
   Эта функция копирует  содержимое  преподавательского  почтового
ящика для передачи  в приемный почтовый ящик указанного  или  всех
учеников. Изначально длина ящика равна 256 байтам,  но  она  может
быть изменена указанием новой  длины  в  рабочей  области.  Будьте
внимательны,  так  как  если  длина  передающего  почтового  ящика
преподавателя  больше,  чем  приемного  ящика  ученика,  то  часть
                              153  

информации будет потеряна. Использование почтовых ящиков полностью
зависит от Вас.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
             00H       = всем ученикам
             01H - 0FH = номер отдельного ученика
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

16: RCVMAIL                    Преподаватель
   Эта функция принимает содержимое  передающего  почтового  ящика
ученика и записывает его в приемный ящик преподавателя. Количество
передаваемой  информации  зависит  от  длины   передающего   ящика
ученика.  Будьте  внимательны,  так  как  если  длина  передающего
почтового ящика ученика больше, чем приемного ящика преподавателя,
то часть информации будет потеряна.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              01H - 0FH = номер отдельного ученика
Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

17: POKE                       Преподаватель/ученик
   Эта функция  в  зависимости  от  параметра  PAR  5,  записывает
указанное значение в обычную или  сетевую  память  отдельного  или
всех учеников, или (как для  преподавателя,  так  и  для  ученика)
записывает  это  значение  в  сетевую  память  Вашего  компьютера.
Функция не проверяет, в какое именно место  памяти  она  пишет,  и
всегда выполняется нормально, если только по указанному адресу  не
находится ПЗУ или вообще не отсутствует память.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
             00H       = всем ученикам
             01H - 0FH = номер отдельного  ученика
           PAR 2-3 = адрес ячейки
           PAR 4   = значение
           PAR 5   = выбор
             00H - память ученика
             01H - сетевая память ученика
             02H - Ваша сетевая память
                              154  

Выход:  Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

18: PEEK                       Преподаватель/ученик
   Эта функция в зависимости от  параметра  PAR  5,  читает  число
записанное по указанному адресу, из  обычной  или  сетевой  памяти
отдельного или всех учеников, или (как для  преподавателя,  так  и
для  ученика)  читает  это  значение  из  сетевой  памяти   Вашего
компьютера. Эта функция всегда выполняется нормально, если  только
по указанному адресу не отсутствует память.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              01H - 0FH = номер отдельного  ученика
           PAR 2-3 = адрес ячейки
           PAR 5   = выбор
              00H - память ученика
              01H - сетевая память ученика
              02H - Ваша сетевая память
Выход:  A = значение, записанное по данному адресу.
        Флаг CARRY OFF - функция выполнена нормально,
             CARRY ON  - ошибка.

19: SNDCMD                     Преподаватель
   Эта функция передает одному или всем ученикам команду на  языке
BASIC и выполняет ее. После приема команды у ученика  в  конце  ее
прибавляется код возврата каретки (CR). Ученик(и)  должны  быть  в
режиме MSX-BASIC (эта команда может и не быть правильной  командой
языка, но если интерпретатор ее  не  поймет,  у  ученика  появится
сообщение об ошибке).
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного  ученика
           PAR 2-3 = адрес памяти, начиная с которого записана
                     команда
           PAR 4-5 = длина сообщения.
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.
                              155  

20: RUN                        Преподаватель
   Эта функция запускает программу на языке BASIC у отдельного или
у всех учеников. Ученик(и) должен быть в режиме BASIC.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
           PAR 2-3 = номер стартовой строки (если
                  указан 0FFFFH - первая строка программы)
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.

21: STOP                       Преподаватель
   Эта функция производит такое же действие, как  если  бы  ученик
нажал CTRL/STOP. Если ученик находится в режиме  BASIC, происходит
остановка программы или переход  на  начало  следующей  строки  (в
командном режиме). Если ученик находится  в  MSX-DOS,  то  команда
игнорируется.
Вход:   DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.

22: BREAK                      Преподаватель
   Эта  функция  посылает  ученикам  код   остановки.   Когда   их
компьютеры получают этот код во время связи,  они  сбрасывают  все
полученные до этого данные и становятся готовыми к приему.
Вход:   Нет
Выход:  Нет

23: CHECK                      Преподаватель
   Эта функция проверяет, кто из учеников подключен к  сети,  кому
из них  разрешена  связь  с  другими  учениками.  То,  что  ученик
отключен от сети означает, что его компьютер выключен или отключен
от сети. Эта информация обновляется в каждом цикле  упорядоченного
опроса. Если же опрос выключен, хранится последняя, полученная  до

                              156  

его отключения, информация. Информация о том, кому разрешена связь
с другими учениками, зависит только от функций ENACOM и DISCOM.
Вход:   Нет
Выход:  HL = побитовая информация, кто подключен к сети:

            H                     L

     F E D C B A 9 8       7 6 5 4 3 2 1 0 - бит/компьютер
     0 * * * * * * *       * * * * * * * *
     │                               0: включен (ON LINE)
     │                               1: отключен (OFF LINE)
     └───────────────────► всегда 0

        DE = побитовая информация, кому разрешена работа с сетью:

            D                     E

     F E D C B A 9 8       7 6 5 4 3 2 1 0 - бит/компьютер
     0 * * * * * * *       * * * * * * * *
     │                               0: разрешена (ENACOM)
     │                               1: запрещена (DISCOM)
     └───────────────────► всегда 0


24: ENDNET                   Преподаватель
   Эта  функция  заканчивает  работу  сети. Она аналогична  вызову
подпрограммы  по  адресу  F98EH,  заканчивающей  работу  с  сетью.
Выключение  сети  бывает  необходимо  для  работы   с   некоторыми
прикладными программами, вызов которых невозможен  при  работающей
сети.
Вход:   Нет
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.

25: ENACOM                     Преподаватель
   Эта функция разрешает отдельному или всем ученикам связь  между
собой.
Вход:  DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.
                              157  

26: DISCOM                     Преподаватель
   Эта функция запрещает отдельному или всем ученикам связь  между
собой.
Вход:  DE = адрес блока параметров
           PAR 1   = номер ученика
              00H       = всем ученикам
              01H - 0FH = номер отдельного ученика
Выход: Флаг CARRY OFF - функция выполнена нормально,
            CARRY ON  - ошибка.



























                              158  
         ПРИЛОЖЕНИЕ 7. РЕГИСТРЫ ВИДЕОПРОЦЕССОРА

      Регистры режима

R0:
0... .... Всегда должен быть 0
.*.. .... [Открыть цветовую шину на ввод и читать] <- 0       (DG)
..*. .... [Разрешить прерывания от светового пера] <- 0      (IE2)
...* .... Разрешить прерывания по достижению строки (см.R19) (IE1)
.... ***. Биты выбора графического режима               (М5;М4;М3)
.... ...0 Всегда должен быть 0

R1:
0... .... Всегда должен быть 0
.0.. .... Экран не активен, цвет задается R7, команды VDP     (BL)
          работают быстрее
.1.. .... Экран активен
..1. .... Разрешить прерывания от гориз. сканирования        (IE0)
...* *... Биты выбора графического режима                  (М1;М2)
.... .0.. Всегда должен быть 0
.... ..0. Размер спрайта   8 х  8                             (SI)
.... ..1. Размер спрайта  16 x 16
.... ...0 Нормальный размер спрайта                           (МА)
.... ...1 Удвоенный размер спрайта

  Выбор режимов работы видеопроцессора (биты M1..M5):

┌─────────┬─────────┬───────────────────────────────────────────┐
│  R0     │  R1     │ Режим                                     │
├─────────┼─────────┼───────────────────────────────────────────┤
│.... 000.│...1 0...│ Текст-1 (40x24 символов, 2 цвета из 16 )  │
│.... 010.│...1 0...│ текст-2 (80x24 символов, 4 цвета из 16 )  │
├─────────┼─────────┼───────────────────────────────────────────┤
│.... 000.│...0 1...│ Многоцветный (цветные блоки размером 4x4) │
├─────────┼─────────┼───────────────────────────────────────────┤
│.... 000.│...0 0...│ Графика-1 (псевдогр. 40x24, 256 обр.),    │
│.... 001.│...0 0...│ Графика-2 (псевдогр. 40x24, 3x256 обр.)   │
│.... 010.│...0 0...│ Графика-3 = Граф.-2, с многоцв. спрайтами │
│.... 011.│...0 0...│ Графика-4 (256x192, 16 цветов из 512),    │
│.... 100.│...0 0...│ Графика-5 (512x192, 4 цвета из 512),      │
│.... 101.│...0 0...│ Графика-6 (512x192, 16 цветов из 512),    │
│.... 111.│...0 0...│ Графика-7 (256x192, 256 цветов).          │
└─────────┴─────────┴───────────────────────────────────────────┘

                              159  

R8:
1... .... Разрешение мышки, цветовая шина установлена на ввод (MS)
0... .... запрет мышки, цветовая шина установлена на вывод    (MS)
.*.. .... Разрешение светового пера (1), запрет (0)           (LP)
..0. .... Цвет #0 прозрачный                                  (TP)
..1. .... Цвет #0 из палитры
...0 .... Выводной режим для цветовой шины                    (CB)
...1 .... Вводной режим для цветовой шины
.... 0... Тип VRAM: 16K x 1 бит или 16K x 4 бит               (VR)
.... 1... Тип VRAM: 64K x 1 бит или 64K x 4 бит
.... .0.. Всегда должен быть 0                                (--)
.... ..0. Отображение спрайтов разрешено                     (SPD)
.... ..1. Отображение спрайтов запрещено
.... ...0 Цветной экран                                       (BW)
.... ...1 Черно‐белый экран с 32-мя градациями цвета

R9:
0... .... 192 графических, 24 текстовых строки на экране      (LN)
1... .... 212 графических, 26.5 текстовых строк на экране
.0.. .... Всегда должен быть 0
..** .... Совместный режим (режим синхронизации)           (S1;S0)
.... 0... Нет наложения, прогрессивная развертка NTSC         (IL)
.... 1... Есть наложение двух экранов со сдвигом на линию,
          черезстрочная развертка NTSC
.... .0.. Показ одного экрана на четное/нечетное поле         (Е0)
.... .1.. Показ двух экранов попеременно ( для G4 - G7 )
.... ..0. NTSC ( 262 линии)  ( у Ямахи NTSC )                 (NT)
.... ..1. PAL  ( 313 линий)
.... ...* *DLCK для ввода - 1, для вывода - 0

          Регистры базовых адресов в VRAM

R2:  Адрес таблицы ссылок на шаблоны PNT
0*** **** A16-A10, 1=400h
0*** **11 TEXT-2
0**1 1111 A16-A15 (номер страницы VRAM), GRAPHIC 4,5; 1=8000h
00*1 1111 A16 (номер страницы VRAM),     GRAPHIC 6,7; 1=100000h

R10: Адрес таблицы цветов CT
0000 0*** старшие биты: А16-А14
                              160  

R3:  Адрес таблицы цветов CT
**** **** младшие биты: А13-А6, 1=40h
**** *111 А13-А9, TEXT 2; 1=200h
*111 1111 А13, GRAPHIC 2,3

R4:  Адрес таблицы шаблонов PGT
00** **** А16-А11, 1=800h
00** **11 А16-А13, GRAPHIC 2,3; 1=2000h

R11: Aдрес таблицы атрибутов спрайтов SAT
0000 00** A16-A15, старшие биты

R5:  Aдрес таблицы атрибутов спрайтов SAT
**** *111 A14-A10, младшие биты, 1=80h

R6: Aдрес таблицы шаблонов спрайтов SPGT
00** **** А16-А11, 1=800h


                    Регистры цвета

R7:  Цвета текста и фона
**** .... Цвет текста ( текстовые режимы 1 и 2 )
.... **** Цвет фона ( цвета 0 ) во всех режимах

R12: Цвет текста и фона для мигания в ТЕXТ2
**** .... Цвет текста для мигания в ТЕXТ2
.... **** Цвет фона для мигания в ТЕXТ2

   Если в TEXT2  установлен  режим  мигания,  то  цвета  из  этого
регистра и регистра 7 отображаются поочередно.

R13: Время включения/выключения при мигании (в R2 - нечетная стр.)
**** .... Время включения при мигании ( в 1/6 сек. ), TEXT 2
          или период отображения для четной страницы, GRAPH 4..7
.... **** Время выключения при мигании ( в 1/6 сек. ), TEXT 2
          или период отображения для нечетной страницы, GRAPH 4..7

                              161  

         Регистры цветовой вспышки для NTSC

R20: 0000 0000
R21: 0011 1011
R22: 0001 0101

               Регистры доступа

R14: 0000 0*** Номер 16К‐байтной страницы VRAM или ERAM
R15: 0000 **** Номер регистра состояния
R16: 0000 **** Номер регистра палитры
R17: F0** **** Номер регистра VDP при косвенном доступе,
               F - флаг автоинкремента

            Регистры управления экраном

R18: Смещение экрана
1*** .... Смещение экрана по горизонтали вправо на 8 - ***
0*** .... Смещение экрана по горизонтали влево  на ***
.... 1*** Смещение экрана по вертикали вниз     на 8 - ***
.... 0*** Смещение экрана по вертикали вверх    на ***

R19: Регистр линии прерывания
**** **** Будут происходить прерывания при показе строки  с  таким
          номером (разрешение этих прерываний - бит IE1 в R0).

R23: Регистр смещения изображения
**** **** Номер строки экрана, с которой показывать
          (таблицу спрайтов нужно переписать на др.страницу)

            R23 = 0                       R23 = 200

       0┌────────────┐ верх            0┌────────────┐
        │░▓░▓░▓░▓░▓░▓│                  │░▓░▓░▓░▓░▓░▓│
        │░▓░▓░▓░▓░▓░▓│                  │░▓░▓░▓░▓░▓░▓│
        │░▓░▓░▓░▓░▓░▓│               136├────────────┤низ
        │░▓░▓░▓░▓░▓░▓│               200├────────────┤верх
     192├────────────┤низ               │░▓░▓░▓░▓░▓░▓│
     255└────────────┘                  └────────────┘


                              162  

                    Регистры команд

R33: 0000 000* Исходная координата по X      (SX)
R32: **** ****
R35: 0000 00** Исходная координата по Y      (SY)
R34: **** ****

R37: 0000 000* Конечная координата  по X     (DX)
R36: **** ****
R39: 0000 00** Конечная координата  по Y     (DY)
R38: **** ****

R41: 0000 000* Количество точек по X         (NX)
R40: **** ****
R43: 0000 00** Количество точек по Y         (NY)
R42: **** ****

R44: **** .... Цвет                         (CLR)
     .... **** Цвет

R45: Регистр аргумента
0... .... Всегда должен быть 0
.*.. .... Выбор банка VRAM при записи                         (BL)
..0. .... Выбор получателя: VRAM                             (MXD)
..1. .... Выбор получателя: ERAM
...* .... Выбор источника VRAM/ERAM                          (MXS)
.... 0... Направление передачи:  Вниз                        (DIY)
.... 1... Вверх
.... .0.. Вправо                                             (DIX)
.... .1.. Влево
.... ..0. Закончить, когда найден не цвет бордюра             (EQ)
.... ..1. Закончить поиск, когда найден цвет бордюра
.... ...* Направление длинного поиска( 0=X-axis,1=Y-axis)    (MAJ)

R46: Регистр команд
**** .... Код команды
.... **** Логическая операция

                              163  

      Команды видеопроцессора:

┌─────┬──────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ Код │     Команда      │Log│ SX│ SY│DX/│ NX│ NY│DIY│DIX│CLR│MAJ│
│     │                  │   │   │   │ DY│   │   │   │   │   │   │
├─────┼──────────────────┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
│ 0000│ STOP Останов     │ - │ - │ - │ - │ - │ - │ - │ - │ - │ - │
│ 0100│ POINT Взять цвет │ - │ v │ v │ - │ - │ - │ - │ - │ - │ - │
│ 0101│ PSET             │ + │ - │ - │ v │ - │ - │ - │ - │ v │ - │
│ 0110│ SRCH Поиск       │ - │ v │ v │ - │ - │ - │ - │ v │ v │ - │
│ 0111│ LINE Линия       │ + │ - │ - │ v │Max│Min│ v │ v │ v │ v │
├─────┼──────────────────┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
│     │ Логич. пересылки:│   │   │   │   │   │   │   │   │   │   │
│ 1000│ LMMV:VDP  -> VRAM│ + │ - │ - │ v │ v │ v │ v │ v │ v │ - │
│ 1001│ LMMM:VRAM -> VRAM│ + │ v │ v │ v │ v │ v │ v │ v │ - │ - │
│ 1010│ LMCM:VRAM -> CPU │ + │ v │ v │ - │ v │ v │ v │ v │ - │ - │
│ 1011│ LMMC:CPU  -> VRAM│ + │ - │ - │ v │ v │ v │ v │ v │ * │ - │
├─────┼──────────────────┼───┼───┼───┼───┼───┼───┼───┼───┼───┼───┤
│     │ Скоростные       │   │   │   │   │   │   │   │   │   │   │
│     │    пересылки:    │   │   │   │   │   │   │   │   │   │   │
│ 1100│ HMMV:VDP  -> VRAM│ - │ - │ - │ v │ v │ v │ v │ v │ v │ - │
│ 1101│ HMMM:VRAM -> VRAM│ - │ v │ v │ v │ v │ v │ v │ v │ - │ - │
│ 1110│ YMMM:VRAM -> VRAM│ - │ - │ v │ v │ - │ v │ v │ v │ - │ - │
│ 1111│ HMMC:CPU  -> VRAM│ - │ - │ - │ v │ v │ v │ v │ v │ * │ - │
└─────┴──────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘

Получение цвета точки:
S7: -   -   -   -  C3  C2  C1  C0  цветовой код для Графики-4 и 6
S7: -   -   -   -   -   -  C1  C0  цветовой код для Графики-5
S7: C7  C6  C5  C4 C3  C2  C1  C0  цветовой код для Графики-7

  Пересылка VDP -> VRAM:

┌──────────────────────────────────────┐  Рисование заполненного
│ (SX,SY)                              │     прямоугольника 
│    ┌─────────────┐ ───► DIX          │
│    │          NX │                   │    ┌───────┐
│    │ NY          │◄───────────────────────┤ V D P │
│    └─────────────┘                   │    └───────┘
│    │ DIY                             │
│    ▼                                 │  Цвет задается в R44
└──────────────────────────────────────┘


  Пересылка CPU -> VRAM:
┌──────────────────────────────────────┐
│ (DX,DY)                              │
│    ┌─────────────┐  ───► DIX         │
│    │          NX │                   │   ┌───────┐    ┌───────┐
│    │ NY          │◄──────────────────────┤ V D P │◄───┤ C P U │
│    └─────────────┘                   │   └───────┘    └───────┘
│    │ DIY                             │
│    ▼                                 │
└──────────────────────────────────────┘

   Команда  переносит  данные  из  CPU  в  прямоугольную   область
видеопамяти через видеопроцессор.


                              164  

   Задание данных для пересылки.
   1) Установка высокоскоростной пересылки (пересылаются байты).

     MSB   7   6   5   4   3   2   1   0   LSB

   R44:   CH3 CH2 CH1 CH0 CL3 CL2 CL1 CL0  - GRAPHIC 4, GRAPHIC 6
           └───┴───┴───┘   └───┴───┴───┘
              X = 2N        X = 2N + 1     (N=0,1,..,127)
                                                         
          CH3 CH2  -   -  CL3 CL2  -   -   - GRAPHIC 5   
           └───┘   └───┘   └───┘   └───┘

          CH3 CH2 CH1 CH0 CL3 CL2 CL1 CL0  - GRAPHIC 7
           └───┴───┴───┴───┴───┴───┴───┘
                    одна точка 


   2) Установка логического типа (пересылаются точки).

   R44:    -   -   -   -  CR3 CR2 CR1 CR0  - GRAPHIC 4, GRAPHIC 6
           -   -   -   -   -   -  CR1 CR0  - GRAPHIC 5
          CR3 CR2 CR1 CR0 CR3 CR2 CR1 CR0  - GRAPHIC 7


  Логические операции (SC - код цвета источника, DS - получателя):

┌──────┬─────────────────┬──────┬──────────────────────────────┐
│ Код  │ Операция        │ Код  │ Операция с префиксом Т       │
├──────┼─────────────────┼──────┼──────────────────────────────┤
│ 0000 │ DS := SC        │ 1000 │ If (SC <> 0) DS := SC        │
│ 0001 │ DS := SC and DS │ 1001 │ If (SC <> 0) DS := SC and DS │
│ 0010 │ DS := SC  or DS │ 1010 │ If (SC <> 0) DS := SC  or DS │
│ 0011 │ DS := SC xor DS │ 1011 │ If (SC <> 0) DS := SC xor DS │
│ 0100 │ DS := not SC    │ 1100 │ If (SC <> 0) DS := not SC    │
└──────┴─────────────────┴──────┴──────────────────────────────┘
Если есть префикс Т, цвет 0 источника в операции не участвует.

              Регистры состояния

S0:
*... .... Флаг прерывания от вертикального сканирования        (F)
          После чтения S0 этот флаг сбрасывается
.*.. .... Флаг - появился ли пятый (девятый) спрайт           (5S)
          на одной строке
..*. .... Флаг - произошло ли наложение двух спрайтов          (C)
...* **** Номер пятого (девятого) спрайта на одной линии

S1:
*... .... Флаг от светового пера или мышки                    (FL)
.*.. .... Идентификация нажатия кнопки на св.пере или мышке  (LPS)
..** ***. Идентификационный номер видеопроцессора MSX-VIDEO
.... ...* Флаг прерывания от горизонтального сканирования,    (FH)
          который устанавливается в R19. При чтении S1 флаг
          сбрасывается
                              165  

S2:
1... .... Можно посылать данные (RAM - VRAM), передача была   (TR)
          окончена
0... .... Надо ждать
.*.. .... Происходит вертикальное сканирование (1)            (VR)
..*. .... Происходит горизонтальное сканирование (1)          (HR)
...1 .... Обнаружена точка цвета границы, если была дана      (BD)
          команда поиска
...0 .... Происходит поиск
.... 11.. Всегда устанавливаются
.... ..*. Какое поле экрана: первое (0) или второе (1)        (EO)
.... ...1 Выполняется команда VDP                             (CE)
.... ...0 Выполнение команды VDP закончено                    (CE)

           Регистры коллизии цветового пера/мышки/спрайтов

S3 : **** **** Номер колонки - биты X7..X0 (реальное значение+2)
S4 : 1111 111* Номер колонки - бит  X8
S5 : **** **** Номер строки  - биты Y7..Y0 (реальное значение+2)
S6 : 1111 11** Номер строки  - биты Y8,Y9

S7 : **** **** Цвет при выполнении POINT или "VRAM -> CPU"
S8 : **** **** Координата X границы при поиске цвета бордюра -
               биты X7..X0
S9 : 1111 111* Координата X границы при поиске - бит  X8.












                              166  
  



 
   

  ПРИЛОЖЕНИЕ 8. ВНУТРЕННИЕ КОДЫ ЛЕКСЕМ ЯЗЫКА MSX-BASIC

   Ниже приводятся внутренние коды лексем языка MSX-BASIC, которые
используются для  компактной  записи  программ  на  этом  языке  в
таблицу  PIT,  и  соответствующие   входные   точки   (адреса)   в
интерпретаторе.

┌────────┬───────┬───────────┬────────┬───────┬───────────┐
│  Имя   │  Код  │  Адрес    │  Имя   │  Код  │  Адрес    │
├────────┼───────┼───────────┼────────┼───────┼───────────┤
│ ABS    │ FF 86 │ 2E82      │  DATA  │    84 │ 485B      │
│ AND    │    F6 │           │  DEF   │    97 │ 5010      │
│ ASC    │ FF 95 │ 680B      │  DEFDBL│    AE │ 4721      │
│ ATN    │ FF 8E │ 2A14      │  DEFINT│    AC │ 471B      │
│ ATTR$  │    E9 │ 7C43      │  DEFSNG│    AD │ 471E      │
│ AUTO   │    A9 │ 49B5      │  DEFSTR│    AB │ 4718      │
├────────┼───────┼───────────┤  DELETE│    A8 │ 53E2      │
│ BASE   │    C9 │ 7B5A/7BCB │  DIM   │    86 │ 5E9F      │
│ BEEP   │    C0 │ 00C0      │  DRAW  │    BE │ 5D6E      │
│ BIN$   │ FF 9D │ 65FF      │  DSKF  │ FF A6 │ 7C39      │
│ BLOAD  │    CF │ 6EC6      │  DSKI$ │    EA │ 7C3E      │
│ BSAVE  │    D0 │ 6E92      │  DSKO$ │    D1 │ 7C16      │
├────────┼───────┼───────────┼────────┼───────┼───────────┤
│ CALL   │    CA │ 55A8      │  ELSE  │    A1 │ 485D      │
│ CDBL   │ FF A0 │ 303A      │  END   │    81 │ 63EA      │
│ CINT   │ FF 9E │ 2F8A      │  ERASE │    A5 │ 6477      │
│ CIRCLE │    BC │ 5B11      │  ERL   │    E1 │ 4E0B      │
│ CHR$   │ FF 96 │ 681B      │  ERR   │    E2 │ 4DFD      │
│ CLEAR  │    92 │ 64AF      │  ERROR │    A6 │ 49AA      │
│ CLOAD  │    9B │ 703F      │  EOF   │ FF AB │ 6D25      │
│ CLS    │    9F │ 00C3      │  EQU   │    F9 │           │
│ CMD    │    D7 │ 7C34      │  EXP   │ FF 8B │ 2B4A      │
│ COLOR  │    BD │ 7980      ├────────┼───────┼───────────┤
│ CONT   │    99 │ 6424      │  FIELD │    B1 │ 7C52      │
│ COPY   │    D6 │ 7C2F      │  FILES │    B7 │ 6C2F      │
│ COS    │ FF 8C │ 2993      │  FIX   │ FF A1 │ 30BE      │
│ CRSLIN │    E8 │ 790A      │  FN    │    DE │ 5040      │
│ CSAVE  │    9A │ 6F87      │  FOR   │    82 │ 4524      │
│ CSNG   │ FF 9F │ 2FB2      │  FPOS  │ FF A7 │ 6D39      │
│ CVD    │ FF AA │ 7C70      │  FRE   │ FF 8F │ 69F2      │
│ CVI    │ FF A8 │ 7C66      ├────────┼───────┼───────────┤
│ CVS    │ FF A9 │ 7C6B      │  MAX   │    CD │ 7E4B      │
├────────┼───────┼───────────┤  MERGE │    B6 │ 6B5E      │
│ GET    │    B2 │ 7758      │  MID$  │ FF 83 │ 689A      │
│ GOSUB  │    8D │ 47B2      │  MKD$  │ FF B0 │ 7C61      │
│ GOTO   │    89 │ 47E8      │  MKI$  │ FF AE │ 7C57      │
├────────┼───────┼───────────┤  MKS$  │ FF AF │ 7C5C      │
│ HEX$   │ FF 9B │ 65FA      │  MOD   │    FB │           │
├────────┼───────┼───────────┤  MOTOR │    CE │ 73B7      │
│ INKEY$ │    EC │ 7347      ├────────┼───────┼───────────┤
│ INP    │ FF 90 │ 4001      │  NAME  │    D3 │ 7C20      │
│ INPUT  │    85 │ 4B6C      │  NEW   │    94 │ 6286      │
│ INPUT$ │       │ 6C87      │  NEXT  │    83 │ 6527      │
│ INSTR  │    E5 │ 68EB      │  NOT   │    E0 │ 4F63      │
│ INT    │ FF 85 │ 30CF      ├────────┼───────┼───────────┤
│ IMP    │    FA │           │  OCT$  │ FF 9A │ 65F5      │
│ IPL    │    D5 │ 7C2A      │  OFF   │    EB │           │
│ IF     │    8B │ 49E5      │  ON    │    95 │ 48E4      │
├────────┼───────┼───────────┤  OPEN  │    B0 │ 6AB7      │
│ KEY    │    CC │ 786C      │  OR    │    F7 │           │
│ KILL   │    D4 │ 7C25      │  OUT   │    9C │ 4016      │
└────────┴───────┴───────────┴────────┴───────┴───────────┘



                            167  



┌────────┬───────┬───────────┬────────┬───────┬───────────┐
│ LEN    │ FF 92 │ 67FE      │        │       │           │
│ LEFT$  │ FF 81 │ 6861      │        │       │           │
│ LET    │    88 │ 4880      │  PAD   │ FF A5 │ 7969      │
│ LINE   │    AF │ 4B0E      │  PAINT │    BF │ 59C5      │
│ LIST   │    93 │ 522E      │  PDL   │ FF A4 │ 795A      │
│ LFILES │    BB │ 6C2A      │  PEEK  │ FF 97 │ 541C      │
│ LLIST  │    9E │ 5229      │  PLAY  │    C1 │ 73E5/791B │
│ LOC    │ FF AC │ 6D03      │  POINT │    ED │ 5803      │
│ LOG    │ FF 8A │ 2A72      │  POKE  │    98 │ 5423      │
│ LOF    │ FF AD │ 6D14      │  POS   │ FF 91 │ 4FCC      │
│ LOAD   │    B5 │ 6B5D      │  PRESET│    C3 │ 57E5      │
│ LOCATE │    D8 │ 7766      │  PRINT │    91 │ 4A24      │
│ LPOS   │ FF 9C │ 4FC7      │  PSET  │    C2 │ 57EA      │
│ LPRINT │    9D │ 4A1D      │        │       │           │
│ LSET   │    B8 │ 7C48      │        │       │           │
├────────┼───────┼───────────┼────────┼───────┼───────────┤
│ READ   │    87 │ 4B9F      │  TAB   │    DB │           │
│ RENUM  │    AA │ 5468      │  TAN   │ FF 8D │ 29FB      │
│ REM    │    8F │ 485D      │  THEN  │    DA │           │
│ RESTORE│    8C │ 633C      │  TIME  │    CB │ 7911/7900 │
│ RESUME │    A7 │ 4950      │  TO    │    D9 │           │
│ RIGHT$ │ FF 82 │ 6891      │  TRON  │    A2 │ 6438      │
│ RETURN │    8E │ 4821      │  TROFF │    A3 │ 6439      │
│ RND    │ FF 88 │ 2BDF      │        │       │           │
│ RSET   │    B9 │ 7C4D      ├────────┼───────┼───────────┤
│ RUN    │    8A │ 479E      │  USING │    E4 │           │
├────────┼───────┼───────────┤  USR   │    DD │ 4FD5      │
│ SCREEN │    C5 │ 79CC      │        │       │           │
│ SET    │    D2 │ 7C1B      ├────────┼───────┼───────────┤
│ SGN    │ FF 84 │ 2E97      │  VAL   │ FF 94 │ 68BB      │
│ SIN    │ FF 89 │ 29AC      │  VARPTR│    E7 │ 4E41      │
│ SAVE   │    BA │ 6BA3      │  VDP   │    C8 │ 7B37/7B47 │
│ SPC    │    DF │           │  VPOKE │    C6 │ 7BE2      │
│ SPACE$ │ FF 99 │ 6848      │  VPEEK │ FF 98 │ 7EF5      │
│ SPRITE │    C7 │ 7A48/7A84 │        │       │           │
│ SOUND  │    C4 │ 73CA      ├────────┼───────┼───────────┤
│ SQR    │ FF 87 │ 2AFF      │  WAIT  │    96 │ 401C      │
│ STEP   │    DC │           │  WIDTH │    A0 │ 51C9      │
│ STICK  │ FF A2 │ 7940      ├────────┼───────┼───────────┤
│ STOP   │    90 │ 63E3      │  XOR   │    F8 │           │
│ STRIG  │ FF A3 │ 794C      │        │       │           │
│ STRING$│    E3 │ 6829      │        │       │           │
│ STR$   │ FF 93 │ 6604      │        │       │           │
│ SWAP   │    A4 │ 643E      │        │       │           │
├────────┼───────┼───────────┼────────┼───────┼───────────┤
│  0     │    11 │           │    '   │    E6 │           │
│  1     │    12 │           │    >   │    EE │           │
│  2     │    13 │           │    =   │    EF │           │
│  3     │    14 │           │    <   │    F0 │           │
│  4     │    15 │           │    +   │    F1 │           │
│  5     │    16 │           │    -   │    F2 │           │
│  6     │    17 │           │    *   │    F3 │           │
│  7     │    18 │           │    /   │    F4 │           │
│  8     │    19 │           │    ^   │    F5 │           │
│  9     │    1A │           │    \   │    FC │           │
│        │       │           │LineFeed│    FD │           │
└────────┴───────┴───────────┴────────┴───────┴───────────┘




                           168  


                          ОГЛАВЛЕНИЕ

ВВЕДЕНИЕ  ..................................................... 3
1. Общие сведения об архитектуре MSX-2  ..................... 4
2. Микропроцессор Z-80  ..................................... 6
   2.1. Основные блоки  ....................................... 7
   2.2. Состав, обозначение и назначение регистров  ........... 8
   2.3. Регистр признаков  .................................... 9
   2.4. Система и форматы команд ............................. 10
   2.5. Способы адресации  ................................... 12
   2.6. Прерывания  .......................................... 14
3. Порты ввода/вывода....................................... 17
4. Организация памяти  ..................................... 17
   4.1. Карта памяти  ........................................ 18
   4.2. Подпрограммы ПЗУ ..................................... 23
   4.3. Хранение программ на языке MSX-BASIC  ................ 24
   4.4. Хранение данных  ..................................... 25
   4.5. Рабочая область и ловушки  ........................... 28
   4.6. Сетевая память  ...................................... 29
5. Видеопроцессор  ......................................... 29
6. Видеопамять  ............................................ 31
7. Форматы дисковой памяти ................................. 36
   7.1. Единицы информации на диске .......................... 36
   7.2. Загрузочный сектор и блок параметров драйвера ........ 38
   7.3. Каталог .............................................. 41
   7.4. Таблица размещения файлов ............................ 43
   7.5. Блок управления файлом ............................... 44
8. Генераторы звука и шумов ................................ 47
9. Часы и энергонезависимая память ......................... 51
10.Интерфейс с кассетным магнитофоном ...................... 55
11.Клавиатура .............................................. 58
12.Интерфейс с принтером ................................... 59
13.Универсальный интерфейс ввода/вывода .................... 61
ЗАКЛЮЧЕНИЕ  .................................................. 62

ЛИТЕРАТУРА  .................................................. 63

                           

ПРИЛОЖЕНИЯ
ПРИЛОЖЕНИЕ 1. Рабочие области BDOS и BIOS .................... 64
ПРИЛОЖЕНИЕ 2. Порты ввода/вывода  ............................ 88
ПРИЛОЖЕНИЕ 3. Подпрограммы MSX-BASIC BIOS  ................... 91
   3.1. Прерывания: интерпретатор, управление слотами,
        аппаратные прерывания ................................ 91
   3.2. Инициализация ввода/вывода ........................... 94
   3.3. Доступ к видеопроцессору TMS 9918 .................... 94
   3.4. Доступ к звукогенератору ............................. 99
   3.5. Доступ к консоли .................................... 100
   3.6. Доступ к игровому вводу/выводу ...................... 103
   3.7. Доступ к кассетной ленте ............................ 105
   3.8. Обработка очередей для оператора PLAY ............... 106
   3.9. Подпрограммы, используемые модулями GENGRP и ADVGPP . 107
   3.10.Дополнительные подпрограммы ......................... 109
   3.11.Точки входа, добавленные в MSX ...................... 112
   3.12.Расширенное ПЗУ ..................................... 113
   3.13.Работа с графическими средствами языка BASIC ........ 114
   3.14.Графика нижнего уровня .............................. 115
   3.15.Доступ к VDP ........................................ 118
   3.16.Доступ к палитре .................................... 123
   3.17.Операторы расширенного MSX-BASIC .................... 124
   3.18.Разные подпрограммы ................................. 125
   3.19.Восстановление экрана ............................... 126
   3.20.Функции передачи данных для видеопамяти ............. 126
   3.21.Работа с манипуляторами ............................. 129
   3.22.Разное .............................................. 130
   3.23.Доступ к микросхеме таймера и энергонезависимой
        памяти .............................................. 130
ПРИЛОЖЕНИЕ 4. Входные точки MSX-BDOS ........................ 132








                          

                          ОГЛАВЛЕНИЕ




ПРИЛОЖЕНИЕ 5. Входные точки интерпретатора языка MSX-BASIC .. 143
ПРИЛОЖЕНИЕ 6. Сетевые функции MSX-DOS BIOS  ................. 147
ПРИЛОЖЕНИЕ 7. Регистры видеопроцессора ...................... 159
ПРИЛОЖЕНИЕ 8. Внутренние коды лексем языка MSX-BASIC ........ 167


